<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Android 系统服务加载启动"/>








  <link rel="alternate" href="/default" title="咔咔咔" >




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://youngkaaa.github.io/d663666b.html"/>


<meta name="description" content="在 Android 的开机启动过程中，会有一步来进行上层 Java Framework 初始化的操作，具体则是从 Zygote 进程fork出system_server 进程之后，在 system_server 进程中最终会通过反射机制，来执行到上层 SystemServer.main() 方法中来完成上层服务的初始化等工作。 下面就主要就 SystemServer 中完成的 Java Frame">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 系统服务加载启动">
<meta property="og:url" content="https://youngkaaa.github.io/d663666b.html">
<meta property="og:site_name" content="咔咔咔">
<meta property="og:description" content="在 Android 的开机启动过程中，会有一步来进行上层 Java Framework 初始化的操作，具体则是从 Zygote 进程fork出system_server 进程之后，在 system_server 进程中最终会通过反射机制，来执行到上层 SystemServer.main() 方法中来完成上层服务的初始化等工作。 下面就主要就 SystemServer 中完成的 Java Frame">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-01-12T13:49:58.000Z">
<meta property="article:modified_time" content="2023-03-11T06:33:10.843Z">
<meta property="article:author" content="咔咔咔">
<meta name="twitter:card" content="summary">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Android 系统服务加载启动 - 咔咔咔 </title>
  <meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">咔咔咔</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Android 系统服务加载启动
        
      </h1>

      <time class="post-time">
          1月 12 2022
      </time>
    </header>



    
            <div class="post-content">
            <p>在 Android 的开机启动过程中，会有一步来进行上层 Java Framework 初始化的操作，具体则是从 Zygote 进程fork出system_server 进程之后，在 system_server 进程中最终会通过反射机制，来执行到上层 SystemServer.main() 方法中来完成上层服务的初始化等工作。</p>
<p>下面就主要就 SystemServer 中完成的 Java Framework 的初始化工作来做分析，侧重于对应系统服务的初始化，比如 WindowManagerService 、ActivityManagerService 等。</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h2 id="main"><a href="#main" class="headerlink" title="main"></a>main</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.SystemServer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 先创建出 SystemServer 实例，再去调用其 run 方法完成真正的初始化逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">SystemServer</span>().run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SystemServer</span><span class="params">()</span> &#123;</span><br><span class="line">    mFactoryTestMode = FactoryTest.getMode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取一些属性来判断当前开机的状态</span></span><br><span class="line">    mStartCount = SystemProperties.getInt(SYSPROP_START_COUNT, <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">    mRuntimeStartElapsedTime = SystemClock.elapsedRealtime();</span><br><span class="line">    mRuntimeStartUptime = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">    mRuntimeRestart = <span class="string">&quot;1&quot;</span>.equals(SystemProperties.get(<span class="string">&quot;sys.boot_completed&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 SystemServer 的 main() 方法中，就做了两件事儿，第一是创建出 SystemServer 实例，此时其无参构造方法被执行，但其实也没做啥工作。第二就是调用该实例的 run() 方法，所以说核心的初始化工作都是在 run() 方法内的。</p>
<p>在此需要提前说明的是：后续的逻辑都是运行在 system_server 进程中的，包括创建 Looper 、ActivityThread 等逻辑，虽然你可能很熟悉这些类，但是他们此时并非是在你熟悉的那个对应应用进程环境中的。</p>
<h2 id="run"><a href="#run" class="headerlink" title="run"></a>run</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.SystemServer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;InitBeforeStartServices&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 本次开机属性保存</span></span><br><span class="line">        SystemProperties.set(SYSPROP_START_COUNT, String.valueOf(mStartCount));</span><br><span class="line">        SystemProperties.set(SYSPROP_START_ELAPSED, String.valueOf(mRuntimeStartElapsedTime));</span><br><span class="line">        SystemProperties.set(SYSPROP_START_UPTIME, String.valueOf(mRuntimeStartUptime));</span><br><span class="line"></span><br><span class="line">        EventLog.writeEvent(EventLogTags.SYSTEM_SERVER_START,</span><br><span class="line">                mStartCount, mRuntimeStartUptime, mRuntimeStartElapsedTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果当前系统时间比 1970 还要早，那么就将其纠正为 1970</span></span><br><span class="line">        <span class="comment">// 不然会导致好多 api 执行出现问题</span></span><br><span class="line">        <span class="keyword">if</span> (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;System clock is before 1970; setting to 1970.&quot;</span>);</span><br><span class="line">            SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置时区</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">timezoneProperty</span> <span class="operator">=</span> SystemProperties.get(<span class="string">&quot;persist.sys.timezone&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (timezoneProperty == <span class="literal">null</span> || timezoneProperty.isEmpty()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Timezone not set; setting to GMT.&quot;</span>);</span><br><span class="line">            SystemProperties.set(<span class="string">&quot;persist.sys.timezone&quot;</span>, <span class="string">&quot;GMT&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对 persist.sys.language 中值做替换</span></span><br><span class="line">        <span class="keyword">if</span> (!SystemProperties.get(<span class="string">&quot;persist.sys.language&quot;</span>).isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">languageTag</span> <span class="operator">=</span> Locale.getDefault().toLanguageTag();</span><br><span class="line"></span><br><span class="line">            SystemProperties.set(<span class="string">&quot;persist.sys.locale&quot;</span>, languageTag);</span><br><span class="line">            SystemProperties.set(<span class="string">&quot;persist.sys.language&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            SystemProperties.set(<span class="string">&quot;persist.sys.country&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            SystemProperties.set(<span class="string">&quot;persist.sys.localevar&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Binder.setWarnOnBlocking(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        PackageItemInfo.forceSafeLabels();</span><br><span class="line"></span><br><span class="line">        SQLiteGlobal.sDefaultSyncMode = SQLiteGlobal.SYNC_MODE_FULL;</span><br><span class="line"></span><br><span class="line">        SQLiteCompatibilityWalFlags.init(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">uptimeMillis</span> <span class="operator">=</span> (<span class="type">int</span>) SystemClock.elapsedRealtime();</span><br><span class="line">        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, uptimeMillis);</span><br><span class="line">        <span class="keyword">if</span> (!mRuntimeRestart) &#123;</span><br><span class="line">            MetricsLogger.histogram(<span class="literal">null</span>, <span class="string">&quot;boot_system_server_init&quot;</span>, uptimeMillis);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SystemProperties.set(<span class="string">&quot;persist.sys.dalvik.vm.lib.2&quot;</span>, VMRuntime.getRuntime().vmLibrary());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 申请更多内存，清除掉 VM 内存增长上限，后续会可能需要较多内存</span></span><br><span class="line">        VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class="line"></span><br><span class="line">        VMRuntime.getRuntime().setTargetHeapUtilization(<span class="number">0.8f</span>);</span><br><span class="line"></span><br><span class="line">        Build.ensureFingerprintProperty();</span><br><span class="line"></span><br><span class="line">        Environment.setUserRequired(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        BaseBundle.setShouldDefuse(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        Parcel.setStackTraceParceling(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        BinderInternal.disableBackgroundScheduling(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        BinderInternal.setMaxThreads(sMaxBinderThreads);</span><br><span class="line"></span><br><span class="line">        android.os.Process.setThreadPriority(</span><br><span class="line">                android.os.Process.THREAD_PRIORITY_FOREGROUND);</span><br><span class="line">        android.os.Process.setCanSelfBackground(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 初始化主线程 Looper 实例，使其可以在当前线程来执行</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line">        Looper.getMainLooper().setSlowLogThresholdMs(</span><br><span class="line">                SLOW_DISPATCH_THRESHOLD_MS, SLOW_DELIVERY_THRESHOLD_MS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载 android_servers.so 库</span></span><br><span class="line">        System.loadLibrary(<span class="string">&quot;android_servers&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Build.IS_DEBUGGABLE) &#123;</span><br><span class="line">            initZygoteChildHeapProfiling();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        performPendingShutdown();</span><br><span class="line"></span><br><span class="line">        createSystemContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建 SystemServiceManager 对象实例</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mSystemServiceManager = <span class="keyword">new</span> <span class="title class_">SystemServiceManager</span>(mSystemContext);</span><br><span class="line">        mSystemServiceManager.setStartInfo(mRuntimeRestart,</span><br><span class="line">                mRuntimeStartElapsedTime, mRuntimeStartUptime);</span><br><span class="line">        <span class="comment">// 将创建出来的 mSystemServiceManager 暂存到 LocalServices 中</span></span><br><span class="line">        LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line"></span><br><span class="line">        SystemServerInitThreadPool.get();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        traceEnd();  <span class="comment">// InitBeforeStartServices</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始系统服务的启动</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartServices&quot;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 1、启动 ActivityManagerService、PackageManagerService等</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        startBootstrapServices();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 2、启动 BatteryService 等</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        startCoreServices();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 3、启动 WindowManagerService、InputManagerService 等</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        startOtherServices();</span><br><span class="line">        SystemServerInitThreadPool.shutdown();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;******************************************&quot;</span>);</span><br><span class="line">        Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;************ Failure starting system services&quot;</span>, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        traceEnd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    StrictMode.initVmDefaults(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mRuntimeRestart &amp;&amp; !isFirstBootOrUpgrade()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">uptimeMillis</span> <span class="operator">=</span> (<span class="type">int</span>) SystemClock.elapsedRealtime();</span><br><span class="line">        MetricsLogger.histogram(<span class="literal">null</span>, <span class="string">&quot;boot_system_server_ready&quot;</span>, uptimeMillis);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_UPTIME_MILLIS</span> <span class="operator">=</span> <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">if</span> (uptimeMillis &gt; MAX_UPTIME_MILLIS) &#123;</span><br><span class="line">            Slog.wtf(SYSTEM_SERVER_TIMING_TAG,</span><br><span class="line">                    <span class="string">&quot;SystemServer init took too long. uptimeMillis=&quot;</span> + uptimeMillis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!VMRuntime.hasBootImageSpaces()) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">&quot;Runtime is not running with a boot image!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主线程开始执行，后续会一直开始执行 loop ，保证当前方法不会被执行完毕</span></span><br><span class="line">    Looper.loop();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码比较多，分步开始讲：</p>
<p>① 首先就是完成一些初始属性的设置保存、进而完成一些检查工作，以及为后续启动服务做的准备工作。</p>
<p>② 创建 SystemServiceManager ，以及调用三个 startXXXX() 方法来启动对应的系统服务</p>
<p>③ 完成收尾工作，最后使用 Looper.loop 方法来保持当前方法不会被执行完毕从而线程结束，导致system_server进程执行完毕。</p>
<p>这里的最主要的就是第②步，也就是本文侧重要介绍的。所以下面主要分析第②步中的逻辑</p>
<p>首先是创建出 SystemServiceManager 实例，接着将其保存到 LocalServices 中。</p>
<p>先看看 SystemServiceManager  的创建，对于 SystemServiceManager 的创建最重要的是它的入参 mSystemContext 是怎么来的？即通过前面的 createSystemContext() 方法创建的：</p>
<h3 id="createSystemContext"><a href="#createSystemContext" class="headerlink" title="createSystemContext"></a>createSystemContext</h3><p>先看看相关源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.SystemServer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createSystemContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 在当前进程中创建一个 ActivityThread 实例</span></span><br><span class="line">    <span class="type">ActivityThread</span> <span class="variable">activityThread</span> <span class="operator">=</span> ActivityThread.systemMain();</span><br><span class="line">    <span class="comment">// 通过 ActivityThread 实例来创建一个 ContextImpl 实例</span></span><br><span class="line">    mSystemContext = activityThread.getSystemContext();</span><br><span class="line">    mSystemContext.setTheme(DEFAULT_SYSTEM_THEME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">systemUiContext</span> <span class="operator">=</span> activityThread.getSystemUiContext();</span><br><span class="line">    systemUiContext.setTheme(DEFAULT_SYSTEM_THEME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android.app.ActivityThread.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ActivityThread <span class="title function_">systemMain</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!ActivityManager.isHighEndGfx()) &#123;</span><br><span class="line">        ThreadedRenderer.disable(<span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ThreadedRenderer.enableForegroundTrimming();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 先创建一个 ActivityThread 实例，再调用其 attach 方法来初始化其内部逻辑</span></span><br><span class="line">    <span class="type">ActivityThread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActivityThread</span>();</span><br><span class="line">    thread.attach(<span class="literal">true</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> thread;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ContextImpl <span class="title function_">getSystemContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建一个 ContextImpl 实例</span></span><br><span class="line">        <span class="keyword">if</span> (mSystemContext == <span class="literal">null</span>) &#123;</span><br><span class="line">            mSystemContext = ContextImpl.createSystemContext(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mSystemContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先会在当前 system_server 进程中创建一个 ActivityThread 实例，接着调用其 attach() 方法来通知其当前已绑定成功，这个 attach() 方法如果你熟悉 Activity 启动流程的话，就肯定见到过，注意这里传入的第一个参数是 true ，表示当前 ActivityThread  实例是在 system_server  进程中使用的，而不是常规的应用进程中，所以内部会跳过大部分的逻辑。</p>
<p>接着会调用其 getSystemContext() 方法来创建一个 ContextImpl 实例来给当前进程使用。关于 ContextImpl ，以及上面讲到的 ActivityThread  ，这些在后续的 Activity 启动流程分析中（前提是我后面有空写 o(╯□╰)o ）会遇到的。</p>
<p>回到 SystemServer 中，创建 SystemServiceManager  时就会将这个 ContextImpl 实例传入进去，其内部只是做了个保存而已没有其他额外逻辑，接着我们需要补充讲一下  SystemServiceManager 中比较重要的 startService() 方法：</p>
<h3 id="SystemServiceManager"><a href="#SystemServiceManager" class="headerlink" title="SystemServiceManager"></a>SystemServiceManager</h3><p>先看看相关源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.SystemServiceManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;SystemService&gt; mServices = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SystemService&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> SystemService <span class="title function_">startService</span><span class="params">(String className)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;SystemService&gt; serviceClass;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 反射拿到该类的 Class 对象</span></span><br><span class="line">        serviceClass = (Class&lt;SystemService&gt;)Class.forName(className);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">&quot;Starting &quot;</span> + className);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to create service &quot;</span> + className</span><br><span class="line">                + <span class="string">&quot;: service class not found, usually indicates that the caller should &quot;</span></span><br><span class="line">                + <span class="string">&quot;have called PackageManager.hasSystemFeature() to check whether the &quot;</span></span><br><span class="line">                + <span class="string">&quot;feature is available on this device before trying to start the &quot;</span></span><br><span class="line">                + <span class="string">&quot;services that implement it&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 成功拿到其 Class 实例之后执行下一步</span></span><br><span class="line">    <span class="keyword">return</span> startService(serviceClass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">SystemService</span>&gt; T <span class="title function_">startService</span><span class="params">(Class&lt;T&gt; serviceClass)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> serviceClass.getName();</span><br><span class="line">        Slog.i(TAG, <span class="string">&quot;Starting &quot;</span> + name);</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">&quot;StartService &quot;</span> + name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 要启动的服务必须是继承自 com.android.server.SystemService 的</span></span><br><span class="line">        <span class="keyword">if</span> (!SystemService.class.isAssignableFrom(serviceClass)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to create &quot;</span> + name</span><br><span class="line">                    + <span class="string">&quot;: service must extend &quot;</span> + SystemService.class.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> T service;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 反射调用其只有一个 Context 的构造方法，来创建该 Service 对象实例</span></span><br><span class="line">            Constructor&lt;T&gt; constructor = serviceClass.getConstructor(Context.class);</span><br><span class="line">            service = constructor.newInstance(mContext);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to create service &quot;</span> + name</span><br><span class="line">                    + <span class="string">&quot;: service could not be instantiated&quot;</span>, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to create service &quot;</span> + name</span><br><span class="line">                    + <span class="string">&quot;: service must have a public constructor with a Context argument&quot;</span>, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to create service &quot;</span> + name</span><br><span class="line">                    + <span class="string">&quot;: service must have a public constructor with a Context argument&quot;</span>, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to create service &quot;</span> + name</span><br><span class="line">                    + <span class="string">&quot;: service constructor threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 成功创建出该 Service 的实例了，那么接着往后走</span></span><br><span class="line">        startService(service);</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startService</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> SystemService service)</span> &#123;</span><br><span class="line">    <span class="comment">// 将当前创建出来的 Service 实例保存到 mServices 中</span></span><br><span class="line">    mServices.add(service);</span><br><span class="line">    <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 调用其 onStart 方法来启动它</span></span><br><span class="line">        service.onStart();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to start service &quot;</span> + service.getClass().getName()</span><br><span class="line">                + <span class="string">&quot;: onStart threw an exception&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    warnIfTooLong(SystemClock.elapsedRealtime() - time, service, <span class="string">&quot;onStart&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前面创建出了 SystemServiceManager 实例，那么后续就可以调用其内部的 startService() 方法来启动对应的服务了，我们从 startService() 方法路径最长的那个重载方法开始看，它接受要启动的 Service 的全路径名，内部通过反射拿到其对应的 Class 实例，接着反射调用其只有一个参数 Context 的构造方法，来将前面通过 createSystemContext() 方法创建出来的 ContextImpl 实例传入进去，进而创建出该 Service 的实例。当然在创建其实例之前，还会检查该 Service 是否是继承自 com.android.server.SystemService 的，是的话才会去创建实例，否则抛出异常，所以说这个 com.android.server.SystemService 就是本文后续要介绍的那些 Service 的父类了，关于 SystemService   的分析等下再说。</p>
<p>这里拿到了要启动 Service 的实例之后接着往后会先将该 Service 实例保存到 SystemServiceManager 中的 mServices 集合中去，接着会去调用其 onStart() 方法来启动该服务。</p>
<h3 id="SystemService"><a href="#SystemService" class="headerlink" title="SystemService"></a>SystemService</h3><p>我们先简单看看它的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.SystemService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SystemService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略一些常量定义</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SystemService</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Context <span class="title function_">getContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Context <span class="title function_">getUiContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ActivityThread.currentActivityThread().getSystemUiContext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽象方法，留给子类去实现</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 将指定服务注册给 SM </span></span><br><span class="line">  	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">publishBinderService</span><span class="params">(String name, IBinder service)</span> &#123;</span><br><span class="line">        publishBinderService(name, service, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">publishBinderService</span><span class="params">(String name, IBinder service,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> allowIsolated)</span> &#123;</span><br><span class="line">        publishBinderService(name, service, allowIsolated, DUMP_FLAG_PRIORITY_DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">publishBinderService</span><span class="params">(String name, IBinder service,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> allowIsolated, <span class="type">int</span> dumpPriority)</span> &#123;</span><br><span class="line">        ServiceManager.addService(name, service, allowIsolated, dumpPriority);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 SM 中获取指定的Service</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> IBinder <span class="title function_">getBinderService</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceManager.getService(name);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 省略其他方法定义</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到它内部会将构造方法传入的 ContextImpl 保存起来，同时它内部还会存在一个抽象的 onStart() 来留给子类去实现。</p>
<p>同时我们看到它内部还存在 publishBinderService() 方法，该方法是用来将对应的 服务实例 注册到 Binder Service Manager 中的，注册到 SM 中之后，后续就可以在别的进程，比如你开发的APP进程中去获取了。</p>
<p>在 publishBinderService() 方法中，会调用 ServiceManager.addService() 方法来完成服务注册逻辑的，接着执行到到 native 中去完成 BBinder  的创建工作。关于 Binder 的学习，可以去看：<a href="2af50710.html">Binder - Java Framework</a> 中的分析，当然建议你最好去看完 Binder 的全系列文章，才能真正理解它。所以这里 ServiceManager.addService() 方法就跳过不讲了哦。</p>
<h3 id="LocalServices"><a href="#LocalServices" class="headerlink" title="LocalServices"></a>LocalServices</h3><p>先看看它的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.LocalServices.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LocalServices</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LocalServices</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部存在一个 Map ，Key是 Class ，Value 是对应的对象实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ArrayMap&lt;Class&lt;?&gt;, Object&gt; sLocalServiceObjects =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayMap</span>&lt;Class&lt;?&gt;, Object&gt;();</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过 key = Class 来查找之前保存的对应的对象实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getService</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sLocalServiceObjects) &#123;</span><br><span class="line">            <span class="keyword">return</span> (T) sLocalServiceObjects.get(type);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存一对属性值，以供后续查找使用</span></span><br><span class="line"><span class="comment">     * 当然一个 Class 只能存在一个实例，第二个就会报错</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">addService</span><span class="params">(Class&lt;T&gt; type, T service)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sLocalServiceObjects) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sLocalServiceObjects.containsKey(type)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Overriding service registration&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sLocalServiceObjects.put(type, service);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 忽略吧，测试用的</span></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">removeServiceForTest</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sLocalServiceObjects) &#123;</span><br><span class="line">            sLocalServiceObjects.remove(type);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看完源码是不是对 LocalServices 一下就懂了，内部就只是封装了一个 Map 用来存储 Service 启动过程中创建的那个 Service 实例，Key就是其实例对应的 Class 。这里做了个额外的判断，就是同一个Service不能存在两个实例。</p>
<p>为啥要有这个类的存在呢？因为在后续的 Service 创建启动的过程中，会存在有些 Service 的创建和启动会依赖于其他的Service ，比如在后续某个 Service 实例中执行内部逻辑时，需要另外一个 Service 实例来支持。</p>
<p>使用 LocalServices 你可以每创建一个 Service 实例，然后调用其 addService() 存起来，然后等到后续要使用某个服务时只需要去调用其 getService() 去查找就行了，能查找到那么该 Service 实例肯定之前被创建过不为空。相当于是全局缓存了。由于当前是在  system_server 进程中中执行的，所以 LocalServices 中保存的那些 Service 实例也就只能给在 system_server 进程中运行的其他服务来使用，而另外其他进程的，你只能是通过 Binder 去 ServiceManager 中查找再访问使用了。</p>
<p>所以这里调用 LocalServices.addService() 方法来将创建出来的 SystemServiceManager  实例暂存起来了就是为了方便后续使用的。</p>
<p>所以接着往后看启动其他服务的逻辑。具体是按照顺序去执行：startBootstrapServices() 、startCoreServices() 和 startOtherServices() 服务。从其方法命名，以及调用顺序可知，越重要的服务越先启动的。</p>
<h3 id="startBootstrapServices"><a href="#startBootstrapServices" class="headerlink" title="startBootstrapServices"></a>startBootstrapServices</h3><p>先看其主要的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.SystemServer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startBootstrapServices</span><span class="params">()</span> &#123;</span><br><span class="line">    </span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartWatchdog&quot;</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Watchdog</span> <span class="variable">watchdog</span> <span class="operator">=</span> Watchdog.getInstance();</span><br><span class="line">    watchdog.start();</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    Slog.i(TAG, <span class="string">&quot;Reading configuration...&quot;</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG_SYSTEM_CONFIG</span> <span class="operator">=</span> <span class="string">&quot;ReadingSystemConfig&quot;</span>;</span><br><span class="line">    traceBeginAndSlog(TAG_SYSTEM_CONFIG);</span><br><span class="line">    SystemServerInitThreadPool.get().submit(SystemConfig::getInstance, TAG_SYSTEM_CONFIG);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartInstaller&quot;</span>);</span><br><span class="line">    <span class="comment">// 使用 SystemServiceManager 去创建 Installer 服务</span></span><br><span class="line">    <span class="type">Installer</span> <span class="variable">installer</span> <span class="operator">=</span> mSystemServiceManager.startService(Installer.class);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;DeviceIdentifiersPolicyService&quot;</span>);</span><br><span class="line">    <span class="comment">// 使用 SystemServiceManager 去创建 DeviceIdentifiersPolicyService 服务</span></span><br><span class="line">    mSystemServiceManager.startService(DeviceIdentifiersPolicyService.class);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;UriGrantsManagerService&quot;</span>);</span><br><span class="line">    <span class="comment">// 使用 SystemServiceManager 去创建 UriGrantsManagerService 服务</span></span><br><span class="line">    mSystemServiceManager.startService(UriGrantsManagerService.Lifecycle.class);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartActivityManager&quot;</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 先创建 ActivityTaskManagerService 并且调用其 onStart 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">ActivityTaskManagerService</span> <span class="variable">atm</span> <span class="operator">=</span> mSystemServiceManager.startService(</span><br><span class="line">            ActivityTaskManagerService.Lifecycle.class).getService();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用 ActivityManagerService.Lifecycle 的 startService 方法来创建 ActivityManagerService 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mActivityManagerService = ActivityManagerService.Lifecycle.startService(</span><br><span class="line">            mSystemServiceManager, atm);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将 SystemServiceManager 保存到  ActivityManagerService 中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">    mActivityManagerService.setInstaller(installer);</span><br><span class="line"></span><br><span class="line">    mWindowManagerGlobalLock = atm.getGlobalLock();</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略其他代码</span></span><br><span class="line">    </span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartPackageManagerService&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建启动 PackageManagerService ： 并保存到全局的 mPackageManagerService</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Watchdog.getInstance().pauseWatchingCurrentThread(<span class="string">&quot;packagemanagermain&quot;</span>);</span><br><span class="line">        mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">                mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Watchdog.getInstance().resumeWatchingCurrentThread(<span class="string">&quot;packagemanagermain&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line">    mPackageManager = mSystemContext.getPackageManager();</span><br><span class="line">    traceEnd();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 省略其他代码</span></span><br><span class="line">  </span><br><span class="line"> 		traceBeginAndSlog(<span class="string">&quot;SetSystemProcess&quot;</span>);</span><br><span class="line">    <span class="comment">// 现在才调用 ActivityManagerService 的  setSystemProcess() 方法</span></span><br><span class="line">  	mActivityManagerService.setSystemProcess();</span><br><span class="line">  	traceEnd();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 startBootstrapServices() 方法中会通过前面创建出来的 SystemServiceManager 实例来创建并启动很多个系统服务，比如 Installer 等，这里我们只列举其中几个常见的，比如 ActivityTaskManagerService 、ActivityManagerService、PackageManagerService 。</p>
<h4 id="ActivityTaskManagerService"><a href="#ActivityTaskManagerService" class="headerlink" title="ActivityTaskManagerService"></a>ActivityTaskManagerService</h4><p>对于 ActivityTaskManagerService 的创建，是通过 SystemServiceManager.startService() 方法，传入 ActivityTaskManagerService.Lifecycle.class 来完成的，也就是说会先创建出 ActivityTaskManagerService.Lifecycle 实例，然后调用其 onStart() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.wm.ActivityTaskManagerService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Lifecycle</span> <span class="keyword">extends</span> <span class="title class_">SystemService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActivityTaskManagerService mService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Lifecycle</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">        <span class="comment">// 创建 ActivityTaskManagerService 实例</span></span><br><span class="line">        mService = <span class="keyword">new</span> <span class="title class_">ActivityTaskManagerService</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 调用 publishBinderService 来将该服务注册到 SM 中，服务名为：activity_task</span></span><br><span class="line">        publishBinderService(Context.ACTIVITY_TASK_SERVICE, mService);</span><br><span class="line">        <span class="comment">// 然后调用 ActivityTaskManagerService 的 start 方法</span></span><br><span class="line">        mService.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUnlockUser</span><span class="params">(<span class="type">int</span> userId)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mService.getGlobalLock()) &#123;</span><br><span class="line">            mService.mStackSupervisor.onUserUnlocked(userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCleanupUser</span><span class="params">(<span class="type">int</span> userId)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mService.getGlobalLock()) &#123;</span><br><span class="line">            mService.mStackSupervisor.mLaunchParamsPersister.onCleanupUser(userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ActivityTaskManagerService <span class="title function_">getService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 将当前 ActivityTaskManagerService 中的 mInternal ，也就是将 LocalService 实例保存到 LocalServices 中</span></span><br><span class="line">    LocalServices.addService(ActivityTaskManagerInternal.class, mInternal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 ActivityTaskManagerService 中，它并没有直接继承自 SystemService ，而是定义了一个内部类 Lifecycle 来完成继承工作，在 Lifecycle 的构造方法中，会去创建 ActivityTaskManagerService 实例，接着它的 onStart()  方法被调用，在其 onStart() 方法中共做了两件事儿：</p>
<p>第一件事儿就是将 ActivityTaskManagerService  服务注册给 Binder ServiceManager 中去，这样的话后续在别的进程，比如你的 App 所对应的进程中就可以通过 ServiceManager 来查找拿到该 ActivityTaskManagerService 服务对应的代理实例进而操作 ActivityTaskManagerService 实例了。</p>
<p>第二件事儿就是调用 ActivityTaskManagerService   的 start() 方法来启动该服务，当然启动很简单，就是将其内部 LocalService 类型的实例 mInternal 保存到 LocalServices 中去，这样的话，后续在当前 system_server 进程中运行的其他服务，想要操作该 ActivityTaskManagerService    时就可以通过 key &#x3D; ActivityTaskManagerInternal.class 去查找到它了。</p>
<p>关于 mInternal  的初始化是在 ActivityTaskManagerService    构造方法中的，它是ActivityTaskManagerService中的一个内部类 LocalServices  的实例，比较简单，这里就不讲它了。</p>
<p>最后回到 startBootstrapServices() 方法中，会同时调用该 ActivityTaskManagerService.Lifecycle 中的 getService() 方法来拿到其内部刚创建好的那个 ActivityTaskManagerService 实例。</p>
<p>至此，ActivityTaskManagerService 被创建完成，并且它已被注册到 ServiceManager 中，同时保存到了 LocalServices 中了。</p>
<p>####ActivityManagerService</p>
<p>这里是直接调用的 ActivityManagerService.Lifecycle 中的静态方法：startService() 来完成 ActivityManagerService 的创建启动工作的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.wm.ActivityManagerService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Lifecycle</span> <span class="keyword">extends</span> <span class="title class_">SystemService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ActivityTaskManagerService 实例，通过 startService 传入进来</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ActivityTaskManagerService sAtm;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Lifecycle</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 下面的 startService 方法是静态的，其中会先给 sAtm 赋值，然后再创建 Lifecycle 实例，此时 sAtm 不为空</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mService = <span class="keyword">new</span> <span class="title class_">ActivityManagerService</span>(context, sAtm);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ActivityManagerService <span class="title function_">startService</span><span class="params">(</span></span><br><span class="line"><span class="params">            SystemServiceManager ssm, ActivityTaskManagerService atm)</span> &#123;</span><br><span class="line">        <span class="comment">// 先将外部传入的 ActivityTaskManagerService 实例保存起来</span></span><br><span class="line">        sAtm = atm;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 还是调用 SystemServiceManager 的 startService 方法来创建和启动 ActivityManagerService 实例</span></span><br><span class="line"><span class="comment">         * 该方法中会反射创建 ActivityManagerService.Lifecycle 实例，并且调用其 onStart 方法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> ssm.startService(ActivityManagerService.Lifecycle.class).getService();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 执行 start 方法，mService 是 ActivityManagerService 实例，在构造方法中被初始化</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mService.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ActivityManagerService <span class="title function_">getService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    removeAllProcessGroups();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 ActivityManagerService 构造方法中被初始化的</span></span><br><span class="line">    mProcessCpuThread.start();</span><br><span class="line">    mBatteryStatsService.publish();</span><br><span class="line">    mAppOpsService.publish(mContext);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 还是将当前类中的 LocalService 添加到 LocalServices 中，key 是 ActivityManagerInternal</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    LocalServices.addService(ActivityManagerInternal.class, <span class="keyword">new</span> <span class="title class_">LocalService</span>());</span><br><span class="line">    mActivityTaskManager.onActivityManagerInternalAdded();</span><br><span class="line">    mUgmInternal.onActivityManagerInternalAdded();</span><br><span class="line">    mPendingIntentController.onActivityManagerInternalAdded();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mProcessCpuInitLatch.await();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">&quot;Interrupted wait during start&quot;</span>, e);</span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Interrupted wait during start&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单理一下调用顺序：</p>
<p>① 调用 ActivityManagerService.Lifecycle 中的静态方法 startService()。其会先将入参 ActivityTaskManagerService  实例保存起来，然后调用入参 SystemServiceManager 的 startService 方法来完成 ActivityManagerService.Lifecycle 的创建，以及其 onStart() 方法的调用</p>
<p>② ActivityManagerService.Lifecycle 的构造方法先被执行，此时会创建好 ActivityManagerService 实例。此时在创建 ActivityManagerService  时使用到了前面保存的 ActivityTaskManagerService   实例，其内部会将他保存到内部的 mActivityTaskManager 属性中供后续使用。</p>
<p>③ ActivityManagerService.Lifecycle 的 onStart() 方法被执行，此时回调用 ActivityManagerService 实例的 start() 方法来启动它。</p>
<p>④ ActivityManagerService 中的 start() 方法内还是会将其内部的 LocalService() 实例保存到 LocalServices 中，供后续 system_server 进程中运行的其他服务使用。</p>
<p>注意这里并没有调用 publishBinderService() 方法来将当前 ActivityManagerService  服务注册到 ServiceManager 中去，确实，那它什么时候注册呢？或者说难道它不需要注册吗？答案后面说。</p>
<p>另外，这里创建 ActivityManagerService 时，使用到了 ActivityTaskManagerService 实例。他俩是什么关系呢？其实 ActivityTaskManagerService 是 Android 10 中开始增加的服务类，它承担了 ActivityManagerService 中的部分工作，如activities、task, stacks, displays等相关逻辑。比如将 Activity 的启动相关的流程调用转移到了 ActivityTaskManagerService  中。相当于 ActivityTaskManagerService 是 ActivityManagerService 的小弟，给他分担工作的，所以创建 ActivityManagerService 时就得需要先创建好 ActivityTaskManagerService。</p>
<h4 id="PackageManagerService"><a href="#PackageManagerService" class="headerlink" title="PackageManagerService"></a>PackageManagerService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.pm.PackageManagerService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title function_">main</span><span class="params">(Context context, Installer installer,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> factoryTest, <span class="type">boolean</span> onlyCore)</span> &#123;</span><br><span class="line">        <span class="comment">// Self-check for initial settings.</span></span><br><span class="line">        PackageManagerServiceCompilerMapping.checkProperties();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建 PackageManagerService 实例</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">PackageManagerService</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageManagerService</span>(context, installer,</span><br><span class="line">                factoryTest, onlyCore);</span><br><span class="line">        m.enableSystemUserPackages();</span><br><span class="line">        <span class="comment">// 注册 PackageManagerService 服务</span></span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;package&quot;</span>, m);</span><br><span class="line">        <span class="comment">// 创建 PackageManagerNative 实例，并注册它</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">PackageManagerNative</span> <span class="variable">pmn</span> <span class="operator">=</span> m.<span class="keyword">new</span> <span class="title class_">PackageManagerNative</span>();</span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;package_native&quot;</span>, pmn);</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你有了解过 Android 安装等逻辑的话，就会对 PackageManagerService 有印象。它的作用是处理Apk解析，包括其安装，以及系统已安装Apk 的扫描等。</p>
<p>而这里初始化它并没有使用 SystemServiceManager ，而是直接调用它的 main() 方法，内部会创建出 PackageManagerService 和 PackageManagerNative 实例，并且将这俩注册到 ServiceManager 中去，对应的key分别是：package 和 package_native 。</p>
<p>关于这俩实例的介绍这里就不做展开，等后续如果有机会看 PackageManagerService 源码时再做分析吧。</p>
<p>到现在，startBootstrapServices() 方法中的几个服务的创建启动就完成了，在该方法最后还会调用：mActivityManagerService.setSystemProcess() 方法，这里看看它是做什么的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.wm.ActivityManagerService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSystemProcess</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 将当前 ActivityManagerService 实例注册到 SM 中</span></span><br><span class="line">        ServiceManager.addService(Context.ACTIVITY_SERVICE, <span class="built_in">this</span>, <span class="comment">/* allowIsolated= */</span> <span class="literal">true</span>,</span><br><span class="line">                DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PRIORITY_NORMAL | DUMP_FLAG_PROTO);</span><br><span class="line">        <span class="comment">// 注册其内部的 ProcessStatsService 服务</span></span><br><span class="line">        ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats);</span><br><span class="line">        <span class="comment">// 以下完成其他服务的注册</span></span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;meminfo&quot;</span>, <span class="keyword">new</span> <span class="title class_">MemBinder</span>(<span class="built_in">this</span>), <span class="comment">/* allowIsolated= */</span> <span class="literal">false</span>,</span><br><span class="line">                DUMP_FLAG_PRIORITY_HIGH);</span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;gfxinfo&quot;</span>, <span class="keyword">new</span> <span class="title class_">GraphicsBinder</span>(<span class="built_in">this</span>));</span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;dbinfo&quot;</span>, <span class="keyword">new</span> <span class="title class_">DbBinder</span>(<span class="built_in">this</span>));</span><br><span class="line">        <span class="keyword">if</span> (MONITOR_CPU_USAGE) &#123;</span><br><span class="line">            ServiceManager.addService(<span class="string">&quot;cpuinfo&quot;</span>, <span class="keyword">new</span> <span class="title class_">CpuBinder</span>(<span class="built_in">this</span>),</span><br><span class="line">                    <span class="comment">/* allowIsolated= */</span> <span class="literal">false</span>, DUMP_FLAG_PRIORITY_CRITICAL);</span><br><span class="line">        &#125;</span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;permission&quot;</span>, <span class="keyword">new</span> <span class="title class_">PermissionController</span>(<span class="built_in">this</span>));</span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;processinfo&quot;</span>, <span class="keyword">new</span> <span class="title class_">ProcessInfoService</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">ApplicationInfo</span> <span class="variable">info</span> <span class="operator">=</span> mContext.getPackageManager().getApplicationInfo(</span><br><span class="line">                <span class="string">&quot;android&quot;</span>, STOCK_PM_FLAGS | MATCH_SYSTEM_ONLY);</span><br><span class="line">        mSystemThread.installSystemApplicationInfo(info, getClass().getClassLoader());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="type">ProcessRecord</span> <span class="variable">app</span> <span class="operator">=</span> mProcessList.newProcessRecordLocked(info, info.processName,</span><br><span class="line">                    <span class="literal">false</span>,</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">HostingRecord</span>(<span class="string">&quot;system&quot;</span>));</span><br><span class="line">            app.setPersistent(<span class="literal">true</span>);</span><br><span class="line">            app.pid = MY_PID;</span><br><span class="line">            app.getWindowProcessController().setPid(MY_PID);</span><br><span class="line">            app.maxAdj = ProcessList.SYSTEM_ADJ;</span><br><span class="line">            app.makeActive(mSystemThread.getApplicationThread(), mProcessStats);</span><br><span class="line">            mPidsSelfLocked.put(app);</span><br><span class="line">            mProcessList.updateLruProcessLocked(app, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            updateOomAdjLocked(OomAdjuster.OOM_ADJ_REASON_NONE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                <span class="string">&quot;Unable to find android system package&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>奥奥原来是在这里完成 ActivityManagerService 的注册的，这里不仅注册了 ActivityManagerService ，还注册了一系列其他的 Binder 服务。</p>
<p>至此，就完成了 startBootstrapServices() 方法的执行。</p>
<h3 id="startCoreServices"><a href="#startCoreServices" class="headerlink" title="startCoreServices"></a>startCoreServices</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.SystemServer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startCoreServices</span><span class="params">()</span> &#123;</span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartBatteryService&quot;</span>);</span><br><span class="line">    <span class="comment">// 启动 BatteryService 服务</span></span><br><span class="line">    mSystemServiceManager.startService(BatteryService.class);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartUsageService&quot;</span>);</span><br><span class="line">    <span class="comment">// 启动 UsageStatsService</span></span><br><span class="line">    mSystemServiceManager.startService(UsageStatsService.class);</span><br><span class="line">    <span class="comment">// 将创建启动好的 UsageStatsService 服务保存到 ActivityManagerService 中</span></span><br><span class="line">    mActivityManagerService.setUsageStatsManager(</span><br><span class="line">            LocalServices.getService(UsageStatsManagerInternal.class));</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否需要启动 WebViewUpdateService 服务</span></span><br><span class="line">    <span class="keyword">if</span> (mPackageManager.hasSystemFeature(PackageManager.FEATURE_WEBVIEW)) &#123;</span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartWebViewUpdateService&quot;</span>);</span><br><span class="line">        mWebViewUpdateService = mSystemServiceManager.startService(WebViewUpdateService.class);</span><br><span class="line">        traceEnd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartCachedDeviceStateService&quot;</span>);</span><br><span class="line">    mSystemServiceManager.startService(CachedDeviceStateService.class);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartBinderCallsStatsService&quot;</span>);</span><br><span class="line">    mSystemServiceManager.startService(BinderCallsStatsService.LifeCycle.class);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartLooperStatsService&quot;</span>);</span><br><span class="line">    mSystemServiceManager.startService(LooperStatsService.Lifecycle.class);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartRollbackManagerService&quot;</span>);</span><br><span class="line">    mSystemServiceManager.startService(RollbackManagerService.class);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartBugreportManagerService&quot;</span>);</span><br><span class="line">    mSystemServiceManager.startService(BugreportManagerService.class);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;GpuService&quot;</span>);</span><br><span class="line">    mSystemServiceManager.startService(GpuService.class);</span><br><span class="line">    traceEnd();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 startCoreServices() 方法中，就不像是前面 startBootstrapServices() 方法中那么多了，它这里面启动的服务也比较少，这里面的服务有些是和前面创建的服务的有关系，比如创建的 UsageStatsService 实例会同时保存给前面创建的 ActivityManagerService 。</p>
<p>其内部的服务基本没有啥常见的，至少是基本没有啥我常见的，这里就不展开讲了，接着去看下一个方法。</p>
<h3 id="startOtherServices"><a href="#startOtherServices" class="headerlink" title="startOtherServices"></a>startOtherServices</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.SystemServer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startOtherServices</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 一些临时属性定义</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> mSystemContext;</span><br><span class="line">    <span class="type">VibratorService</span> <span class="variable">vibrator</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">DynamicSystemService</span> <span class="variable">dynamicSystem</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">IStorageManager</span> <span class="variable">storageManager</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">NetworkManagementService</span> <span class="variable">networkManagement</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">IpSecService</span> <span class="variable">ipSecService</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">NetworkStatsService</span> <span class="variable">networkStats</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">NetworkPolicyManagerService</span> <span class="variable">networkPolicy</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">ConnectivityService</span> <span class="variable">connectivity</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">NsdService</span> <span class="variable">serviceDiscovery</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">WindowManagerService</span> <span class="variable">wm</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">SerialService</span> <span class="variable">serial</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">NetworkTimeUpdateService</span> <span class="variable">networkTimeUpdater</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">InputManagerService</span> <span class="variable">inputManager</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">TelephonyRegistry</span> <span class="variable">telephonyRegistry</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">ConsumerIrService</span> <span class="variable">consumerIr</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">MmsServiceBroker</span> <span class="variable">mmsService</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">HardwarePropertiesManagerService</span> <span class="variable">hardwarePropertiesService</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一些系统属性值读取，后续创建对应的服务时要用</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">disableSystemTextClassifier</span> <span class="operator">=</span> SystemProperties.getBoolean(</span><br><span class="line">            <span class="string">&quot;config.disable_systemtextclassifier&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">disableNetworkTime</span> <span class="operator">=</span> SystemProperties.getBoolean(<span class="string">&quot;config.disable_networktime&quot;</span>,</span><br><span class="line">            <span class="literal">false</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">disableCameraService</span> <span class="operator">=</span> SystemProperties.getBoolean(<span class="string">&quot;config.disable_cameraservice&quot;</span>,</span><br><span class="line">            <span class="literal">false</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">disableSlices</span> <span class="operator">=</span> SystemProperties.getBoolean(<span class="string">&quot;config.disable_slices&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">enableLeftyService</span> <span class="operator">=</span> SystemProperties.getBoolean(<span class="string">&quot;config.enable_lefty&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isEmulator</span> <span class="operator">=</span> SystemProperties.get(<span class="string">&quot;ro.kernel.qemu&quot;</span>).equals(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isWatch</span> <span class="operator">=</span> context.getPackageManager().hasSystemFeature(</span><br><span class="line">            PackageManager.FEATURE_WATCH);</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isArc</span> <span class="operator">=</span> context.getPackageManager().hasSystemFeature(</span><br><span class="line">            <span class="string">&quot;org.chromium.arc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">enableVrService</span> <span class="operator">=</span> context.getPackageManager().hasSystemFeature(</span><br><span class="line">            PackageManager.FEATURE_VR_MODE_HIGH_PERFORMANCE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartKeyAttestationApplicationIdProviderService&quot;</span>);</span><br><span class="line">        <span class="comment">// 直接就往 SM 中注册该服务实例了</span></span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;sec_key_att_app_id_provider&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">KeyAttestationApplicationIdProviderService</span>(context));</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 震动服务实例化并且往 SM 中注册</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartVibratorService&quot;</span>);</span><br><span class="line">        vibrator = <span class="keyword">new</span> <span class="title class_">VibratorService</span>(context);</span><br><span class="line">        ServiceManager.addService(<span class="string">&quot;vibrator&quot;</span>, vibrator);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定时、闹钟服务实例化</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartAlarmManagerService&quot;</span>);</span><br><span class="line">        mSystemServiceManager.startService(<span class="keyword">new</span> <span class="title class_">AlarmManagerService</span>(context));</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * InputManagerService 服务实例创建，这里创建好供后面 WindowManagerService 使用</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartInputManagerService&quot;</span>);</span><br><span class="line">        inputManager = <span class="keyword">new</span> <span class="title class_">InputManagerService</span>(context);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartWindowManagerService&quot;</span>);</span><br><span class="line">        ConcurrentUtils.waitForFutureNoInterrupt(mSensorServiceStart, START_SENSOR_SERVICE);</span><br><span class="line">        mSensorServiceStart = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 第一步、启动 WindowManagerService ，然后启动它需要把 InputManagerService 对象实例传入进去再启动</span></span><br><span class="line"><span class="comment">         * 第二步、后面执行  wm.onInitReady() 方法</span></span><br><span class="line"><span class="comment">         * 第三步、执行 wm.displayReady() 方法</span></span><br><span class="line"><span class="comment">         * 第四步、执行 wm.systemReady() 方法</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 创建 WindowManagerService 实例，创建时会将前面的 InputManagerService 传入进去</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        wm = WindowManagerService.main(context, inputManager, !mFirstBoot, mOnlyCore,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">PhoneWindowManager</span>(), mActivityManagerService.mActivityTaskManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将该 WindowManagerService 注册到 SM 中</span></span><br><span class="line">        ServiceManager.addService(Context.WINDOW_SERVICE, wm, <span class="comment">/* allowIsolated= */</span> <span class="literal">false</span>,</span><br><span class="line">                DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 再将 InputManagerService 注册到 SM 中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ServiceManager.addService(Context.INPUT_SERVICE, inputManager,</span><br><span class="line">                <span class="comment">/* allowIsolated= */</span> <span class="literal">false</span>, DUMP_FLAG_PRIORITY_CRITICAL);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;SetWindowManagerService&quot;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 然后将 WindowManagerService 设置保存给 ActivityManagerService</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mActivityManagerService.setWindowManager(wm);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;WindowManagerServiceOnInitReady&quot;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 初始化 WMS 中一些属性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        wm.onInitReady();</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartInputManager&quot;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 启动 InputManagerService</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        inputManager.setWindowManagerCallbacks(wm.getInputManagerCallback());</span><br><span class="line">        inputManager.start();</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;DisplayManagerWindowManagerAndInputReady&quot;</span>);</span><br><span class="line">        mDisplayManagerService.windowManagerAndInputReady();</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFactoryTestMode == FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;No Bluetooth Service (factory test)&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!context.getPackageManager().hasSystemFeature</span><br><span class="line">                (PackageManager.FEATURE_BLUETOOTH)) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;No Bluetooth Service (Bluetooth Hardware Not Present)&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            traceBeginAndSlog(<span class="string">&quot;StartBluetoothService&quot;</span>);</span><br><span class="line">            <span class="comment">// 启动 BluetoothService 服务</span></span><br><span class="line">            mSystemServiceManager.startService(BluetoothService.class);</span><br><span class="line">            traceEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 省略其它代码</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;******************************************&quot;</span>);</span><br><span class="line">        Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;************ Failure starting core service&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略其它代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行 displayReady 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        wm.displayReady();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        reportWtf(<span class="string">&quot;making display ready&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 开启设置方方面的服务</span></span><br><span class="line">    <span class="keyword">if</span> (mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 省略其它代码</span></span><br><span class="line"></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartShortcutServiceLifecycle&quot;</span>);</span><br><span class="line">        mSystemServiceManager.startService(ShortcutService.Lifecycle.class);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartLauncherAppsService&quot;</span>);</span><br><span class="line">        mSystemServiceManager.startService(LauncherAppsService.class);</span><br><span class="line">        traceEnd();</span><br><span class="line"></span><br><span class="line">        traceBeginAndSlog(<span class="string">&quot;StartCrossProfileAppsService&quot;</span>);</span><br><span class="line">        mSystemServiceManager.startService(CrossProfileAppsService.class);</span><br><span class="line">        traceEnd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isWatch) &#123;</span><br><span class="line">       <span class="comment">// 初始化手表相关服务</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启动粘贴板 ClipboardService 服务</span></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartClipboardService&quot;</span>);</span><br><span class="line">    mSystemServiceManager.startService(ClipboardService.class);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务的启动进度汇报给 SystemServiceManager </span></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartBootPhaseLockSettingsReady&quot;</span>);</span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_LOCK_SETTINGS_READY);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartBootPhaseSystemServicesReady&quot;</span>);</span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_SYSTEM_SERVICES_READY);</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;MakeWindowManagerServiceReady&quot;</span>);</span><br><span class="line">    <span class="comment">// 系统服务启动完毕了</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        wm.systemReady();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        reportWtf(<span class="string">&quot;making Window Manager Service ready&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略其他代码 </span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 startOtherServices() 方法中启动的服务很多很多，代码也很长，我们这里省略类其中的一大部分，只关心其中几个比较重要服务。</p>
<p>比如 WindowManagerService 和 InputManagerService 。在 startOtherServices() 方法中先创建了 InputManagerService 实例，然后再使用  InputManagerService 实例去创建 WindowManagerService  实例，接着会分别将 WindowManagerService  和InputManagerService  注册到 ServiceManager 中，name分别是：window 和 input 。</p>
<h4 id="InputManagerService"><a href="#InputManagerService" class="headerlink" title="InputManagerService"></a>InputManagerService</h4><p>对于 InputManagerService 的创建很简单，直接调用其构造方法就行了(我好像说了句废话…)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.input.InputManagerService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">InputManagerService</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.mContext = context;</span><br><span class="line">    <span class="comment">// 创建 Handler 实例</span></span><br><span class="line">    <span class="built_in">this</span>.mHandler = <span class="keyword">new</span> <span class="title class_">InputManagerHandler</span>(DisplayThread.get().getLooper());</span><br><span class="line"></span><br><span class="line">    mUseDevInputEventForAudioJack =</span><br><span class="line">            context.getResources().getBoolean(R.bool.config_useDevInputEventForAudioJack);</span><br><span class="line">    Slog.i(TAG, <span class="string">&quot;Initializing input manager, mUseDevInputEventForAudioJack=&quot;</span></span><br><span class="line">            + mUseDevInputEventForAudioJack);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handler native 层初始化初始化</span></span><br><span class="line">    mPtr = nativeInit(<span class="built_in">this</span>, mContext, mHandler.getLooper().getQueue());</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">doubleTouchGestureEnablePath</span> <span class="operator">=</span> context.getResources().getString(</span><br><span class="line">            R.string.config_doubleTouchGestureEnableFile);</span><br><span class="line">    mDoubleTouchGestureEnableFile = TextUtils.isEmpty(doubleTouchGestureEnablePath) ? <span class="literal">null</span> :</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">File</span>(doubleTouchGestureEnablePath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将其内部的 LocalService 添加到 LocalServices 中</span></span><br><span class="line">    LocalServices.addService(InputManagerInternal.class, <span class="keyword">new</span> <span class="title class_">LocalService</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在创建 InputManagerService 时，还是会将其内部的一个 LocalService 实例添加到 LocalServices 中，供后续  system_server 进程中的其他服务使用。</p>
<p>拿到 InputManagerService 实例之后，接着往后会将其注册到 ServiceManager 中。然后调用其 setWindowManagerCallbacks() 方法来将后续创建的 WindowManagerService 实例中的 mInputManagerCallback 保存起来，这样的话后续在 InputManagerService  中就可以操作到 WindowManagerService 了，比如发送一些事件给他。</p>
<p>接着往后回调用 InputManagerService  的 start() 方法来启动它，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.input.InputManagerService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">&quot;Starting input manager&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handler 消息队列的处理</span></span><br><span class="line">    nativeStart(mPtr);</span><br><span class="line"></span><br><span class="line">    Watchdog.getInstance().addMonitor(<span class="built_in">this</span>);</span><br><span class="line">	</span><br><span class="line">   	<span class="comment">// 更新触摸点等信息</span></span><br><span class="line">    registerPointerSpeedSettingObserver();</span><br><span class="line">    registerShowTouchesSettingObserver();</span><br><span class="line">    registerAccessibilityLargePointerSettingObserver();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册广播监听</span></span><br><span class="line">    mContext.registerReceiver(<span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">            updatePointerSpeedFromSettings();</span><br><span class="line">            updateShowTouchesFromSettings();</span><br><span class="line">            updateAccessibilityLargePointerFromSettings();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(Intent.ACTION_USER_SWITCHED), <span class="literal">null</span>, mHandler);</span><br><span class="line"></span><br><span class="line">    updatePointerSpeedFromSettings();</span><br><span class="line">    updateShowTouchesFromSettings();</span><br><span class="line">    updateAccessibilityLargePointerFromSettings();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实也没啥逻辑，最主要的就是 nativeStart() 方法中会去启动两个线程：InputDispatcher 和 InputReader 。其中 InputReader 线程会从指定的地方取出输入事件，然后交给 InputDispatcher 线程去处理，也就是将事件派发到对应的 Window 窗口中去。</p>
<p>关于 InputManagerService   的解释就只说到这里，细致的分析如果有时间的话，后期会出文来讲吧。</p>
<h4 id="WindowManagerService"><a href="#WindowManagerService" class="headerlink" title="WindowManagerService"></a>WindowManagerService</h4><p>WindowManagerService 的创建是通过其 main() 方法来实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.wm.WindowManagerService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> WindowManagerService <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> InputManagerService im,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">boolean</span> showBootMsgs, <span class="keyword">final</span> <span class="type">boolean</span> onlyCore, WindowManagerPolicy policy,</span></span><br><span class="line"><span class="params">        ActivityTaskManagerService atm)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> main(context, im, showBootMsgs, onlyCore, policy, atm,</span><br><span class="line">            SurfaceControl.Transaction::<span class="keyword">new</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> WindowManagerService <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> InputManagerService im,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">boolean</span> showBootMsgs, <span class="keyword">final</span> <span class="type">boolean</span> onlyCore, WindowManagerPolicy policy,</span></span><br><span class="line"><span class="params">        ActivityTaskManagerService atm, TransactionFactory transactionFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DisplayThread 可以理解为 HandlerThread，可以让创建逻辑执行在 android.display 线程中</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * runWithScissors() 则是阻塞同步执行，执行完之后，sInstance 就已经被初始化了，所以最后返回 sInstance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DisplayThread.getHandler().runWithScissors(() -&gt;</span><br><span class="line">            sInstance = <span class="keyword">new</span> <span class="title class_">WindowManagerService</span>(context, im, showBootMsgs, onlyCore, policy,</span><br><span class="line">                    atm, transactionFactory), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> sInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 main() 方法中会调用 DisplayThread.getHandler().runWithScissors() 方法来将 WindowManagerService 实例化逻辑放到 android.display 线程中去执行，在其执行完毕之前，当前线程阻塞等待，直到它执行完毕后当前线程恢复执行。然后返回创建出来的 WindowManagerService  实例。</p>
<p>在 WindowManagerService 构造方法中逻辑是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.wm.WindowManagerService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">WindowManagerService</span><span class="params">(Context context, InputManagerService inputManager,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> showBootMsgs, <span class="type">boolean</span> onlyCore, WindowManagerPolicy policy,</span></span><br><span class="line"><span class="params">            ActivityTaskManagerService atm, TransactionFactory transactionFactory)</span> &#123;</span><br><span class="line">    installLock(<span class="built_in">this</span>, INDEX_WINDOW);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部属性初始化，包括一些配置读取</span></span><br><span class="line">    mGlobalLock = atm.getGlobalLock();</span><br><span class="line">    mAtmService = atm;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mAllowBootMessages = showBootMsgs;</span><br><span class="line">    mOnlyCore = onlyCore;</span><br><span class="line">    mLimitedAlphaCompositing = context.getResources().getBoolean(</span><br><span class="line">            com.android.internal.R.bool.config_sf_limitedAlpha);</span><br><span class="line">    mHasPermanentDpad = context.getResources().getBoolean(</span><br><span class="line">            com.android.internal.R.bool.config_hasPermanentDpad);</span><br><span class="line">    mInTouchMode = context.getResources().getBoolean(</span><br><span class="line">            com.android.internal.R.bool.config_defaultInTouchMode);</span><br><span class="line">    mDrawLockTimeoutMillis = context.getResources().getInteger(</span><br><span class="line">            com.android.internal.R.integer.config_drawLockTimeoutMillis);</span><br><span class="line">    mAllowAnimationsInLowPowerMode = context.getResources().getBoolean(</span><br><span class="line">            com.android.internal.R.bool.config_allowAnimationsInLowPowerMode);</span><br><span class="line">    mMaxUiWidth = context.getResources().getInteger(</span><br><span class="line">            com.android.internal.R.integer.config_maxUiWidth);</span><br><span class="line">    mDisableTransitionAnimation = context.getResources().getBoolean(</span><br><span class="line">            com.android.internal.R.bool.config_disableTransitionAnimation);</span><br><span class="line">    mPerDisplayFocusEnabled = context.getResources().getBoolean(</span><br><span class="line">            com.android.internal.R.bool.config_perDisplayFocusEnabled);</span><br><span class="line">    mLowRamTaskSnapshotsAndRecents = context.getResources().getBoolean(</span><br><span class="line">            com.android.internal.R.bool.config_lowRamTaskSnapshotsAndRecents);</span><br><span class="line">    mInputManager = inputManager; <span class="comment">// Must be before createDisplayContentLocked.</span></span><br><span class="line">    mDisplayManagerInternal = LocalServices.getService(DisplayManagerInternal.class);</span><br><span class="line">    mDisplayWindowSettings = <span class="keyword">new</span> <span class="title class_">DisplayWindowSettings</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    mTransactionFactory = transactionFactory;</span><br><span class="line">    mTransaction = mTransactionFactory.make();</span><br><span class="line">    mPolicy = policy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略其他代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建出 WindowAnimator 和 RootWindowContainer 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mAnimator = <span class="keyword">new</span> <span class="title class_">WindowAnimator</span>(<span class="built_in">this</span>);</span><br><span class="line">    mRoot = <span class="keyword">new</span> <span class="title class_">RootWindowContainer</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mPolicy 就是入参 new PhoneWindowManager()</span></span><br><span class="line"><span class="comment">     * 这里将其添加到 LocalServices 中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    LocalServices.addService(WindowManagerPolicy.class, mPolicy);</span><br><span class="line"></span><br><span class="line">    mDisplayManager = (DisplayManager)context.getSystemService(Context.DISPLAY_SERVICE);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将其内部的 LocalService 实例添加到 LocalServices 中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    LocalServices.addService(WindowManagerInternal.class, <span class="keyword">new</span> <span class="title class_">LocalService</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在其构造方法中，会完成其内部属性的初始化，以及会将对应的服务添加到 LocalServices 供后续使用。</p>
<p>在拿到 WindowManagerService  实例之后，会将其注册到 ServiceManager 中，然后接着会将其实例保存到前面创建好的 ActivityManagerService 实例中。</p>
<p>接着会按顺序调用 WindowManagerService 实例的好几个方法：</p>
<p>①  onInitReady() </p>
<p>②  displayReady()</p>
<p>③  systemReady()，这个基本上是在系统服务加载完毕之后来调用的。</p>
<p>关于 WindowManagerService  ，以及上面这些方法的作用，这里不讲，后续有时间可能会单独写文章来讲。(我感觉我在一直给自己挖坑…)</p>
<p>至此，startOtherServices() 方法中几个常用的服务就讲解完了，但其实该方法中还有好多好多服务，我没办法在这里一一列出，其他的服务就交给读者去自行学习吧，或者说等我后面在源码学习中遇到了哪个服务再来这里补充吧。</p>
<h2 id="BootPhase"><a href="#BootPhase" class="headerlink" title="BootPhase"></a>BootPhase</h2><p>在前面的 SystemServer 中的 run() 执行过程中，会多次调用 ：mSystemServiceManager.startBootPhase() 方法，它是做什么的？</p>
<p>下面先看看之前讲过的 SystemService 中的一些常量定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.SystemService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SystemService</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Boot Phases</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PHASE_WAIT_FOR_DEFAULT_DISPLAY</span> <span class="operator">=</span> <span class="number">100</span>; <span class="comment">// maybe should be a dependency?</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * After receiving this boot phase, services can obtain lock settings data.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PHASE_LOCK_SETTINGS_READY</span> <span class="operator">=</span> <span class="number">480</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * After receiving this boot phase, services can safely call into core system services</span></span><br><span class="line"><span class="comment">     * such as the PowerManager or PackageManager.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PHASE_SYSTEM_SERVICES_READY</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * After receiving this boot phase, services can safely call into device specific services.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PHASE_DEVICE_SPECIFIC_SERVICES_READY</span> <span class="operator">=</span> <span class="number">520</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * After receiving this boot phase, services can broadcast Intents.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PHASE_ACTIVITY_MANAGER_READY</span> <span class="operator">=</span> <span class="number">550</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * After receiving this boot phase, services can start/bind to third party apps.</span></span><br><span class="line"><span class="comment">     * Apps will be able to make Binder calls into services at this point.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PHASE_THIRD_PARTY_APPS_CAN_START</span> <span class="operator">=</span> <span class="number">600</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * After receiving this boot phase, services can allow user interaction with the device.</span></span><br><span class="line"><span class="comment">     * This phase occurs when boot has completed and the home application has started.</span></span><br><span class="line"><span class="comment">     * System services may prefer to listen to this phase rather than registering a</span></span><br><span class="line"><span class="comment">     * broadcast receiver for ACTION_BOOT_COMPLETED to reduce overall latency.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PHASE_BOOT_COMPLETED</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略其他方法定义</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在 SystemService  中定义了好几个常量，他们的数值从小的 100，一直递增到 1000。而 1000 对应的常量名为 ： PHASE_BOOT_COMPLETED ，即表示完成阶段。</p>
<p>在这里这些数值表示的是 SystemServer 中初始化启动这些服务的进度，一开始是 0 ，然后慢慢随着内部一些服务的创建和启动，进度慢慢的增加，变为 PHASE_WAIT_FOR_DEFAULT_DISPLAY &#x3D; 100，变为 PHASE_ACTIVITY_MANAGER_READY &#x3D; 550，最后变成 PHASE_BOOT_COMPLETED &#x3D;1000 ，也就是所有的系统服务都创建并启动完成了。</p>
<p>而在前面讲到的 startBootstrapServices() 、startCoreServices() 以及 startOtherServices() 方法中，会有多次调用 mSystemServiceManager.startBootPhase() 方法的情况，并且传入的值都是越来越大的，表示当前初始化启动系统服务的进度。调用 mSystemServiceManager.startBootPhase() 方法有什么用呢？我们看看它的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.SystemServiceManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startBootPhase</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> phase)</span> &#123;</span><br><span class="line">    <span class="comment">// 进度只能增加，不能减少</span></span><br><span class="line">    <span class="keyword">if</span> (phase &lt;= mCurrentPhase) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Next phase must be larger than previous&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将当前进度保存到当前 SystemServiceManager 实例中</span></span><br><span class="line">    mCurrentPhase = phase;</span><br><span class="line"></span><br><span class="line">    Slog.i(TAG, <span class="string">&quot;Starting phase &quot;</span> + mCurrentPhase);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">&quot;OnBootPhase &quot;</span> + phase);</span><br><span class="line">        <span class="comment">// 遍历 mServices 中存储的那些服务实例，然后通过 onBootPhase 方法挨个通知他们当前进度</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">serviceLen</span> <span class="operator">=</span> mServices.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; serviceLen; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">SystemService</span> <span class="variable">service</span> <span class="operator">=</span> mServices.get(i);</span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> SystemClock.elapsedRealtime();</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, service.getClass().getName());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                service.onBootPhase(mCurrentPhase);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to boot service &quot;</span></span><br><span class="line">                        + service.getClass().getName()</span><br><span class="line">                        + <span class="string">&quot;: onBootPhase threw an exception during phase &quot;</span></span><br><span class="line">                        + mCurrentPhase, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            warnIfTooLong(SystemClock.elapsedRealtime() - time, service, <span class="string">&quot;onBootPhase&quot;</span>);</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 mSystemServiceManager.startBootPhase() 方法中，会将当前的进度，通知到其内部 mServices 列表中的那些服务中去。而 mServices 列表中存储的服务正是之前通过该 SystemServiceManager 的 startService() 方法启动过的那些服务。而由于 SystemServiceManager 的 startService() 方法在后续是一直被陆陆续续的调用的，所以其内部的 mServices  列表中的服务时陆陆续续被添加新服务实例的，因此在状态变化时，在此之前添加的那些服务才能收到 onBootPhase() 方法的通知。</p>
<p>所以先启动的服务才能接收到其之后的服务启动进度通知，比如：ActivityManagerService 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.server.wm.ActivityManagerService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Lifecycle</span> <span class="keyword">extends</span> <span class="title class_">SystemService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ActivityTaskManagerService sAtm;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略其他方法</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBootPhase</span><span class="params">(<span class="type">int</span> phase)</span> &#123;</span><br><span class="line">        <span class="comment">// 将当前服务初始化启动的进度保存起来</span></span><br><span class="line">        mService.mBootPhase = phase;</span><br><span class="line">        <span class="comment">// 在不同的进度时，执行不同的逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (phase == PHASE_SYSTEM_SERVICES_READY) &#123;</span><br><span class="line">            mService.mBatteryStatsService.systemServicesReady();</span><br><span class="line">            mService.mServices.systemServicesReady();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (phase == PHASE_ACTIVITY_MANAGER_READY) &#123;</span><br><span class="line">            mService.startBroadcastObservers();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (phase == PHASE_THIRD_PARTY_APPS_CAN_START) &#123;</span><br><span class="line">            mService.mPackageWatchdog.onPackagesReady();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ActivityManagerService   是一开始就加载启动了的，所以它可以接收到后续的进度通知，从而实现在后续服务加载过程中，根据进度不同来进行其内部的不同的初始化逻辑。</p>

            </div>
          

    
      <footer class="post-footer">
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/d414997b.html">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">ARouter 原理分析</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/4d381682.html">
        <span class="next-text nav-default">Java 动态代理原理分析</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2020 -
    
    2023
    <span class="footer-author">咔咔咔.</span>
    <span class="power-by">
        由 <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> and <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a> 强力驱动
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
