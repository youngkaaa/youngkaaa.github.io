<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="GLES&EGL-EGL-02"/>




  <meta name="keywords" content="AndroidFrameworks,OpenGLES,EGL," />





  <link rel="alternate" href="/default" title="咔咔咔" >




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://youngkaaa.github.io/3341fdf3.html"/>


<meta name="description" content="承接前面  GLES&amp;EGL-EGL-01 文章中的内容，本文接着往下看 EGL 中的操作。 eglCreateWindowSurface经过了 GLES&amp;EGL-EGL-01步骤之后，就可以调用当前方法来创建对应的 EGLSurface 了，后续就可以使用它来完成GLES的绘画操作了。 12345678910&#x2F;&#x2F; frameworks&#x2F;native&#x2F;opengl&#x2F;libs&#x2F;EGL">
<meta property="og:type" content="article">
<meta property="og:title" content="GLES&amp;EGL-EGL-02">
<meta property="og:url" content="https://youngkaaa.github.io/3341fdf3.html">
<meta property="og:site_name" content="咔咔咔">
<meta property="og:description" content="承接前面  GLES&amp;EGL-EGL-01 文章中的内容，本文接着往下看 EGL 中的操作。 eglCreateWindowSurface经过了 GLES&amp;EGL-EGL-01步骤之后，就可以调用当前方法来创建对应的 EGLSurface 了，后续就可以使用它来完成GLES的绘画操作了。 12345678910&#x2F;&#x2F; frameworks&#x2F;native&#x2F;opengl&#x2F;libs&#x2F;EGL">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-20T11:50:57.000Z">
<meta property="article:modified_time" content="2023-03-03T14:01:40.847Z">
<meta property="article:author" content="咔咔咔">
<meta property="article:tag" content="AndroidFrameworks">
<meta property="article:tag" content="OpenGLES">
<meta property="article:tag" content="EGL">
<meta name="twitter:card" content="summary">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> GLES&EGL-EGL-02 - 咔咔咔 </title>
  <meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">咔咔咔</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          GLES&EGL-EGL-02
        
      </h1>

      <time class="post-time">
          8月 20 2022
      </time>
    </header>



    
            <div class="post-content">
            <p>承接前面  <a href="aa48ac49.html">GLES&amp;EGL-EGL-01 </a>文章中的内容，本文接着往下看 EGL 中的操作。</p>
<h3 id="eglCreateWindowSurface"><a href="#eglCreateWindowSurface" class="headerlink" title="eglCreateWindowSurface"></a>eglCreateWindowSurface</h3><p>经过了 <a href="aa48ac49.html">GLES&amp;EGL-EGL-01</a>步骤之后，就可以调用当前方法来创建对应的 EGLSurface 了，后续就可以使用它来完成GLES的绘画操作了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/eglApi.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLSurface <span class="title">eglCreateWindowSurface</span><span class="params">(EGLDisplay dpy, EGLConfig config, NativeWindowType window,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> EGLint* attrib_list)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">clearError</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">egl_connection_t</span>* <span class="type">const</span> cnx = &amp;gEGLImpl;</span><br><span class="line">    <span class="keyword">return</span> cnx-&gt;platform.<span class="built_in">eglCreateWindowSurface</span>(dpy, config, window, attrib_list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当前方法比较重要，所以后续分析会尽可能详细些。</p>
<p>在 eglApi.cpp#eglCreateWindowSurface() 方法中，会传入四个参数：</p>
<p>① dpy ：它是 EGLDisplay 类型的，在 <a href="aa48ac49.html">GLES&amp;EGL-EGL-01</a>文章中多次提到了它，不熟悉的话可以再去复习看看。</p>
<p>② config ：它是一个 EGLConfig 类型的属性，实际就是前面调用  eglGetConfigs() 方法或者 eglChooseConfig() 方法拿到的配置信息。当然它实际上对应的是 agl 中 gConfigs 数组的索引值。</p>
<p>③ window ： 它是一个 NativeWindowType 类型的属性，而它的定义是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/include/EGL/eglplatform.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> *EGLNativePixmapType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> EGLNativeWindowType  NativeWindowType;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也就是说，它可以存储任意值。关于这种定义方式，在 <a href="aa48ac49.html">GLES&amp;EGL-EGL-01</a>文章中多次有提到，比如 EGLConfig，以及即将遇到的 EGLSurface。</p>
<p>而在实际使用中，传入的一般都是 <a href="https://youngkaaa.github.io/tags/Surface/">Surface</a> 。后续的分析中也默认把它理解成 Surface</p>
<p>④ attrib_list ：额外的配置信息，类似于前面 <a href="aa48ac49.html">GLES&amp;EGL-EGL-01</a>方法中提到的。不过一般都是传入 null。内部分析时，也可以把它当做null来理解。</p>
<p>接着还是会执行到 egl_platform_entries.cpp 中的 eglCreateWindowSurfaceImpl() 方法内。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_platform_entries.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLSurface <span class="title">eglCreateWindowSurfaceImpl</span><span class="params">(EGLDisplay dpy, EGLConfig config, NativeWindowType window,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="type">const</span> EGLint* attrib_list)</span> </span>&#123;</span><br><span class="line">    <span class="type">egl_connection_t</span>* cnx = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 比之前的 validate_display() 多了个 so库 是否已加载的判断</span></span><br><span class="line">    egl_display_ptr dp = <span class="built_in">validate_display_connection</span>(dpy, cnx);</span><br><span class="line">    <span class="keyword">if</span> (dp) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 调用到 eglCreateWindowSurfaceTmpl 方法中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">eglCreateWindowSurfaceTmpl</span>&lt;EGLint, PFNEGLCREATEWINDOWSURFACEPROC&gt;(dp, cnx, config, window, attrib_list,</span><br><span class="line">                                                       cnx-&gt;egl.eglCreateWindowSurface);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> EGL_NO_SURFACE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">EGLSurface <span class="title">eglCreateWindowSurfaceTmpl</span><span class="params">(egl_display_ptr dp, <span class="type">egl_connection_t</span>* cnx, EGLConfig config,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      ANativeWindow* window, <span class="type">const</span> AttrType* attrib_list,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      CreateFuncType createWindowSurfaceFunc)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> AttrType* origAttribList = attrib_list;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里传入的 window 一般就是 Surface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!window) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_NATIVE_WINDOW, EGL_NO_SURFACE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 检查该 Surface 中是否存在 BufferQueueProducer</span></span><br><span class="line">    window-&gt;<span class="built_in">query</span>(window, NATIVE_WINDOW_IS_VALID, &amp;value);</span><br><span class="line">    <span class="keyword">if</span> (!value) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_NATIVE_WINDOW, EGL_NO_SURFACE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳过这里</span></span><br><span class="line">    <span class="keyword">if</span> (cnx-&gt;angleBackend != EGL_PLATFORM_ANGLE_TYPE_VULKAN_ANGLE) &#123;</span><br><span class="line">        <span class="type">int</span> result = <span class="built_in">native_window_api_connect</span>(window, NATIVE_WINDOW_API_EGL);</span><br><span class="line">        <span class="keyword">if</span> (result &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">ALOGE</span>(<span class="string">&quot;eglCreateWindowSurface: native_window_api_connect (win=%p) &quot;</span></span><br><span class="line">                  <span class="string">&quot;failed (%#x) (already connected to another API?)&quot;</span>,</span><br><span class="line">                  window, result);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_ALLOC, EGL_NO_SURFACE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从入参 dp-&gt;disp.dpy 中取出当前 egl_display_t 对应的 EGLDisplay</span></span><br><span class="line"><span class="comment">     * dp-&gt;disp.dpy 会在前面 eglGetDisplay 时保存起来的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EGLDisplay iDpy = dp-&gt;disp.dpy;</span><br><span class="line">    <span class="comment">// 通过查询 EGL 实现，拿到当前像素格式</span></span><br><span class="line">    android_pixel_format format;</span><br><span class="line">    <span class="built_in">getNativePixelFormat</span>(iDpy, cnx, config, &amp;format);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// colorSpace 先忽略，可以不用先深入</span></span><br><span class="line">    EGLint colorSpace = EGL_UNKNOWN;</span><br><span class="line">    std::vector&lt;AttrType&gt; strippedAttribList;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">processAttributes</span>&lt;AttrType&gt;(dp, window, attrib_list, &amp;colorSpace, &amp;strippedAttribList)) &#123;</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;error invalid colorspace: %d&quot;</span>, colorSpace);</span><br><span class="line">        <span class="keyword">if</span> (cnx-&gt;angleBackend != EGL_PLATFORM_ANGLE_TYPE_VULKAN_ANGLE) &#123;</span><br><span class="line">            <span class="built_in">native_window_api_disconnect</span>(window, NATIVE_WINDOW_API_EGL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> EGL_NO_SURFACE;</span><br><span class="line">    &#125;</span><br><span class="line">    attrib_list = strippedAttribList.<span class="built_in">data</span>();</span><br><span class="line">    <span class="keyword">if</span> (cnx-&gt;angleBackend != EGL_PLATFORM_ANGLE_TYPE_VULKAN_ANGLE) &#123;</span><br><span class="line">        <span class="type">int</span> err = <span class="built_in">native_window_set_buffers_format</span>(window, format);</span><br><span class="line">        <span class="keyword">if</span> (err != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">ALOGE</span>(<span class="string">&quot;error setting native window pixel format: %s (%d)&quot;</span>, <span class="built_in">strerror</span>(-err), err);</span><br><span class="line">            <span class="built_in">native_window_api_disconnect</span>(window, NATIVE_WINDOW_API_EGL);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_NATIVE_WINDOW, EGL_NO_SURFACE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        android_dataspace dataSpace = <span class="built_in">dataSpaceFromEGLColorSpace</span>(colorSpace);</span><br><span class="line">        err = <span class="built_in">native_window_set_buffers_data_space</span>(window, dataSpace);</span><br><span class="line">        <span class="keyword">if</span> (err != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">ALOGE</span>(<span class="string">&quot;error setting native window pixel dataSpace: %s (%d)&quot;</span>, <span class="built_in">strerror</span>(-err), err);</span><br><span class="line">            <span class="built_in">native_window_api_disconnect</span>(window, NATIVE_WINDOW_API_EGL);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_NATIVE_WINDOW, EGL_NO_SURFACE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    window-&gt;<span class="built_in">setSwapInterval</span>(window, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对应的是： cnx-&gt;egl.eglCreateWindowSurface 方法</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 这里返回的 surface 其实是 agl 中的 egl_window_surface_v2_t</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EGLSurface surface = <span class="built_in">createWindowSurfaceFunc</span>(iDpy, config, window, attrib_list);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最终封装成 egl 中的 egl_surface_t 返回出去</span></span><br><span class="line">    <span class="keyword">if</span> (surface != EGL_NO_SURFACE) &#123;</span><br><span class="line">        <span class="type">egl_surface_t</span>* s = <span class="keyword">new</span> <span class="built_in">egl_surface_t</span>(dp.<span class="built_in">get</span>(), config, window, surface,</span><br><span class="line">                                             <span class="built_in">getReportedColorSpace</span>(colorSpace), cnx);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// EGLSurface creation failed</span></span><br><span class="line">    <span class="keyword">if</span> (cnx-&gt;angleBackend != EGL_PLATFORM_ANGLE_TYPE_VULKAN_ANGLE) &#123;</span><br><span class="line">        <span class="built_in">native_window_set_buffers_format</span>(window, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">native_window_api_disconnect</span>(window, NATIVE_WINDOW_API_EGL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> EGL_NO_SURFACE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">egl_display_ptr <span class="title">validate_display_connection</span><span class="params">(EGLDisplay dpy,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">egl_connection_t</span>*&amp; cnx)</span> </span>&#123;</span><br><span class="line">    cnx = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">// 先检查 display 是否合法</span></span><br><span class="line">    egl_display_ptr dp = <span class="built_in">validate_display</span>(dpy);</span><br><span class="line">    <span class="keyword">if</span> (!dp)</span><br><span class="line">        <span class="keyword">return</span> dp;</span><br><span class="line">    <span class="comment">// display 合法之后，再检查 gEGLImpl 是否合法，即它是否已经完成驱动加载</span></span><br><span class="line">    cnx = &amp;gEGLImpl;</span><br><span class="line">    <span class="keyword">if</span> (cnx-&gt;dso == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_CONFIG, <span class="built_in">egl_display_ptr</span>(<span class="literal">nullptr</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时，会先调用 validate_display_connection() 方法来拿到当前入参 dpy 所对应的 egl_display_ptr 实例，相当于拿到了其对应的  egl_display_t 实例。在validate_display_connection() 方法中额外判断了 dso 的加载，当然绝大多数情况下到这里时都是已加载的。</p>
<p>接着会调用另外一个 eglCreateWindowSurfaceTmpl() 方法，额外传入了：</p>
<p>① dp ：也就是刚找到的，dpy对应的 egl_display_ptr 实例。</p>
<p>② createWindowSurfaceFunc ：对应着 cnx-&gt;egl.eglCreateWindowSurface 函数。后续内部会调用它来完成 agl 侧的逻辑执行。</p>
<p>接着会检查入参的合法性，比如调用 window-&gt;query() 方法来判断该 window 中是否已经绑定了消费者实例，也就是BufferQueueProducer，详见 <a href="https://youngkaaa.github.io/tags/Surface/">Surface</a>。</p>
<p>接下来会读取当前指定的 config 对应的像素信息以及 初始化 colorSpace 、dataSpace 等属性的值，然后通过 native_window_set_buffers_format()、native_window_set_buffers_data_space() 等方法来将其设置到 window 中去，也就是 Surface 中。相当于把这里 EGL 中的配置信息转存到 Surface 中。</p>
<p>接下来就是执行 createWindowSurfaceFunc() 方法，也就是外部传入进来的 cnx-&gt;egl.eglCreateWindowSurface 函数。此时会调用到 agl 侧去执行：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libagl/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLSurface <span class="title">eglCreateWindowSurface</span><span class="params">(  EGLDisplay dpy, EGLConfig config,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    NativeWindowType window,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> EGLint *attrib_list)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">createWindowSurface</span>(dpy, config, window, attrib_list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> EGLSurface <span class="title">createWindowSurface</span><span class="params">(EGLDisplay dpy, EGLConfig config,</span></span></span><br><span class="line"><span class="params"><span class="function">        NativeWindowType window, <span class="type">const</span> EGLint* <span class="comment">/*attrib_list*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 合法性判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="type">egl_display_t</span>::<span class="built_in">is_valid</span>(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_DISPLAY, EGL_NO_SURFACE);</span><br><span class="line">    <span class="keyword">if</span> (window == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_MATCH, EGL_NO_SURFACE);</span><br><span class="line"></span><br><span class="line">    EGLint surfaceType;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getConfigAttrib</span>(dpy, config, EGL_SURFACE_TYPE, &amp;surfaceType) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> EGL_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(surfaceType &amp; EGL_WINDOW_BIT))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_MATCH, EGL_NO_SURFACE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查该 window 属性中的 magic 魔数值，不是 ANDROID_NATIVE_WINDOW_MAGIC 的话则不可用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">static_cast</span>&lt;ANativeWindow*&gt;(window)-&gt;common.magic != ANDROID_NATIVE_WINDOW_MAGIC) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_NATIVE_WINDOW, EGL_NO_SURFACE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下面开始处理 config ，首先通过 config 来获取其对应的 configID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EGLint configID;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getConfigAttrib</span>(dpy, config, EGL_CONFIG_ID, &amp;configID) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> EGL_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> depthFormat;</span><br><span class="line">    <span class="type">int32_t</span> pixelFormat;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 然后通过  configID 来获取该 config 对应的 depthFormat 和 pixelFormat</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getConfigFormatInfo</span>(configID, pixelFormat, depthFormat) != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_MATCH, EGL_NO_SURFACE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">egl_surface_t</span>* surface;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实际创建的是 egl_window_surface_v2_t,它继承了 egl_surface_t</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    surface = <span class="keyword">new</span> <span class="built_in">egl_window_surface_v2_t</span>(dpy, config, depthFormat, <span class="built_in">static_cast</span>&lt;ANativeWindow*&gt;(window));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于  egl_pbuffer_surface_t  来说，该方法一直返回 true</span></span><br><span class="line">    <span class="keyword">if</span> (!surface-&gt;<span class="built_in">initCheck</span>()) &#123;</span><br><span class="line">        <span class="keyword">delete</span> surface;</span><br><span class="line">        surface = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 最后将创建的 egl_window_surface_v2_t， 返回出去</span></span><br><span class="line">    <span class="keyword">return</span> surface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在agl这边，eglCreateWindowSurface() 方法的逻辑比较简单。</p>
<p>首先就是对入参的合法性判断，关于合法性判断中，需要单独讲一点：</p>
<p>判断 window 中的魔数是否等于 ANDROID_NATIVE_WINDOW_MAGIC。这里会把 window 强转成 ANativeWindow 类型，然后再判断魔数。而关于 ANativeWindow ，以及魔数 ANDROID_NATIVE_WINDOW_MAGIC 的分析，可以去<a href="91da79fe.html">Surface学习(三)–Layer简介</a>看更详细的分析。我们这里一直把它当做Surface来理解，所以这里的条件是满足的。</p>
<p>接着会通过入参 config 配置信息，来查询该配置对应的 depthFormat 和 pixelFormat ，其中 pixelFormat 表示像素格式，比如常见的  GGL_PIXEL_FORMAT_RGBA_8888 ，也就是 RGBA_8888类型，如果你熟悉Android中的 Bitmap的话，那么 android.graphics.Bitmap.Config 中就会有一些类似的常量。</p>
<p>最后，会将这些属性，包括入参 window ，统一都保存到一个 egl_window_surface_v2_t 实例中，并将该实例返回出去。</p>
<p>agl 中的 eglCreateWindowSurface() 方法就分析完了，逻辑很简单，但是其中有两个没见过的类型比较复杂，也比较重要，所以下面看看这俩类型到底是啥。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libagl/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">egl_surface_t</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        PAGE_FLIP = <span class="number">0x00000001</span>,</span><br><span class="line">        MAGIC     = <span class="number">0x31415265</span></span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="type">uint32_t</span>            magic;</span><br><span class="line">   </span><br><span class="line">    EGLDisplay          dpy;</span><br><span class="line">  </span><br><span class="line">    EGLConfig           config;</span><br><span class="line">  </span><br><span class="line">    EGLContext          ctx;</span><br><span class="line">    <span class="type">bool</span>                zombie;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">egl_surface_t</span>(EGLDisplay dpy, EGLConfig config, <span class="type">int32_t</span> depthFormat);</span><br><span class="line">    <span class="keyword">virtual</span>     ~<span class="built_in">egl_surface_t</span>();</span><br><span class="line">                <span class="function"><span class="type">bool</span>    <span class="title">isValid</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     <span class="type">bool</span>    <span class="title">initCheck</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLBoolean  <span class="title">bindDrawSurface</span><span class="params">(<span class="type">ogles_context_t</span>* gl)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLBoolean  <span class="title">bindReadSurface</span><span class="params">(<span class="type">ogles_context_t</span>* gl)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLBoolean  <span class="title">connect</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> EGL_TRUE; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     <span class="type">void</span>        <span class="title">disconnect</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getWidth</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getHeight</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getHorizontalResolution</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getVerticalResolution</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getRefreshRate</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getSwapBehavior</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLBoolean  <span class="title">swapBuffers</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLBoolean  <span class="title">setSwapRectangle</span><span class="params">(EGLint l, EGLint t, EGLint w, EGLint h)</span></span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    GGLSurface              depth;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 它继承自 egl_surface_t</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">egl_window_surface_v2_t</span> : <span class="keyword">public</span> <span class="type">egl_surface_t</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">egl_window_surface_v2_t</span>(</span><br><span class="line">            EGLDisplay dpy, EGLConfig config,</span><br><span class="line">            <span class="type">int32_t</span> depthFormat,</span><br><span class="line">            ANativeWindow* window);</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">egl_window_surface_v2_t</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认都返回 true</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     <span class="type">bool</span>        <span class="title">initCheck</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125; <span class="comment">// <span class="doctag">TODO:</span> report failure if ctor fails</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLBoolean  <span class="title">swapBuffers</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLBoolean  <span class="title">bindDrawSurface</span><span class="params">(<span class="type">ogles_context_t</span>* gl)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLBoolean  <span class="title">bindReadSurface</span><span class="params">(<span class="type">ogles_context_t</span>* gl)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLBoolean  <span class="title">connect</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     <span class="type">void</span>        <span class="title">disconnect</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getWidth</span><span class="params">()</span> <span class="type">const</span>    </span>&#123; <span class="keyword">return</span> width;  &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getHeight</span><span class="params">()</span> <span class="type">const</span>   </span>&#123; <span class="keyword">return</span> height; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getHorizontalResolution</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getVerticalResolution</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getRefreshRate</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLint      <span class="title">getSwapBehavior</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span>     EGLBoolean  <span class="title">setSwapRectangle</span><span class="params">(EGLint l, EGLint t, EGLint w, EGLint h)</span></span>;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">status_t</span> <span class="title">lock</span><span class="params">(ANativeWindowBuffer* buf, <span class="type">int</span> usage, <span class="type">void</span>** vaddr)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">status_t</span> <span class="title">unlock</span><span class="params">(ANativeWindowBuffer* buf)</span></span>;</span><br><span class="line">  </span><br><span class="line">    ANativeWindow*   nativeWindow;</span><br><span class="line">  </span><br><span class="line">    ANativeWindowBuffer*   buffer;</span><br><span class="line">  </span><br><span class="line">    ANativeWindowBuffer*   previousBuffer;</span><br><span class="line">  </span><br><span class="line">    <span class="type">int</span> width;</span><br><span class="line">    <span class="type">int</span> height;</span><br><span class="line">  </span><br><span class="line">    <span class="type">void</span>* bits;</span><br><span class="line">    GGLFormat <span class="type">const</span>* pixelFormatTable;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Rect</span> &#123;</span><br><span class="line">       <span class="comment">// 省略内部实现</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Region</span> &#123;</span><br><span class="line">       <span class="comment">// 省略内部实现</span></span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">copyBlt</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            ANativeWindowBuffer* dst, <span class="type">void</span>* dst_vaddr,</span></span></span><br><span class="line"><span class="params"><span class="function">            ANativeWindowBuffer* src, <span class="type">void</span> <span class="type">const</span>* src_vaddr,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">const</span> Region&amp; clip)</span></span>;</span><br><span class="line"></span><br><span class="line">    Rect dirtyRegion;</span><br><span class="line">  </span><br><span class="line">    Rect oldDirtyRegion;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>没错，这俩类型分别就是：egl_surface_t 和 egl_window_surface_v2_t 。其中后者继承自前者，这个继承关系需要记住，因为 egl_surface_t 后续还有其他的子类实现，而这里的 egl_window_surface_v2_t 实现是针对当前 eglCreateWindowSurface() 方法的。对于它内部的属性含义，我们遇到一个讲一个吧，这里先对这俩的关系有个认识就行。</p>
<p>接下来看看 egl_window_surface_v2_t 的构造方法实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libagl/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="type">egl_window_surface_v2_t</span>::<span class="built_in">egl_window_surface_v2_t</span>(EGLDisplay dpy,</span><br><span class="line">        EGLConfig config,</span><br><span class="line">        <span class="type">int32_t</span> depthFormat,</span><br><span class="line">        ANativeWindow* window)</span><br><span class="line">    : <span class="built_in">egl_surface_t</span>(dpy, config, depthFormat),</span><br><span class="line">    <span class="built_in">nativeWindow</span>(window), <span class="built_in">buffer</span>(<span class="number">0</span>), <span class="built_in">previousBuffer</span>(<span class="number">0</span>), <span class="built_in">bits</span>(<span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    pixelFormatTable = <span class="built_in">gglGetPixelFormatTable</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自增引用数，并且查询该 window 的宽高信息，将其存储到 width 和 height 属性中</span></span><br><span class="line">    nativeWindow-&gt;common.<span class="built_in">incRef</span>(&amp;nativeWindow-&gt;common);</span><br><span class="line">    nativeWindow-&gt;<span class="built_in">query</span>(nativeWindow, NATIVE_WINDOW_WIDTH, &amp;width);</span><br><span class="line">    nativeWindow-&gt;<span class="built_in">query</span>(nativeWindow, NATIVE_WINDOW_HEIGHT, &amp;height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">egl_surface_t</span>::<span class="built_in">egl_surface_t</span>(EGLDisplay dpy,</span><br><span class="line">        EGLConfig config,</span><br><span class="line">        <span class="type">int32_t</span> depthFormat)</span><br><span class="line">    : <span class="built_in">magic</span>(MAGIC), <span class="built_in">dpy</span>(dpy), <span class="built_in">config</span>(config), <span class="built_in">ctx</span>(<span class="number">0</span>), <span class="built_in">zombie</span>(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    depth.version = <span class="built_in">sizeof</span>(GGLSurface);</span><br><span class="line">    depth.data = <span class="number">0</span>;</span><br><span class="line">    depth.format = depthFormat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在它的构造方法中，会将入参挨个保存起来，所以说egl_surface_t中的 magic 、dpy 、config 的值就会被初始化赋值，同时会查询该window 的宽高，并将其保存到 egl_window_surface_v2_t 中的 width 、height 属性中。</p>
<p>注意这里的 window ，是保存到了 egl_window_surface_v2_t 中，也就是说 egl_window_surface_v2_t 在 egl_surface_t 的基础上扩充了nativeWindow 、width 、height 属性，</p>
<p>也就是说 egl_surface_t 只管最基础的数据，而其不同的子类关注额外的信息，比如 egl_window_surface_v2_t 子类中就额外关注 window 的数据。</p>
<p>到这里先打住，至此agl这边的逻辑执行完毕了，那么接着回到 egl_platform_entries.cpp 中的 eglCreateWindowSurfaceImpl() 方法内。</p>
<p>此时拿到返回值 EGLSurface ，实际对应 egl_window_surface_v2_t 实例，将其包装到 egl_surface_t 实例中再返回出去。</p>
<p>下面看看这个 egl_surface_t ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_object.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">egl_object_t</span> &#123;</span><br><span class="line">    <span class="type">egl_display_t</span> *display;</span><br><span class="line">    <span class="keyword">mutable</span> std::<span class="type">atomic_size_t</span> count;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">egl_object_t</span>();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">terminate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">egl_object_t</span><span class="params">(<span class="type">egl_display_t</span>* display)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">incRef</span><span class="params">()</span> </span>&#123; count.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">size_t</span> <span class="title">decRef</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> count.<span class="built_in">fetch_sub</span>(<span class="number">1</span>, std::memory_order_acq_rel); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">egl_display_t</span>* <span class="title">getDisplay</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> display; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">get</span><span class="params">(<span class="type">egl_display_t</span> <span class="type">const</span>* display, <span class="type">egl_object_t</span>* object)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> N, <span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">LocalRef</span> &#123;</span><br><span class="line">        <span class="type">egl_object_t</span>* ref;</span><br><span class="line">        <span class="built_in">LocalRef</span>() = <span class="keyword">delete</span>;</span><br><span class="line">        <span class="built_in">LocalRef</span>(<span class="type">const</span> LocalRef* rhs) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        ~<span class="built_in">LocalRef</span>();</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">LocalRef</span><span class="params">(<span class="type">egl_object_t</span>* rhs)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">LocalRef</span><span class="params">(<span class="type">egl_display_t</span> <span class="type">const</span>* display, T o)</span> : ref(nullptr) &#123;</span></span><br><span class="line">            <span class="type">egl_object_t</span>* native = <span class="built_in">reinterpret_cast</span>&lt;N*&gt;(o);</span><br><span class="line">            <span class="keyword">if</span> (o &amp;&amp; <span class="type">egl_object_t</span>::<span class="built_in">get</span>(display, native)) &#123;</span><br><span class="line">                ref = native;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">inline</span> N* <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;N*&gt;(ref);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">acquire</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">release</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">terminate</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> N, <span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">LocalRef</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">egl_surface_t</span> : <span class="keyword">public</span> <span class="type">egl_object_t</span> &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    ~<span class="built_in">egl_surface_t</span>();</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">terminate</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> <span class="type">egl_object_t</span>::LocalRef&lt;<span class="type">egl_surface_t</span>, EGLSurface&gt; Ref;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">egl_surface_t</span>(<span class="type">egl_display_t</span>* dpy, EGLConfig config, EGLNativeWindowType win, EGLSurface surface,</span><br><span class="line">                  EGLint colorSpace, <span class="type">egl_connection_t</span> <span class="type">const</span>* cnx);</span><br><span class="line"></span><br><span class="line">    <span class="function">ANativeWindow* <span class="title">getNativeWindow</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> win; &#125;</span><br><span class="line">    <span class="function">ANativeWindow* <span class="title">getNativeWindow</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> win; &#125;</span><br><span class="line">    <span class="function">EGLint <span class="title">getColorSpace</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> colorSpace; &#125;</span><br><span class="line">    <span class="function">EGLBoolean <span class="title">setSmpte2086Attribute</span><span class="params">(EGLint attribute, EGLint value)</span></span>;</span><br><span class="line">    <span class="function">EGLBoolean <span class="title">setCta8613Attribute</span><span class="params">(EGLint attribute, EGLint value)</span></span>;</span><br><span class="line">    <span class="function">EGLBoolean <span class="title">getColorSpaceAttribute</span><span class="params">(EGLint attribute, EGLint* value)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">EGLBoolean <span class="title">getSmpte2086Attribute</span><span class="params">(EGLint attribute, EGLint* value)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">EGLBoolean <span class="title">getCta8613Attribute</span><span class="params">(EGLint attribute, EGLint* value)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">EGLBoolean <span class="title">getSmpte2086Metadata</span><span class="params">(android_smpte2086_metadata&amp; smpte2086)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">EGLBoolean <span class="title">getCta8613Metadata</span><span class="params">(android_cta861_3_metadata&amp; cta861_3)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">resetSmpte2086Metadata</span><span class="params">()</span> </span>&#123; egl_smpte2086_dirty = <span class="literal">false</span>; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">resetCta8613Metadata</span><span class="params">()</span> </span>&#123; egl_cta861_3_dirty = <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    EGLSurface surface;</span><br><span class="line">    EGLConfig config;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ANativeWindow* win;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">egl_connection_t</span> <span class="type">const</span>* cnx;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">bool</span> connected;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">disconnect</span><span class="params">()</span></span>;</span><br><span class="line">    EGLint colorSpace;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里又出来了一个 egl_surface_t，有点晕。</p>
<p>①前面讲的是 libagl 中的 egl_surface_t ，他是基类，它的实现子类是 egl_window_surface_v2_t。</p>
<p>②而这里是 egl 中( 这里的egl其实表示的是：非 libagl 的，也就是这里的egl_platform_entries.cpp )，egl_surface_t 是子类，其对应的父类是 egl_object_t 。</p>
<p>接下来看看其构造方法实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_object.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="type">egl_surface_t</span>::<span class="built_in">egl_surface_t</span>(<span class="type">egl_display_t</span>* dpy, EGLConfig config, EGLNativeWindowType win,</span><br><span class="line">                             EGLSurface surface, EGLint colorSpace, <span class="type">egl_connection_t</span> <span class="type">const</span>* cnx)</span><br><span class="line">      : <span class="built_in">egl_object_t</span>(dpy), </span><br><span class="line">        <span class="built_in">surface</span>(surface),</span><br><span class="line">        <span class="built_in">config</span>(config),</span><br><span class="line">        <span class="built_in">win</span>(win),</span><br><span class="line">        <span class="built_in">cnx</span>(cnx),</span><br><span class="line">        <span class="built_in">connected</span>(<span class="literal">true</span>),</span><br><span class="line">        <span class="built_in">colorSpace</span>(colorSpace),</span><br><span class="line">        <span class="built_in">egl_smpte2086_dirty</span>(<span class="literal">false</span>),</span><br><span class="line">        <span class="built_in">egl_cta861_3_dirty</span>(<span class="literal">false</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内部属性赋值</span></span><br><span class="line">    egl_smpte2086_metadata.displayPrimaryRed = &#123; EGL_DONT_CARE, EGL_DONT_CARE &#125;;</span><br><span class="line">    egl_smpte2086_metadata.displayPrimaryGreen = &#123; EGL_DONT_CARE, EGL_DONT_CARE &#125;;</span><br><span class="line">    egl_smpte2086_metadata.displayPrimaryBlue = &#123; EGL_DONT_CARE, EGL_DONT_CARE &#125;;</span><br><span class="line">    egl_smpte2086_metadata.whitePoint = &#123; EGL_DONT_CARE, EGL_DONT_CARE &#125;;</span><br><span class="line">    egl_smpte2086_metadata.maxLuminance = EGL_DONT_CARE;</span><br><span class="line">    egl_smpte2086_metadata.minLuminance = EGL_DONT_CARE;</span><br><span class="line">    egl_cta861_3_metadata.maxFrameAverageLightLevel = EGL_DONT_CARE;</span><br><span class="line">    egl_cta861_3_metadata.maxContentLightLevel = EGL_DONT_CARE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (win) &#123;</span><br><span class="line">        win-&gt;<span class="built_in">incStrong</span>(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在创建 egl 中的这个 egl_surface_t 实例时，传入的参数还不少呢。这里梳理下吧。</p>
<p>① egl_display_t* dpy ：前面的 eglApi.cpp#eglCreateWindowSurface() 方法中通过入参传入进来的 EGLDisplay dpy所对应的 egl_display_t 实例。</p>
<p>② EGLConfig config ：前面的 eglApi.cpp#eglCreateWindowSurface() 方法传入的配置信息。</p>
<p>③ EGLNativeWindowType win ：前面的 eglApi.cpp#eglCreateWindowSurface() 方法传入的Surface实例。</p>
<p>④ EGLSurface surface ：刚刚调用 libagl 中的 eglCreateWindowSurface() 方法创建的 egl_window_surface_v2_t 实例。</p>
<p>⑤ EGLint colorSpace ：前面拿到的 colorSpace 。</p>
<p>⑥ egl_connection_t const* cnx ：在前面的 validate_display_connection() 方法内赋值的 gEGLImpl 实例</p>
<p>分析完这些入参，也就相当于把这里的 egl_surface_t 构造方法以及其个别属性分析完了。</p>
<p>最最最最最最最最最最最最后，回到 egl_platform_entries.cpp 中的 eglCreateWindowSurfaceImpl() 方法内接着往后看，会将这个 egl_surface_t 实例返回出去，最终一步步返回到 eglApi.cpp#eglCreateWindowSurface() 方法，从而该方法执行完毕。</p>
<p>整个过程还是比较简单的，就是里面有几个类比较绕，尤其是它还是同名的…..下面简单总结下：</p>
<p>所以说：外部调用 eglApi.cpp#eglCreateWindowSurface() 方法时，传入 Surface 实例，内部会在 libagl 侧创建一个 父类是 egl_surface_t 的 egl_window_surface_v2_t 实例。然后会将该 egl_window_surface_v2_t 实例包在 egl侧(也就是非 libagl的)的另外一个 egl_surface_t 实例中返回出来，也就是最终的EGLSurface 了。 图省事我就不画图了。</p>
<h3 id="eglCreateContext"><a href="#eglCreateContext" class="headerlink" title="eglCreateContext"></a>eglCreateContext</h3><p>创建  EGLContext 对象实例。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/eglApi.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLContext <span class="title">eglCreateContext</span><span class="params">(EGLDisplay dpy, EGLConfig config, EGLContext share_list,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> EGLint* attrib_list)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">clearError</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">egl_connection_t</span>* <span class="type">const</span> cnx = &amp;gEGLImpl;</span><br><span class="line">    <span class="keyword">return</span> cnx-&gt;platform.<span class="built_in">eglCreateContext</span>(dpy, config, share_list, attrib_list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_platform_entries.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLContext <span class="title">eglCreateContextImpl</span><span class="params">(EGLDisplay dpy, EGLConfig config,</span></span></span><br><span class="line"><span class="params"><span class="function">                                EGLContext share_list, <span class="type">const</span> EGLint *attrib_list)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">egl_connection_t</span>* cnx = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">// 这里面其实就是先验证 display 是否合法，以及全局的 gEGLImpl 是否已完成驱动加载</span></span><br><span class="line">    <span class="type">const</span> egl_display_ptr dp = <span class="built_in">validate_display_connection</span>(dpy, cnx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dp) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 默认都是当做 EGL_NO_CONTEXT ，share_list 是可以线程间共享的 Context</span></span><br><span class="line"><span class="comment">         * 这里先不考虑</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (share_list != EGL_NO_CONTEXT) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">ContextRef</span>(dp.<span class="built_in">get</span>(), share_list).<span class="built_in">get</span>()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_CONTEXT, EGL_NO_CONTEXT);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">egl_context_t</span>* <span class="type">const</span> c = <span class="built_in">get_context</span>(share_list);</span><br><span class="line">            share_list = c-&gt;context;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查传入的属性是否符合当前版本</span></span><br><span class="line">        <span class="keyword">if</span> (attrib_list &amp;&amp; (cnx-&gt;driverVersion &lt; <span class="built_in">EGL_MAKE_VERSION</span>(<span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>))) &#123;</span><br><span class="line">            <span class="type">const</span> EGLint* attrib_ptr = attrib_list;</span><br><span class="line">            <span class="keyword">while</span> (*attrib_ptr != EGL_NONE) &#123;</span><br><span class="line">                GLint attr = *attrib_ptr++;</span><br><span class="line">                GLint value = *attrib_ptr++;</span><br><span class="line">                <span class="keyword">if</span> (attr == EGL_CONTEXT_OPENGL_RESET_NOTIFICATION_STRATEGY_KHR) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_ATTRIBUTE, EGL_NO_CONTEXT);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用到 libagl 那边，返回了一个 ogles_context_t  实例</span></span><br><span class="line">        EGLContext context = cnx-&gt;egl.<span class="built_in">eglCreateContext</span>(dp-&gt;disp.dpy, config, share_list, attrib_list);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 返回的 context 合法，</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (context != EGL_NO_CONTEXT) &#123;</span><br><span class="line">            <span class="type">int</span> version = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 从入参 config 中查找其设置的 GLES的版本，即是 GLESv1 还是 GLESv2</span></span><br><span class="line"><span class="comment">             * 一般情况不指定 attrib_list ，此时使用的是 GLESv1</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (attrib_list) &#123;</span><br><span class="line">                <span class="keyword">while</span> (*attrib_list != EGL_NONE) &#123;</span><br><span class="line">                    GLint attr = *attrib_list++;</span><br><span class="line">                    GLint value = *attrib_list++;</span><br><span class="line">                    <span class="keyword">if</span> (attr == EGL_CONTEXT_CLIENT_VERSION) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (value == <span class="number">1</span>) &#123;</span><br><span class="line">                            version = <span class="type">egl_connection_t</span>::GLESv1_INDEX;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value == <span class="number">2</span> || value == <span class="number">3</span>) &#123;</span><br><span class="line">                            version = <span class="type">egl_connection_t</span>::GLESv2_INDEX;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 然后将返回的 ogles_context_t ，以及 version 这些包装成 egl_context_t 返回出去</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">egl_context_t</span>* c = <span class="keyword">new</span> <span class="built_in">egl_context_t</span>(dpy, context, config, cnx, version);</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> EGL_NO_CONTEXT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的，还是从 eglApi.cpp 开始，到 egl_platform_entries.cpp 中。</p>
<p>eglCreateContextImpl()方法中实际逻辑比较简单，先做一些参数校验。接着调用 cnx-&gt;egl.eglCreateContext() 来完成剩余的工作。</p>
<p>这个方法也就调用到了 libagl 那边：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libagl/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLContext <span class="title">eglCreateContext</span><span class="params">(EGLDisplay dpy, EGLConfig config,</span></span></span><br><span class="line"><span class="params"><span class="function">                            EGLContext <span class="comment">/*share_list*/</span>, <span class="type">const</span> EGLint* <span class="comment">/*attrib_list*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 判断该 dpy 是否合法，其实就是判断它对应的索引是否超限</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="type">egl_display_t</span>::<span class="built_in">is_valid</span>(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_DISPLAY, EGL_NO_SURFACE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分配内存并初始化一个 ogles_context_t 对象，入参额外要分配的内存大小</span></span><br><span class="line"><span class="comment">     * 即内部不止为 ogles_context_t 分配空间，额外还要为 egl_context_t 分配空间</span></span><br><span class="line"><span class="comment">     * 然后在内部使用 gl-&gt;rasterizer.base 指向这个 egl_context_t 地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">ogles_context_t</span>* gl = <span class="built_in">ogles_init</span>(<span class="built_in">sizeof</span>(<span class="type">egl_context_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (!gl) <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_ALLOC, EGL_NO_CONTEXT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到 ogles_context_t 里面的 context_t 中的  base ，将其当做 egl_context_t 来使用</span></span><br><span class="line">    <span class="type">egl_context_t</span>* c = <span class="built_in">static_cast</span>&lt;<span class="type">egl_context_t</span>*&gt;(gl-&gt;rasterizer.base);</span><br><span class="line">    <span class="comment">// 给 egl_context_t 对象实例中字段赋值，将其保存起来</span></span><br><span class="line">    c-&gt;flags = <span class="type">egl_context_t</span>::NEVER_CURRENT;</span><br><span class="line">    c-&gt;dpy = dpy;</span><br><span class="line">    c-&gt;config = config;</span><br><span class="line">    c-&gt;read = <span class="number">0</span>;</span><br><span class="line">    c-&gt;draw = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// EGLContext 是 void * ，所以这里就是将 ogles_context_t 返回出去而已</span></span><br><span class="line">    <span class="keyword">return</span> (EGLContext)gl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libagl/state.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">ogles_context_t</span> *<span class="title">ogles_init</span><span class="params">(<span class="type">size_t</span> extra)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分配内存，大小为 extra也就是 egl_context_t 结构体，加上 ogles_context_t 结构体，额外再加 32 个字节</span></span><br><span class="line"><span class="comment">     * 所以最终分配的内存中：前面存储 egl_context_t ，中间存储 ogles_context_t ，最后加32字节</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">void</span>* <span class="type">const</span> base = <span class="built_in">malloc</span>(extra + <span class="built_in">sizeof</span>(<span class="type">ogles_context_t</span>) + <span class="number">32</span>);</span><br><span class="line">    <span class="keyword">if</span> (!base) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取出属于 ogles_context_t 的内存地址</span></span><br><span class="line">    <span class="type">ogles_context_t</span> *c =(<span class="type">ogles_context_t</span> *)((<span class="built_in">ptrdiff_t</span>(base) + extra + <span class="number">31</span>) &amp; ~<span class="number">0x1F</span>L);</span><br><span class="line">    <span class="comment">// 将 ogles_context_t 中都赋值为 0</span></span><br><span class="line">    <span class="built_in">memset</span>(c, <span class="number">0</span>, <span class="built_in">sizeof</span>(<span class="type">ogles_context_t</span>));</span><br><span class="line">    <span class="comment">// 初始化 ogles_context_t-&gt;rasterizer</span></span><br><span class="line">    <span class="built_in">ggl_init_context</span>(&amp;(c-&gt;rasterizer));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 Surface 的管理器</span></span><br><span class="line">    <span class="function">sp&lt;EGLSurfaceManager&gt; <span class="title">smgr</span><span class="params">(<span class="keyword">new</span> EGLSurfaceManager())</span></span>;</span><br><span class="line">    c-&gt;surfaceManager = smgr.<span class="built_in">get</span>();</span><br><span class="line">    c-&gt;surfaceManager-&gt;<span class="built_in">incStrong</span>(c);</span><br><span class="line"></span><br><span class="line">    <span class="function">sp&lt;EGLBufferObjectManager&gt; <span class="title">bomgr</span><span class="params">(<span class="keyword">new</span> EGLBufferObjectManager())</span></span>;</span><br><span class="line">    c-&gt;bufferObjectManager = bomgr.<span class="built_in">get</span>();</span><br><span class="line">    c-&gt;bufferObjectManager-&gt;<span class="built_in">incStrong</span>(c);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 ogles_context_t.array</span></span><br><span class="line">    <span class="built_in">ogles_init_array</span>(c);</span><br><span class="line">    <span class="comment">// 初始化 ogles_context_t.transforms</span></span><br><span class="line">    <span class="built_in">ogles_init_matrix</span>(c);</span><br><span class="line">    <span class="comment">// 初始化 ogles_context_t.cull 和 ogles_context_t.current</span></span><br><span class="line">    <span class="built_in">ogles_init_vertex</span>(c);</span><br><span class="line">    <span class="built_in">ogles_init_light</span>(c);</span><br><span class="line">    <span class="built_in">ogles_init_texture</span>(c);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ogles_context_t-&gt;rasterizer.base 指向开头的地址，也就是 egl_context_t 的开头</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    c-&gt;rasterizer.base = base;</span><br><span class="line">    c-&gt;point.size = TRI_ONE;</span><br><span class="line">    c-&gt;line.width = TRI_ONE;</span><br><span class="line"></span><br><span class="line">    c-&gt;rasterizer.procs.<span class="built_in">depthMask</span>(c, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    c-&gt;rasterizer.procs.<span class="built_in">enable</span>(c, GL_DITHER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 libagl 这边，会通过调用 ogles_init() 方法来申请并初始化一个 ogles_context_t 实例。</p>
<p>在申请内存时，申请的大小是：extra + sizeof(ogles_context_t) + 32 。这里的extra &#x3D; sizeof(egl_context_t) 。也就是说分配了三段连在一起的内存，第一段是用来存储 egl_context_t 的，第二段是用来存储 ogles_context_t 的，第三段是固定的32个字节长度。</p>
<p>申请完内存之后，会在 ogles_init() 方法中初始化中间的 ogles_context_t ，其中最重要的一步是：将其内部的 rasterizer.base 属性指向了内存地址开头，也就是egl_context_t 的开始地址，后续可以通过访问 rasterizer.base 属性来访问这个 egl_context_t 中的内容。</p>
<p>ogles_init() 方法执行完毕后，回到 eglCreateContext() 方法内，会给 rasterizer.base 属性，也就是 egl_context_t 内存来赋值。赋值时，主要将传进来的 dpy 和 config 做了保存，并将其 flags 置为 egl_context_t::NEVER_CURRENT 。</p>
<p>最后会返回这个 ogles_context_t 实例，所以外部拿到的EGLContext 返回值其实就是 ogles_context_t 实例。</p>
<p>下面简单贴一下这两个类型的定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libagl/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">egl_context_t</span> &#123;</span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        IS_CURRENT      =   <span class="number">0x00010000</span>,</span><br><span class="line">        NEVER_CURRENT   =   <span class="number">0x00020000</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * eglApi.cpp#eglCreateContext()</span></span><br><span class="line"><span class="comment">     *  - egl_platform_entries.cpp#eglCreateContextImpl()</span></span><br><span class="line"><span class="comment">     *    - egl.cpp#eglCreateContext()</span></span><br><span class="line"><span class="comment">     * 也就是在 eglCreateContext 中会给该 flag 赋值为 NEVER_CURRENT</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 而等到后面 </span></span><br><span class="line"><span class="comment">     * eglApi.cpp#eglMakeCurrent()</span></span><br><span class="line"><span class="comment">     *  - egl_platform_entries.cpp#eglMakeCurrentImpl()</span></span><br><span class="line"><span class="comment">     *    - egl.cpp#eglMakeCurrent()</span></span><br><span class="line"><span class="comment">     * 中会将该 flag 置为 egl_context_t::IS_CURRENT ,表示它被绑定到当前线程了</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 下面的 dpy 、 config 是一起的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">uint32_t</span>            flags;</span><br><span class="line">    EGLDisplay          dpy;</span><br><span class="line">    EGLConfig           config;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对应的 Surface ，在 egl::eglMakeCurrent 中会赋值为其的入参</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EGLSurface          read;</span><br><span class="line">    EGLSurface          draw;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从 EGLContext 中取出 egl_context_t</span></span><br><span class="line"><span class="comment">     * EGLContext 其实就是 ogles_context_t ，然后取出 ogles_context_t 中的 rasterizer 中的 base</span></span><br><span class="line"><span class="comment">     * 因为 base 指向的就是一个 ogles_context_t</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">egl_context_t</span>* <span class="title">context</span><span class="params">(EGLContext ctx)</span> </span>&#123;</span><br><span class="line">        <span class="type">ogles_context_t</span>* <span class="type">const</span> gl = <span class="built_in">static_cast</span>&lt;<span class="type">ogles_context_t</span>*&gt;(ctx);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;<span class="type">egl_context_t</span>*&gt;(gl-&gt;rasterizer.base);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libagl/state.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">ogles_context_t</span> *<span class="title">ogles_init</span><span class="params">(<span class="type">size_t</span> extra)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分配内存，大小为 extra也就是 egl_context_t 结构体，加上 ogles_context_t 结构体，额外再加 32 个字节</span></span><br><span class="line"><span class="comment">     * 所以最终分配的内存中：前面存储 egl_context_t ，中间存储 ogles_context_t ，最后加32字节</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">void</span>* <span class="type">const</span> base = <span class="built_in">malloc</span>(extra + <span class="built_in">sizeof</span>(<span class="type">ogles_context_t</span>) + <span class="number">32</span>);</span><br><span class="line">    <span class="keyword">if</span> (!base) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取出属于 ogles_context_t 的内存地址</span></span><br><span class="line">    <span class="type">ogles_context_t</span> *c =(<span class="type">ogles_context_t</span> *)((<span class="built_in">ptrdiff_t</span>(base) + extra + <span class="number">31</span>) &amp; ~<span class="number">0x1F</span>L);</span><br><span class="line">    <span class="comment">// 将 ogles_context_t 中都赋值为 0</span></span><br><span class="line">    <span class="built_in">memset</span>(c, <span class="number">0</span>, <span class="built_in">sizeof</span>(<span class="type">ogles_context_t</span>));</span><br><span class="line">    <span class="comment">// 初始化 ogles_context_t-&gt;rasterizer</span></span><br><span class="line">    <span class="built_in">ggl_init_context</span>(&amp;(c-&gt;rasterizer));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 Surface 的管理器</span></span><br><span class="line">    <span class="function">sp&lt;EGLSurfaceManager&gt; <span class="title">smgr</span><span class="params">(<span class="keyword">new</span> EGLSurfaceManager())</span></span>;</span><br><span class="line">    c-&gt;surfaceManager = smgr.<span class="built_in">get</span>();</span><br><span class="line">    c-&gt;surfaceManager-&gt;<span class="built_in">incStrong</span>(c);</span><br><span class="line"></span><br><span class="line">    <span class="function">sp&lt;EGLBufferObjectManager&gt; <span class="title">bomgr</span><span class="params">(<span class="keyword">new</span> EGLBufferObjectManager())</span></span>;</span><br><span class="line">    c-&gt;bufferObjectManager = bomgr.<span class="built_in">get</span>();</span><br><span class="line">    c-&gt;bufferObjectManager-&gt;<span class="built_in">incStrong</span>(c);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 ogles_context_t.array</span></span><br><span class="line">    <span class="built_in">ogles_init_array</span>(c);</span><br><span class="line">    <span class="comment">// 初始化 ogles_context_t.transforms</span></span><br><span class="line">    <span class="built_in">ogles_init_matrix</span>(c);</span><br><span class="line">    <span class="comment">// 初始化 ogles_context_t.cull 和 ogles_context_t.current</span></span><br><span class="line">    <span class="built_in">ogles_init_vertex</span>(c);</span><br><span class="line">    <span class="built_in">ogles_init_light</span>(c);</span><br><span class="line">    <span class="built_in">ogles_init_texture</span>(c);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ogles_context_t-&gt;rasterizer.base 指向开头的地址，也就是 egl_context_t 的开头</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    c-&gt;rasterizer.base = base;</span><br><span class="line">    c-&gt;point.size = TRI_ONE;</span><br><span class="line">    c-&gt;line.width = TRI_ONE;</span><br><span class="line"></span><br><span class="line">    c-&gt;rasterizer.procs.<span class="built_in">depthMask</span>(c, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    c-&gt;rasterizer.procs.<span class="built_in">enable</span>(c, GL_DITHER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到 egl_platform_entries.cpp 中，拿到返回的 EGLContext ，也就是返回的 ogles_context_t 实例之后，会将入参和它一起又封装到另外一个 egl_context_t 实例中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_object.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">egl_context_t</span>: <span class="keyword">public</span> <span class="type">egl_object_t</span> &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    ~<span class="built_in">egl_context_t</span>() &#123;&#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> <span class="type">egl_object_t</span>::LocalRef&lt;<span class="type">egl_context_t</span>, EGLContext&gt; Ref;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">egl_context_t</span>(EGLDisplay dpy, EGLContext context, EGLConfig config,</span><br><span class="line">            <span class="type">egl_connection_t</span> <span class="type">const</span>* cnx, <span class="type">int</span> version);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onLooseCurrent</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onMakeCurrent</span><span class="params">(EGLSurface draw, EGLSurface read)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下面几个参数统一都在：</span></span><br><span class="line"><span class="comment">     * eglApi.cpp#eglCreateContext()</span></span><br><span class="line"><span class="comment">     *  - egl_platform_entries.cpp#eglCreateContextImpl()</span></span><br><span class="line"><span class="comment">     * 中创建和初始化</span></span><br><span class="line"><span class="comment">     * 这个 dpy 其实就是个索引 ，而其父类 egl_object_t 中的 display 就是该 dpy 对应的 egl_display_t</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EGLDisplay dpy;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存的是通过 agl 模块的 egl.eglCreateContext 方法创建返回的 ogles_context_t 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EGLContext context;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用 eglApi.cpp#eglCreateContext() 方法是传入的参数 config</span></span><br><span class="line"><span class="comment">     * 也就是之前通过 chooseConfig 拿到的合适的 config</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EGLConfig config;</span><br><span class="line">    EGLSurface read;</span><br><span class="line">    EGLSurface draw;</span><br><span class="line">    <span class="type">egl_connection_t</span> <span class="type">const</span>* cnx;</span><br><span class="line">    <span class="type">int</span> version;</span><br><span class="line">    std::string gl_extensions;</span><br><span class="line">    std::vector&lt;std::string&gt; tokenized_gl_extensions;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>z这里又蹦出来个 egl_context_t ，注意把它和前面刚提到的 libagl 中的 egl_context_t 做区分，别产生混淆。这里的 egl_context_t 是属于 egl (也就是非 libagl )中的。</p>
<p>而这个 egl_context_t 它也是继承自 egl_object_t 的，跟前面讲过的 egl(也就是非 libagl )中的 egl_surface_t 类似。</p>
<blockquote>
<p>所以，上面 eglCreateWindowSurface() 方法中的 egl_surface_t 在 libagl 和 egl (也就是非 libagl ) 都各有一份；同时当前方法中的  egl_context_t 也是类似，有两份。所以可以对比着做区分。</p>
</blockquote>
<p>最终 eglCreateContext() 方法返回这个EGLContext 实际对应的是 egl (也就是非 libagl )中的 egl_context_t 实例。这边 egl_context_t 实例内部存储着来自libagl 那边返回的 ogles_context_t 实例。</p>
<h3 id="eglQuerySurface"><a href="#eglQuerySurface" class="headerlink" title="eglQuerySurface"></a>eglQuerySurface</h3><p>通过该方法可以查询对应 EGLSurface 中的属性。</p>
<p>接下来看源码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/eglApi.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglQuerySurface</span><span class="params">(EGLDisplay dpy, EGLSurface surface, EGLint attribute, EGLint* value)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">clearError</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">egl_connection_t</span>* <span class="type">const</span> cnx = &amp;gEGLImpl;</span><br><span class="line">    <span class="keyword">return</span> cnx-&gt;platform.<span class="built_in">eglQuerySurface</span>(dpy, surface, attribute, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_platform_entries.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglQuerySurfaceImpl</span><span class="params">(EGLDisplay dpy, EGLSurface surface, EGLint attribute,</span></span></span><br><span class="line"><span class="params"><span class="function">                               EGLint* value)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> egl_display_ptr dp = <span class="built_in">validate_display</span>(dpy);</span><br><span class="line">    <span class="keyword">if</span> (!dp) <span class="keyword">return</span> EGL_FALSE;</span><br><span class="line"></span><br><span class="line">    SurfaceRef _s(dp.<span class="built_in">get</span>(), surface);</span><br><span class="line">    <span class="keyword">if</span> (!_s.<span class="built_in">get</span>()) <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_SURFACE, (EGLBoolean)EGL_FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把 EGLSurface 转成它实际的类型，也就是 egl_surface_t</span></span><br><span class="line">    <span class="type">egl_surface_t</span> <span class="type">const</span>* <span class="type">const</span> s = <span class="built_in">get_surface</span>(surface);</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;<span class="built_in">getColorSpaceAttribute</span>(attribute, value)) &#123;</span><br><span class="line">        <span class="keyword">return</span> EGL_TRUE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s-&gt;<span class="built_in">getSmpte2086Attribute</span>(attribute, value)) &#123;</span><br><span class="line">        <span class="keyword">return</span> EGL_TRUE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s-&gt;<span class="built_in">getCta8613Attribute</span>(attribute, value)) &#123;</span><br><span class="line">        <span class="keyword">return</span> EGL_TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用到 libagl 那边</span></span><br><span class="line">    <span class="keyword">return</span> s-&gt;cnx-&gt;egl.<span class="built_in">eglQuerySurface</span>(dp-&gt;disp.dpy, s-&gt;surface, attribute, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果懂了之前的 eglCreateWindowSurface() 方法的话，就不难理解这里为啥把入参 EGLSurface 转成 egl_surface_t 了吧。</p>
<p>接下来调用 cnx-&gt;egl.eglQuerySurface() 方法去 libagl 那边执行剩余逻辑，</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libagl/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglQuerySurface</span><span class="params">( EGLDisplay dpy, EGLSurface eglSurface,</span></span></span><br><span class="line"><span class="params"><span class="function">                            EGLint attribute, EGLint *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="type">egl_display_t</span>::<span class="built_in">is_valid</span>(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_DISPLAY, EGL_FALSE);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将其转为 egl_surface_t ，不能直接转为 egl_window_surface_v2_t </span></span><br><span class="line"><span class="comment">     *  因为 egl_surface_t 有多种子类，egl_window_surface_v2_t 这是其中一种实现</span></span><br><span class="line"><span class="comment">     * 万一是通过其他  createXXXX 方法创建的 EGLSurface 呢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">egl_surface_t</span>* surface = <span class="built_in">static_cast</span>&lt;<span class="type">egl_surface_t</span>*&gt;(eglSurface);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!surface-&gt;<span class="built_in">isValid</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_SURFACE, EGL_FALSE);</span><br><span class="line">    <span class="keyword">if</span> (surface-&gt;dpy != dpy)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_DISPLAY, EGL_FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接下来就是调用对应方法拿到对应的属性了 </span></span><br><span class="line">    EGLBoolean ret = EGL_TRUE;</span><br><span class="line">    <span class="keyword">switch</span> (attribute) &#123;</span><br><span class="line">        <span class="keyword">case</span> EGL_CONFIG_ID:</span><br><span class="line">            ret = <span class="built_in">getConfigAttrib</span>(dpy, surface-&gt;config, EGL_CONFIG_ID, value);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_WIDTH:</span><br><span class="line">            *value = surface-&gt;<span class="built_in">getWidth</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_HEIGHT:</span><br><span class="line">            *value = surface-&gt;<span class="built_in">getHeight</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_LARGEST_PBUFFER:</span><br><span class="line">            <span class="comment">// not modified for a window or pixmap surface</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_TEXTURE_FORMAT:</span><br><span class="line">            *value = EGL_NO_TEXTURE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_TEXTURE_TARGET:</span><br><span class="line">            *value = EGL_NO_TEXTURE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_MIPMAP_TEXTURE:</span><br><span class="line">            *value = EGL_FALSE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_MIPMAP_LEVEL:</span><br><span class="line">            *value = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_RENDER_BUFFER:</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> return the real RENDER_BUFFER here</span></span><br><span class="line">            *value = EGL_BACK_BUFFER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_HORIZONTAL_RESOLUTION:</span><br><span class="line">            <span class="comment">// pixel/mm * EGL_DISPLAY_SCALING</span></span><br><span class="line">            *value = surface-&gt;<span class="built_in">getHorizontalResolution</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_VERTICAL_RESOLUTION:</span><br><span class="line">            <span class="comment">// pixel/mm * EGL_DISPLAY_SCALING</span></span><br><span class="line">            *value = surface-&gt;<span class="built_in">getVerticalResolution</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_PIXEL_ASPECT_RATIO: &#123;</span><br><span class="line">            <span class="comment">// w/h * EGL_DISPLAY_SCALING</span></span><br><span class="line">            <span class="type">int</span> wr = surface-&gt;<span class="built_in">getHorizontalResolution</span>();</span><br><span class="line">            <span class="type">int</span> hr = surface-&gt;<span class="built_in">getVerticalResolution</span>();</span><br><span class="line">            *value = (wr * EGL_DISPLAY_SCALING) / hr;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EGL_SWAP_BEHAVIOR:</span><br><span class="line">            *value = surface-&gt;<span class="built_in">getSwapBehavior</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ret = <span class="built_in">setError</span>(EGL_BAD_ATTRIBUTE, EGL_FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意这里传入了 egl_surface_t.surface 属性：如果前面的 eglApi.cpp#eglQuerySurface() 方法调用时，传入的 EGLSurface 实例是之前通过 eglCreateWindowSurface() 方法中创建的，那么它实际对应的是来自 libagl 的egl_window_surface_v2_t 实例。但是还有其他方法来创建 EGLSurface，比如 eglCreatePbufferSurface() 等，此时返回的就是其他子类实现了。</p>
<p>所以说这里不能直接转 egl_window_surface_v2_t ，只是转成父类 egl_surface_t ，然后调用其内部不同方法，面向接口编程了。</p>
<p>比如对于 case EGL_WIDTH 来说，调用其 getWidth() 方法返回宽度，而 egl_window_surface_v2_t 中对该方法的实现是直接返回内部的 width ，而这个属性在一开始就被赋值了的。</p>
<p>剩余逻辑详见下文： <a href="4446cd65.html">GLES&amp;EGL-EGL-03</a> </p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/AndroidFrameworks/">AndroidFrameworks</a>
		  
			<a href="/tags/OpenGLES/">OpenGLES</a>
		  
			<a href="/tags/EGL/">EGL</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/4446cd65.html">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">GLES&EGL-EGL-03</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/aa48ac49.html">
        <span class="next-text nav-default">GLES&EGL-EGL-01</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2020 -
    
    2023
    <span class="footer-author">咔咔咔.</span>
    <span class="power-by">
        由 <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> and <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a> 强力驱动
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
