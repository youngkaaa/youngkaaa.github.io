<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Binder - Java Framework"/>




  <meta name="keywords" content="Binder," />





  <link rel="alternate" href="/default" title="咔咔咔" >




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://youngkaaa.github.io/2af50710.html"/>


<meta name="description" content="对于Android开发者来说，常使用 Binder 的方式就是通过编写 AIDL 文件，从而自动编译生成对应的类文件，最终只需要继承该类即可完成一个Binder service 的编写。 示例比如编写一个简单的 aidl 文件： 12345interface IRemoteService &amp;#123;    void start();    void stop();&amp;#125;  然后编译会生成相">
<meta property="og:type" content="article">
<meta property="og:title" content="Binder - Java Framework">
<meta property="og:url" content="https://youngkaaa.github.io/2af50710.html">
<meta property="og:site_name" content="咔咔咔">
<meta property="og:description" content="对于Android开发者来说，常使用 Binder 的方式就是通过编写 AIDL 文件，从而自动编译生成对应的类文件，最终只需要继承该类即可完成一个Binder service 的编写。 示例比如编写一个简单的 aidl 文件： 12345interface IRemoteService &amp;#123;    void start();    void stop();&amp;#125;  然后编译会生成相">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-06-10T02:48:56.000Z">
<meta property="article:modified_time" content="2022-12-27T13:16:27.649Z">
<meta property="article:author" content="咔咔咔">
<meta property="article:tag" content="Binder">
<meta name="twitter:card" content="summary">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Binder - Java Framework - 咔咔咔 </title>
  <meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">咔咔咔</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Binder - Java Framework
        
      </h1>

      <time class="post-time">
          6月 10 2022
      </time>
    </header>



    
            <div class="post-content">
            <p>对于Android开发者来说，常使用 Binder 的方式就是通过编写 AIDL 文件，从而自动编译生成对应的类文件，最终只需要继承该类即可完成一个Binder service 的编写。</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>比如编写一个简单的 aidl 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IRemoteService</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后编译会生成相关的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRemoteService</span> <span class="keyword">extends</span> <span class="title class_">android</span>.os.IInterface &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Local-side IPC implementation stub class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Stub</span> <span class="keyword">extends</span> <span class="title class_">android</span>.os.Binder <span class="keyword">implements</span> <span class="title class_">com</span>.baidu.baidutranslate.media.service.IRemoteService &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.<span class="type">String</span> <span class="variable">DESCRIPTOR</span> <span class="operator">=</span> <span class="string">&quot;com.baidu.baidutranslate.media.service.IRemoteService&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Construct the stub at attach it to the interface.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Stub</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.attachInterface(<span class="built_in">this</span>, DESCRIPTOR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Cast an IBinder object into an com.baidu.baidutranslate.media.service.IRemoteService interface,</span></span><br><span class="line"><span class="comment">         * generating a proxy if needed.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> com.baidu.baidutranslate.media.service.IRemoteService <span class="title function_">asInterface</span><span class="params">(android.os.IBinder obj)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((obj == <span class="literal">null</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            android.os.<span class="type">IInterface</span> <span class="variable">iin</span> <span class="operator">=</span> obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line">            <span class="keyword">if</span> (((iin != <span class="literal">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> com.baidu.baidutranslate.media.service.IRemoteService))) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((com.baidu.baidutranslate.media.service.IRemoteService) iin);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">com</span>.baidu.baidutranslate.media.service.IRemoteService.Stub.Proxy(obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> android.os.IBinder <span class="title function_">asBinder</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTransact</span><span class="params">(<span class="type">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="type">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException &#123;</span><br><span class="line">            java.lang.<span class="type">String</span> <span class="variable">descriptor</span> <span class="operator">=</span> DESCRIPTOR;</span><br><span class="line">            <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">                <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</span><br><span class="line">                    reply.writeString(descriptor);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> TRANSACTION_start: &#123;</span><br><span class="line">                    data.enforceInterface(descriptor);</span><br><span class="line">                    <span class="built_in">this</span>.start();</span><br><span class="line">                    reply.writeNoException();</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> TRANSACTION_stop: &#123;</span><br><span class="line">                    data.enforceInterface(descriptor);</span><br><span class="line">                    <span class="built_in">this</span>.stop();</span><br><span class="line">                    reply.writeNoException();</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">default</span>: &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Proxy</span> <span class="keyword">implements</span> <span class="title class_">com</span>.baidu.baidutranslate.media.service.IRemoteService &#123;</span><br><span class="line">            <span class="keyword">private</span> android.os.IBinder mRemote;</span><br><span class="line"></span><br><span class="line">            Proxy(android.os.IBinder remote) &#123;</span><br><span class="line">                mRemote = remote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> android.os.IBinder <span class="title function_">asBinder</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> mRemote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> java.lang.String <span class="title function_">getInterfaceDescriptor</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> DESCRIPTOR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException &#123;</span><br><span class="line">                android.os.<span class="type">Parcel</span> <span class="variable">_data</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br><span class="line">                android.os.<span class="type">Parcel</span> <span class="variable">_reply</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">                    mRemote.transact(Stub.TRANSACTION_start, _data, _reply, <span class="number">0</span>);</span><br><span class="line">                    _reply.readException();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    _reply.recycle();</span><br><span class="line">                    _data.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException &#123;</span><br><span class="line">                android.os.<span class="type">Parcel</span> <span class="variable">_data</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br><span class="line">                android.os.<span class="type">Parcel</span> <span class="variable">_reply</span> <span class="operator">=</span> android.os.Parcel.obtain();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">                    mRemote.transact(Stub.TRANSACTION_stop, _data, _reply, <span class="number">0</span>);</span><br><span class="line">                    _reply.readException();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    _reply.recycle();</span><br><span class="line">                    _data.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TRANSACTION_start</span> <span class="operator">=</span> (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TRANSACTION_stop</span> <span class="operator">=</span> (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时生成的类中类关系嵌套比较复杂，不太好一眼看出来，但是仔细分析可以其中生成的信息总结如下：</p>
<ol>
<li>生成一个定义的接口 IRemoteService ，直接继承自android.os.IInterface 接口。而生成的 IRemoteService接口中会自动有两个你定义的方法：start、stop 。</li>
<li>生成 IRemoteService.Stub 抽象类，继承自 android.os.Binder ，实现了 IRemoteService 接口。这个类一般是开发者在 Service onBind() 中返回出去给Client 端来调用的。因此可知：Server进程侧才需要继承并实现改 Stub 类。</li>
<li>生成 Proxy 类，该类是私有的，不可被外部访问，一般是通过 IRemoteService.Stub.asInterface() 方法来创建使用的。该类中存在一个额外的属性: android.os.IBinder mRemote 。</li>
</ol>
<p>如果你明白了之前的 BBinder 和 BpBinder 的话，那么就不难想到这里的 Stub 可能对应的是 BBinder ，而 Proxy 可能对应的是 BpBinder 了。但到底是不是呢？还得接着往下看。</p>
<h3 id="关键类解释"><a href="#关键类解释" class="headerlink" title="关键类解释"></a>关键类解释</h3><h4 id="android-os-IInterface"><a href="#android-os-IInterface" class="headerlink" title="android.os.IInterface"></a>android.os.IInterface</h4><p>它是一个接口，定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IInterface.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IInterface</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Retrieve the Binder object associated with this interface.</span></span><br><span class="line"><span class="comment">     * You must use this instead of a plain cast, so that proxy objects</span></span><br><span class="line"><span class="comment">     * can return the correct result.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">asBinder</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个接口一般是对应 Service 接口去继承自它，比如前面的 IRemoteService 。而对于asBinder()方法来说它的实现是不同的： Stub 类是直接返回 this，而 Proxy 类是直接返回去内部的 mRemote 属性。后续等遇到这个 asBinder 方法的调用时在看。</p>
<h4 id="android-os-IBinder"><a href="#android-os-IBinder" class="headerlink" title="android.os.IBinder"></a>android.os.IBinder</h4><p>接口类，其中包括了 transact() 等方法，在Java Framework层的Binder相关类中，基本都是实现了这个接口的。</p>
<p>而且这个接口中的定义和native层中的 IBinder.h （前面分析过）十分相似。比如其中定义的 transact() 、queryLocalInterface() 等方法，FIRST_CALL_TRANSACTION、PING_TRANSACTION 等属性，甚至其中的 DeathRecipient 接口类的定义。因此可以将 这俩放在一起理解。</p>
<h4 id="android-os-Binder"><a href="#android-os-Binder" class="headerlink" title="android.os.Binder"></a>android.os.Binder</h4><p>IBinder 接口的其中一个实现类。它的角色类似于前面讲过的 BBinder ，即是作为实体Service 方来使用的。</p>
<p>比如上面举例中的 IRemoteService.Stub 类，它继承自 android.os.Binder 类，同时实现了 IRemoteService 接口。而这个 IRemoteService.Stub 是编译时AIDL工具为我们自动生成的，开发者只需要继承自它，然后实现其中的接口方法即可。</p>
<blockquote>
<p>因为在自动生成的 IRemoteService.Stub 中，帮开发者已经实现了 onTransact() 方法，并且case by case 的处理了各个cmd，然将逻辑分散到 IRemoteService 接口中去。后续开发者在继承 IRemoteService.Stub 时只需要实现 IRemoteService 接口中的方法即可。</p>
</blockquote>
<p>在 Binder 类中，它实现了 IBinder 接口中的 transact() 方法，并将其标记为 final 禁止子类再实现。在实现其同时还增加了 onTransact() 方法，该方法为protected供子类实现，比如上面的 IRemoteService.Stub 类中对 onTransact() 的实现。</p>
<p>看到这里，是否觉得很熟悉，在native 层的 BBinder 中，也是相似的套路：实现IBinder接口，实现transact() 方法，暴露onTransact() 方法。</p>
<p>以上是类涉及方面的相似性，在类的使用上也是具有相似性的。对于 BBinder 来说，它被 Service 提供方来继承实现，比如 MediaPlayerService，（间接的）继承自 BBinder。而对于 Java Binder 类来说，它也是相似的方式，比如上面的 IRemoteService.Stub 类继承自 Binder 类，而IRemoteService.Stub类又交由Service方来实现。</p>
<p>所以说，可以将Binder.java 类理解为 Java Frameworks 层的”BBinder”。</p>
<h4 id="android-os-BinderProxy"><a href="#android-os-BinderProxy" class="headerlink" title="android.os.BinderProxy"></a>android.os.BinderProxy</h4><p>这个类跟上面的 Binder 类类似，都是继承自 IBinder 接口。</p>
<p>对于这个类，我之前甚至没听说过，因为它并没有在AIDL生成类文件中出现。</p>
<p>在 BinderProxy 类中，实现了 transact() 方法，在该方法的实现中，会通过jni调用到native层，当然这些具体逻辑后续再看。</p>
<p>另外一个，BinderProxy 类似于 native层的 BpBinder ，即作为 Client 端对于 Server端的Binder代理对象，当然BinderProxy这个类名也印证了这点。</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="android-os-ServiceManager"><a href="#android-os-ServiceManager" class="headerlink" title="android.os.ServiceManager"></a>android.os.ServiceManager</h4><p>它是java framework层的 SM 封装类。</p>
<p>在前面我们在 IServiceManager.cpp 中见到了native层中的 SM，它内部提供了defaultServiceManager() 方法来获取当前进程的单例 IServiceManager 对象，然后再调用其就可以调用其 addService() 、getService() 等方法来执行具体的操作了。</p>
<p>而在 Java Framework 层，也存在SM的角色，使用它可以进行 Java 层Binder service 的具体操作，比如注册服务。</p>
<h4 id="-1"><a href="#-1" class="headerlink" title=""></a></h4><h3 id="逻辑分析"><a href="#逻辑分析" class="headerlink" title="逻辑分析"></a>逻辑分析</h3><p>从 android.os.ServiceManager 开始讲起吧。</p>
<p>首先先介绍 Java Framework层的 SM ，它所对应的是 native 层中的 IServiceManager.cpp ，所以最好先看看之前的文章熟悉下native 层中该类的含义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.os.ServiceManager</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager sServiceManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title function_">getIServiceManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果静态变量已经初始化过了，那就直接返回吧</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (sServiceManager != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sServiceManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 否则调用 ServiceManagerNative.asInterface 方法来初始化，</span></span><br><span class="line"><span class="comment">     * BinderInternal.getContextObject : 会调用native方法返回 BpBinder(0) 对应的 BinderProxy 实例并返回</span></span><br><span class="line"><span class="comment">     * Binder.allowBlocking : 如果是 BinderProxy 的话修改内部的 mWarnOnBlocking 属性值为 false</span></span><br><span class="line"><span class="comment">     * ServiceManagerNative.asInterface : 将 BinderProxy 包装成 ServiceManagerProxy (实现了 IServiceManager 接口)实例返回</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 所以说这里的 sServiceManager 实际指向的是 ServiceManagerProxy 实例，内部包装了 BinderProxy ，而 BinderProxy 内部mNativeData保存了底层的 BpBinder(0) 实例</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * ServiceManagerProxy 位于 ServiceManagerNative.java 文件中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// Find the service manager</span></span><br><span class="line">    sServiceManager = ServiceManagerNative</span><br><span class="line">            .asInterface(Binder.allowBlocking(BinderInternal.getContextObject()));</span><br><span class="line">    <span class="keyword">return</span> sServiceManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，sServiceManager 是静态的，在 getIServiceManager() 方法中为其创建对象实例并赋值。</p>
<p>在创建对象时，跟native层差不多，也是分为好几步的。</p>
<p>1、首先通过BinderInternal.getContextObject() 方法来创建一个 BinderProxy() 类实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.android.internal.os.BinderInternal.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the global &quot;context object&quot; of the system.  This is usually</span></span><br><span class="line"><span class="comment"> * an implementation of IServiceManager, which you can use to find</span></span><br><span class="line"><span class="comment"> * other services.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 执行到 android_util_Binder.cpp 文件中的 android_os_BinderInternal_getContextObject() 方法内</span></span><br><span class="line"><span class="comment"> * native 中会获取 BpBinder(0) 对应的 BinderProxy 实例并返回</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">native</span> IBinder <span class="title function_">getContextObject</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>接着到 android_util_Binder.cpp 中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> jobject <span class="title">android_os_BinderInternal_getContextObject</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回一个 BpBinder(0) 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    sp&lt;IBinder&gt; b = ProcessState::<span class="built_in">self</span>()-&gt;<span class="built_in">getContextObject</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将该 BpBinder 实例传入到上层，让其为他创建一个 BinderProxy 实例（如果不存在的话）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">javaObjectForIBinder</span>(env, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 c++层 IBinder 转换为Java层 IBinder 对象实例</span></span><br><span class="line"><span class="comment"> * val 是 JavaBBinder 时，返回其内部之前保存的Java类实例，该实例继承自Java层的Binder</span></span><br><span class="line"><span class="comment"> * val 是 BpBinder 时，为其在上层创建一个(如果是第一次需要的话) BinderProxy 实例并返回</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 这个方法和下面的 ibinderForJavaObject 可以认为是搭配使用的来进行 c++层 IBinder 和Java层 IBinder 的转换</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">jobject <span class="title">javaObjectForIBinder</span><span class="params">(JNIEnv* env, <span class="type">const</span> sp&lt;IBinder&gt;&amp; val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此时这里的入参 val 可能是：BpBinder() </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (val == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是 JavaBBinder 实例时,则取出之前保存在它内部的类实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (val-&gt;<span class="built_in">checkSubclass</span>(&amp;gBinderOffsets)) &#123;</span><br><span class="line">        <span class="comment">// It&#x27;s a JavaBBinder created by ibinderForJavaObject. Already has Java object.</span></span><br><span class="line">        jobject object = <span class="built_in">static_cast</span>&lt;JavaBBinder*&gt;(val.<span class="built_in">get</span>())-&gt;<span class="built_in">object</span>();</span><br><span class="line">        <span class="built_in">LOGDEATH</span>(<span class="string">&quot;objectForBinder %p: it&#x27;s our own %p!\n&quot;</span>, val.<span class="built_in">get</span>(), object);</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 先将 BpBinder 再包装一层到 BinderProxyNativeData 中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    BinderProxyNativeData* nativeData = <span class="keyword">new</span> <span class="built_in">BinderProxyNativeData</span>();</span><br><span class="line">    nativeData-&gt;mOrgue = <span class="keyword">new</span> DeathRecipientList;</span><br><span class="line">    nativeData-&gt;mObject = val;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 然后调用 Java BinderProxy 类中的 getInstance() 方法，将 nativeData 和 BpBinder 指针 传入进去</span></span><br><span class="line"><span class="comment">     * 在 BinderProxy#getInstance 方法内会检查当前进程是否缓存过该 val 对应的 BinderProxy实例，没有的话则创建一个返回</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 这里的 object 就是 BinderProxy 实例，内部包装了入参 nativeData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    jobject object = env-&gt;<span class="built_in">CallStaticObjectMethod</span>(gBinderProxyOffsets.mClass,</span><br><span class="line">            gBinderProxyOffsets.mGetInstance, (jlong) nativeData, (jlong) val.<span class="built_in">get</span>());</span><br><span class="line">    <span class="keyword">if</span> (env-&gt;<span class="built_in">ExceptionCheck</span>()) &#123;</span><br><span class="line">        <span class="comment">// In the exception case, getInstance still took ownership of nativeData.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取出该 BinderProxy 内部的 mNativeData 属性的值，也就是之前设置进去的 BinderProxyNativeData 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    BinderProxyNativeData* actualNativeData = <span class="built_in">getBPNativeData</span>(env, object);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 由于上面 nativeData 是本次新创建的 BinderProxyNativeData 实例，所以其地址一定是新的</span></span><br><span class="line"><span class="comment">     * 而 actualNativeData 是从上层获取到的 val 所对应的 BinderProxy 实例中包着的 BinderProxyNativeData 实例</span></span><br><span class="line"><span class="comment">     * 所以说 actualNativeData 如果和 nativeData 一样的话，表示刚才 getInstance 方法在Java层是新创建的 BinderProxy实例</span></span><br><span class="line"><span class="comment">     * 此时需要自增 gNumProxies 计数。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (actualNativeData == nativeData) &#123;</span><br><span class="line">        <span class="comment">// Created a new Proxy</span></span><br><span class="line">        <span class="type">uint32_t</span> numProxies = gNumProxies.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        <span class="type">uint32_t</span> numLastWarned = gProxiesWarned.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> (numProxies &gt;= numLastWarned + PROXY_WARN_INTERVAL) &#123;</span><br><span class="line">            <span class="comment">// Multiple threads can get here, make sure only one of them gets to</span></span><br><span class="line">            <span class="comment">// update the warn counter.</span></span><br><span class="line">            <span class="keyword">if</span> (gProxiesWarned.<span class="built_in">compare_exchange_strong</span>(numLastWarned,</span><br><span class="line">                        numLastWarned + PROXY_WARN_INTERVAL, std::memory_order_relaxed)) &#123;</span><br><span class="line">                <span class="built_in">ALOGW</span>(<span class="string">&quot;Unexpectedly many live BinderProxies: %d\n&quot;</span>, numProxies);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span> nativeData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里分为两步：</p>
<p>1）先通过 ProcessState::getContextObject() 方法来获取 BpBinder(0) ，也就是当前进程中 handle&#x3D;0 的 BpBinder 实例，handle&#x3D;0它代表的就是 SM 实例。</p>
<p>这个在前面讲过了。</p>
<p>2）调用 javaObjectForIBinder() 方法，来将这个native 层的 BpBinder 实例转换为对应的Java层 BinderProxy 实例。</p>
<blockquote>
<p>但其实 javaObjectForIBinder() 方法更准确的作用是将 native层的 IBinder 实例，转换为Java层的IBinder 实例，比如BpBinder 转换为 BinderProxy；BBinder(这里更准确的是 JavaBBinder，它继承自 BBinder)转换为Binder；</p>
</blockquote>
<p>在将 JavaBBinder 转换为 Binder 实例时，是比较简单的，因为JavaBBinder.mObject 属性保存的就是 Java 层Binder 实例，这点在后面就知道了。</p>
<p>而在将 BpBinder 转换为 BinderProxy 实例时，兜兜转转的还是比较麻烦的。会将其先封装到 BinderProxyNativeData 实例中，然后调用 BinderProxy类的静态方法 getInstance() 方法，来将这个 包装了 BinderProxy 实例的BinderProxyNativeData 实例传入进去，在 getInstance方法中会创建Java层BinderProxy 对象实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.os.BinderProxy</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ProxyMap</span> <span class="variable">sProxyMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProxyMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> mNativeData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> BinderProxy <span class="title function_">getInstance</span><span class="params">(<span class="type">long</span> nativeData, <span class="type">long</span> iBinder)</span> &#123;</span><br><span class="line">    BinderProxy result;</span><br><span class="line">    <span class="comment">// 线程安全的操作</span></span><br><span class="line">    <span class="keyword">synchronized</span> (sProxyMap) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 首先先从 sProxyMap 中查找该 binder 实例是否已经存在 BinderProxy 实例了</span></span><br><span class="line"><span class="comment">             * 有的话则直接返回</span></span><br><span class="line"><span class="comment">             * 不然就新建一个 BinderProxy ，将传入的 BinderProxyNativeData 实例保存到其中</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            result = sProxyMap.get(iBinder);</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            result = <span class="keyword">new</span> <span class="title class_">BinderProxy</span>(nativeData);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="comment">// We&#x27;re throwing an exception (probably OOME); don&#x27;t drop nativeData.</span></span><br><span class="line">            NativeAllocationRegistry.applyFreeFunction(NoImagePreloadHolder.sNativeFinalizer,</span><br><span class="line">                    nativeData);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        NoImagePreloadHolder.sRegistry.registerNativeAllocation(result, nativeData);</span><br><span class="line">        <span class="comment">// The registry now owns nativeData, even if registration threw an exception.</span></span><br><span class="line">        sProxyMap.set(iBinder, result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">BinderProxy</span><span class="params">(<span class="type">long</span> nativeData)</span> &#123;</span><br><span class="line">    mNativeData = nativeData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，在getInstance() 方法中会创建 BinderProxy 实例，在创建实例之前，会从全局静态 Map 中查找该BpBinder 对应的BinderProxy 实例是否已存在，存在的话则直接返回，不存在则创建一个存入Map并返回；</p>
<blockquote>
<p>前面可知，在 ProcessState::getContextObject 中会缓存对应 handle 的BpBinder 实例。所以说在同一个进程中，同一个 handle 值只会存在一个 BpBinder 实例；而同时也只会存在一个 BinderProxy 实例</p>
</blockquote>
<p>而在创建BinderProxy实例时，就只是将native 传过来的 BinderProxyNativeData地址保存到 mNativeData 中而已。这样的话，Java层的 BinderProxy对象就和Native 层的BpBinder 实例有了联系，联系他俩的桥梁正是：BinderProxyNativeData 。后面就可以通过这俩任意一个来获取另外一个了。</p>
<p>所以说，这里第一步 BinderInternal.getContextObject() 返回之后，拿到的就是一个 BinderProxy，其内部的  mNativeData 存储着一个 BinderProxyNativeData 实例，而这个 BinderProxyNativeData 实例中存储着一个 BpBinder(0) 实例。</p>
<p>2、调用 ServiceManagerNative<br>.asInterface() 来将前一步返回的 BinderProxy 实例再次包装一层。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.os.ServiceManagerNative</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ServiceManagerNative</span> <span class="keyword">extends</span> <span class="title class_">Binder</span> <span class="keyword">implements</span> <span class="title class_">IServiceManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cast a Binder object into a service manager interface, generating</span></span><br><span class="line"><span class="comment">     * a proxy if needed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> IServiceManager <span class="title function_">asInterface</span><span class="params">(IBinder obj)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 入参 object 可能是 BinderProxy ，在 BinderProxy 中该方法的实现是返回 null</span></span><br><span class="line"><span class="comment">         * 所以说如果是 BinderProxy 时，会走最下面创建一个新的 ServiceManagerProxy</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">IServiceManager</span> <span class="variable">in</span> <span class="operator">=</span></span><br><span class="line">            (IServiceManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">        <span class="keyword">if</span> (in != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> in;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建一个 ServiceManagerProxy 实例，将 BinderProxy 包装起来</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceManagerProxy</span>(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceManagerNative</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        attachInterface(<span class="built_in">this</span>, descriptor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTransact</span><span class="params">(<span class="type">int</span> code, Parcel data, Parcel reply, <span class="type">int</span> flags)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">                <span class="keyword">case</span> IServiceManager.GET_SERVICE_TRANSACTION: &#123;</span><br><span class="line">                    data.enforceInterface(IServiceManager.descriptor);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> data.readString();</span><br><span class="line">                    <span class="type">IBinder</span> <span class="variable">service</span> <span class="operator">=</span> getService(name);</span><br><span class="line">                    reply.writeStrongBinder(service);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> IServiceManager.CHECK_SERVICE_TRANSACTION: &#123;</span><br><span class="line">                    data.enforceInterface(IServiceManager.descriptor);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> data.readString();</span><br><span class="line">                    <span class="type">IBinder</span> <span class="variable">service</span> <span class="operator">=</span> checkService(name);</span><br><span class="line">                    reply.writeStrongBinder(service);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> IServiceManager.ADD_SERVICE_TRANSACTION: &#123;</span><br><span class="line">                    data.enforceInterface(IServiceManager.descriptor);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> data.readString();</span><br><span class="line">                    <span class="type">IBinder</span> <span class="variable">service</span> <span class="operator">=</span> data.readStrongBinder();</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">allowIsolated</span> <span class="operator">=</span> data.readInt() != <span class="number">0</span>;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">dumpPriority</span> <span class="operator">=</span> data.readInt();</span><br><span class="line">                    addService(name, service, allowIsolated, dumpPriority);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> IServiceManager.LIST_SERVICES_TRANSACTION: &#123;</span><br><span class="line">                    data.enforceInterface(IServiceManager.descriptor);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">dumpPriority</span> <span class="operator">=</span> data.readInt();</span><br><span class="line">                    String[] list = listServices(dumpPriority);</span><br><span class="line">                    reply.writeStringArray(list);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> IServiceManager.SET_PERMISSION_CONTROLLER_TRANSACTION: &#123;</span><br><span class="line">                    data.enforceInterface(IServiceManager.descriptor);</span><br><span class="line">                    <span class="type">IPermissionController</span> <span class="variable">controller</span> <span class="operator">=</span></span><br><span class="line">                            IPermissionController.Stub.asInterface(</span><br><span class="line">                                    data.readStrongBinder());</span><br><span class="line">                    setPermissionController(controller);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">asBinder</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>哇，这个类中的方法实现，简直跟 Native 层中的 IServiceManager.cpp 中一模一样呀。也是将其再包装一层，Native层中将其包装成：BpServiceManager 实例；Java层是将其包装成 ServiceManagerProxy 实例。而这两个类的实现简直一模一样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.os.ServiceManagerNative</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServiceManagerProxy</span> <span class="keyword">implements</span> <span class="title class_">IServiceManager</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceManagerProxy</span><span class="params">(IBinder remote)</span> &#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">asBinder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">getService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"></span><br><span class="line">        data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line">        data.writeString(name);</span><br><span class="line">        mRemote.transact(GET_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> reply.readStrongBinder();</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">        <span class="keyword">return</span> binder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">checkService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line">        data.writeString(name);</span><br><span class="line">        mRemote.transact(CHECK_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> reply.readStrongBinder();</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">        <span class="keyword">return</span> binder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addService</span><span class="params">(String name, IBinder service, <span class="type">boolean</span> allowIsolated, <span class="type">int</span> dumpPriority)</span></span><br><span class="line">            <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"></span><br><span class="line">        data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line">        data.writeString(name);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 调用 addService 时，肯定是在 server 端，先写类继承自 Binder ，然后将该类 addService 添加进 ServiceManger 中去</span></span><br><span class="line"><span class="comment">         * 注意这里是继承自 Binder 类的哦，该方法内部会用到</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        data.writeStrongBinder(service);</span><br><span class="line">        data.writeInt(allowIsolated ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        data.writeInt(dumpPriority);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * mRemote 是在 ServiceManagerProxy 构造方法中保存赋值的，其对应的是 BinderProxy </span></span><br><span class="line"><span class="comment">         * 该 BinderProxy 内部 mNativeData 保存了底层的 BpBinder(0) 实例</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mRemote.transact(ADD_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] listServices(<span class="type">int</span> dumpPriority) <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        ArrayList&lt;String&gt; services = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">            <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">            data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line">            data.writeInt(n);</span><br><span class="line">            data.writeInt(dumpPriority);</span><br><span class="line">            n++;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">res</span> <span class="operator">=</span> mRemote.transact(LIST_SERVICES_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                <span class="comment">// The result code that is returned by the C++ code can</span></span><br><span class="line">                <span class="comment">// cause the call to throw an exception back instead of</span></span><br><span class="line">                <span class="comment">// returning a nice result...  so eat it here and go on.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            services.add(reply.readString());</span><br><span class="line">            reply.recycle();</span><br><span class="line">            data.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">        String[] array = <span class="keyword">new</span> <span class="title class_">String</span>[services.size()];</span><br><span class="line">        services.toArray(array);</span><br><span class="line">        <span class="keyword">return</span> array;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPermissionController</span><span class="params">(IPermissionController controller)</span></span><br><span class="line">            <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line">        data.writeStrongBinder(controller.asBinder());</span><br><span class="line">        mRemote.transact(SET_PERMISSION_CONTROLLER_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> IBinder mRemote;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不同的是，这里的 Java层ServiceManagerProxy 实例中的 mRemote 是 BinderProxy 实例；而Native层中的 BpServiceManager 实例中的 mRemote 是 BpBinder 实例；</p>
<p>而 BinderProxy 和 BpBinder 两者间又有关系，这样正好打通了上下两层，有种茅塞顿开的感觉。</p>
<p>到这里就完成了  getIServiceManager() 方法的执行，创建出了 IServiceManager 接口的一个实现 ServiceManagerProxy。后续就可以通过它来执行 addService 等操作了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.os.ServiceManager</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addService</span><span class="params">(String name, IBinder service, <span class="type">boolean</span> allowIsolated,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> dumpPriority)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * getIServiceManager() :  先获取 ServiceManagerProxy 实例，内部包装了 BinderProxy ，而 BinderProxy 内部mNativeData保存了底层的 BpBinder(0) 实例</span></span><br><span class="line"><span class="comment">         * 然后调用 ServiceManagerProxy#addService 方法</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * ServiceManagerProxy 位于 ServiceManagerNative.java 文件中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        getIServiceManager().addService(name, service, allowIsolated, dumpPriority);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;error in addService&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// android.os.ServiceManagerNative</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServiceManagerProxy</span> <span class="keyword">implements</span> <span class="title class_">IServiceManager</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceManagerProxy</span><span class="params">(IBinder remote)</span> &#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">asBinder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">getService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="comment">// 省略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">checkService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="comment">// // 省略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addService</span><span class="params">(String name, IBinder service, <span class="type">boolean</span> allowIsolated, <span class="type">int</span> dumpPriority)</span></span><br><span class="line">            <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"></span><br><span class="line">        data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line">        data.writeString(name);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 调用 addService 时，肯定是在 server 端。先写子类类继承自 Binder ，然后将该类 addService 添加进 ServiceManger 中去</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        data.writeStrongBinder(service);</span><br><span class="line">        data.writeInt(allowIsolated ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        data.writeInt(dumpPriority);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * mRemote 是在 ServiceManagerProxy 构造方法中保存赋值的，其对应的是 BinderProxy </span></span><br><span class="line"><span class="comment">         * 该 BinderProxy 内部 mNativeData 保存了底层的 BpBinder(0) 实例</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mRemote.transact(ADD_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] listServices(<span class="type">int</span> dumpPriority) <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="comment">// 省略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPermissionController</span><span class="params">(IPermissionController controller)</span></span><br><span class="line">            <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="comment">// 省略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> IBinder mRemote;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终addService方法会调用到 ServiceManagerProxy 类中来。而ServiceManagerProxy 类中的 mRemote 属性正是前面赋值的BpBinder(0) 的 BinderProxy 实例。</p>
<p>而它addService中的逻辑跟Native IServiceManager.cpp 中 BpServiceMnager 类中的逻辑基本一样，这俩类的设计实现，以及其角色定位都是一样的。</p>
<p>即对于 addService 来说，首先是将要添加的service 实例等相关信息写入到 Parcel data 中，这点和native一致，比如其writeStrongBinder 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.os.Parcel</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">writeStrongBinder</span><span class="params">(IBinder val)</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行到:android_os_Parcel.cpp 中的 android_os_Parcel_writeStrongBinder() 方法内</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    nativeWriteStrongBinder(mNativePtr, val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后到 native 层：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android_os_Parcel.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">android_os_Parcel_writeStrongBinder</span><span class="params">(JNIEnv* env, jclass clazz, jlong nativePtr, jobject object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Parcel* parcel = <span class="built_in">reinterpret_cast</span>&lt;Parcel*&gt;(nativePtr);</span><br><span class="line">    <span class="keyword">if</span> (parcel != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ibinderForJavaObject : 先从 object 中读取出 BBinder 实例或者 BpBinder 实例</span></span><br><span class="line"><span class="comment">         * -  如果 object 是继承自 Binder 类的，则会返回其中的 BBbinder 实例</span></span><br><span class="line"><span class="comment">         * -  如果 object 是继承自 BinderProxy 类的，则会返回其中的 Bpbinder 实例</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * writeStrongBinder : 将上一步返回的 BBbinder 或者 BpBinder 写入进去</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">const</span> <span class="type">status_t</span> err = parcel-&gt;<span class="built_in">writeStrongBinder</span>(<span class="built_in">ibinderForJavaObject</span>(env, object));</span><br><span class="line">        <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line">            <span class="built_in">signalExceptionForError</span>(env, clazz, err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">sp&lt;IBinder&gt; <span class="title">ibinderForJavaObject</span><span class="params">(JNIEnv* env, jobject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断该对象是否是 android.os.Binder 类的实现</span></span><br><span class="line"><span class="comment">     * 是的话，则拿到其中的 mObject 属性。它实际是一个 JavaBBinderHolder 实例</span></span><br><span class="line"><span class="comment">     * 然后调用到 JavaBBinderHolder#get 方法内创建一个 JavaBBinder (继承自 BBbinder)实例</span></span><br><span class="line"><span class="comment">     * 即此时 obj 是本地Binder对象实例，其内部拥有 BBinder </span></span><br><span class="line"><span class="comment">     * 这里返回 JavaBBinder (继承自 BBbinder)实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// Instance of Binder?</span></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;<span class="built_in">IsInstanceOf</span>(obj, gBinderOffsets.mClass)) &#123;</span><br><span class="line">        JavaBBinderHolder* jbh = (JavaBBinderHolder*)</span><br><span class="line">            env-&gt;<span class="built_in">GetLongField</span>(obj, gBinderOffsets.mObject);</span><br><span class="line">        <span class="keyword">return</span> jbh-&gt;<span class="built_in">get</span>(env, obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断该对象是否是 android.os.BinderProxy 类的实现</span></span><br><span class="line"><span class="comment">     * 则 java层 BinderProxy 对象中 mNativeData 属性中保存的 BinderProxyNativeData 实例地址，也就保存着 BpBinder</span></span><br><span class="line"><span class="comment">     * 也就是说obj其内部拥有 BpBinder </span></span><br><span class="line"><span class="comment">     * 这里返回 BpBinder 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// Instance of BinderProxy?</span></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;<span class="built_in">IsInstanceOf</span>(obj, gBinderProxyOffsets.mClass)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getBPNativeData</span>(env, obj)-&gt;mObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ALOGW</span>(<span class="string">&quot;ibinderForJavaObject: %p is not a Binder object&quot;</span>, obj);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意这里在 addService 时，传入的 IBinder service 是一个继承自 Binder 的实现类。比如前面所说的 IRemoteService.Stub 类，这个类是最终业务 Service 要继承的类。</p>
</blockquote>
<p>在写入之前，会调用 ibinderForJavaObject() 方法来将这个Java层的 IBinder 实例转换为Native层的 IBinder 实例。比如对于Java层 Binder类实例的话，会取出(或者为其创建出)JavaBBinder 实例；如果是 Java层 BinderProxy 类实例的话，会取出其内部存储的 BpBinder 实例。</p>
<blockquote>
<p>ibinderForJavaObject() 方法和前面讲到的 javaObjectForIBinder() 方法是互逆的，可以完成Java层和 Native 层之间的转换。</p>
</blockquote>
<p>拿到其对应的Native层 IBinder 实现类之后，最终还是会调用到 Parcel.cpp 中的 flatten_binder() 方法中去完成之前的工作，即将其序列化为 flat_binder_object 结构体实例。</p>
<p>然后将写入完数据的Parcel 等数据通过mRemote.transact() 方法来进行传输，即 BinderProxy.transact()中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.os.BinderProxy</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">transact</span><span class="params">(<span class="type">int</span> code, Parcel data, Parcel reply, <span class="type">int</span> flags)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    Binder.checkParcel(<span class="built_in">this</span>, code, data, <span class="string">&quot;Unreasonably large binder buffer&quot;</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * flags &amp; FLAG_ONEWAY 表示是异步binder 请求，不会阻塞binder调用方线程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (mWarnOnBlocking &amp;&amp; ((flags &amp; FLAG_ONEWAY) == <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">// For now, avoid spamming the log by disabling after we&#x27;ve logged</span></span><br><span class="line">        <span class="comment">// about this interface at least once</span></span><br><span class="line">        mWarnOnBlocking = <span class="literal">false</span>;</span><br><span class="line">        Log.w(Binder.TAG, <span class="string">&quot;Outgoing transactions from this process must be FLAG_ONEWAY&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Throwable</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">tracingEnabled</span> <span class="operator">=</span> Binder.isTracingEnabled();</span><br><span class="line">    <span class="keyword">if</span> (tracingEnabled) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Throwable</span> <span class="variable">tr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Throwable</span>();</span><br><span class="line">        Binder.getTransactionTracker().addTrace(tr);</span><br><span class="line">        <span class="type">StackTraceElement</span> <span class="variable">stackTraceElement</span> <span class="operator">=</span> tr.getStackTrace()[<span class="number">1</span>];</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ALWAYS,</span><br><span class="line">                stackTraceElement.getClassName() + <span class="string">&quot;.&quot;</span> + stackTraceElement.getMethodName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Make sure the listener won&#x27;t change while processing a transaction.</span></span><br><span class="line">    <span class="keyword">final</span> Binder.<span class="type">ProxyTransactListener</span> <span class="variable">transactListener</span> <span class="operator">=</span> sTransactListener;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (transactListener != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">origWorkSourceUid</span> <span class="operator">=</span> Binder.getCallingWorkSourceUid();</span><br><span class="line">        session = transactListener.onTransactStarted(<span class="built_in">this</span>, code);</span><br><span class="line">        <span class="comment">// Allow the listener to update the work source uid. We need to update the request</span></span><br><span class="line">        <span class="comment">// header if the uid is updated.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">updatedWorkSourceUid</span> <span class="operator">=</span> Binder.getCallingWorkSourceUid();</span><br><span class="line">        <span class="keyword">if</span> (origWorkSourceUid != updatedWorkSourceUid) &#123;</span><br><span class="line">            data.replaceCallingWorkSourceUid(updatedWorkSourceUid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 执行到c++： android_util_Binder.cpp # android_os_BinderProxy_transact() 方法内</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> transactNative(code, data, reply, flags);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (transactListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            transactListener.onTransactEnded(session);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (tracingEnabled) &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ALWAYS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">transactNative</span><span class="params">(<span class="type">int</span> code, Parcel data, Parcel reply,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> flags)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到其最终是执行到了transactNative() 方法中，该方法最终是执行到 native 层，去完成真正的 Binder请求传输工作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> jboolean <span class="title">android_os_BinderProxy_transact</span><span class="params">(JNIEnv* env, jobject obj,</span></span></span><br><span class="line"><span class="params"><span class="function">        jint code, jobject dataObj, jobject replyObj, jint flags)</span> <span class="comment">// throws RemoteException</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dataObj == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">jniThrowNullPointerException</span>(env, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * dataObj 对应的是上层 Parcel 对象实例, parcelForJavaObject 方法会获取该java对象中存储的 </span></span><br><span class="line"><span class="comment">     * 调用到 android_os_Parcel.cpp 中，获取 java层 Parcel 中存储的 mNativePtr 属性，拿到底层 Parcel实例地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Parcel* data = <span class="built_in">parcelForJavaObject</span>(env, dataObj);</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    Parcel* reply = <span class="built_in">parcelForJavaObject</span>(env, replyObj);</span><br><span class="line">    <span class="keyword">if</span> (reply == <span class="literal">NULL</span> &amp;&amp; replyObj != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * getBPNativeData() : 获取 java层 BinderProxy 对象中 mNativeData 属性中保存的 BinderProxyNativeData 实例地址</span></span><br><span class="line"><span class="comment">     * 然后获取 BinderProxyNativeData 中的 mObject ，它保存的是对应的 BpBinder 实例，比如 ServiceManager 的 BpBinder(0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    IBinder* target = <span class="built_in">getBPNativeData</span>(env, obj)-&gt;mObject.<span class="built_in">get</span>();</span><br><span class="line">    <span class="keyword">if</span> (target == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">jniThrowException</span>(env, <span class="string">&quot;java/lang/IllegalStateException&quot;</span>, <span class="string">&quot;Binder has been finalized!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;Java code calling transact on %p in Java object %p with code %&quot;</span> PRId32 <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">            target, obj, code);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> time_binder_calls;</span><br><span class="line">    <span class="type">int64_t</span> start_millis;</span><br><span class="line">    <span class="keyword">if</span> (kEnableBinderSample) &#123;</span><br><span class="line">        <span class="comment">// Only log the binder call duration for things on the Java-level main thread.</span></span><br><span class="line">        <span class="comment">// But if we don&#x27;t</span></span><br><span class="line">        time_binder_calls = <span class="built_in">should_time_binder_calls</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (time_binder_calls) &#123;</span><br><span class="line">            start_millis = <span class="built_in">uptimeMillis</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//printf(&quot;Transact from Java code to %p sending: &quot;, target); data-&gt;print();</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始执行真正的变换到 BpBinder#transact 中去binder数据传输写入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">status_t</span> err = target-&gt;<span class="built_in">transact</span>(code, *data, reply, flags);</span><br><span class="line">    <span class="comment">//if (reply) printf(&quot;Transact from Java code to %p received: &quot;, target); reply-&gt;print();</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (kEnableBinderSample) &#123;</span><br><span class="line">        <span class="keyword">if</span> (time_binder_calls) &#123;</span><br><span class="line">            <span class="built_in">conditionally_log_binder_call</span>(start_millis, target, code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_TRUE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err == UNKNOWN_TRANSACTION) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">signalExceptionForError</span>(env, obj, err, <span class="literal">true</span> <span class="comment">/*canThrowRemoteException*/</span>, data-&gt;<span class="built_in">dataSize</span>());</span><br><span class="line">    <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在传输开始之前，肯定得先从 BinderProxy 中取出其内部存储的对应的 BpBinder() 实例，这里是通过 getBPNativeData() 方法来实现BpBinder的获取的。而有了 BpBinder 的话，那么就可以开始真正的数据传输了，即调用其 transact() 方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BpBinder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">BpBinder::transact</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint32_t</span> code, <span class="type">const</span> Parcel&amp; data, Parcel* reply, <span class="type">uint32_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Once a binder has died, it will never come back to life.</span></span><br><span class="line">    <span class="keyword">if</span> (mAlive) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 最终逻辑还是借助 IPCThreadState 来实现的</span></span><br><span class="line"><span class="comment">         * IPCThreadState 和 ProcessState 一样，这里还存在 IPCThreadState</span></span><br><span class="line"><span class="comment">         * 其都有 self 方法，用来创建对应的实例，比如 IPCThreadState 是线程间单例，一个线程只有一个实例，且线程间不会互相影响</span></span><br><span class="line"><span class="comment">         * 而 ProcessState 则是进程单例</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 然后调用线程单例 IPCThreadState 对象的 transact 方法</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * mHandle : 因为当前是位于 BpBinder 中的，它内部其实就是封装的 mHandle，比如 ServiceManager 的 BpBinder 中的 handle = 0\</span></span><br><span class="line"><span class="comment">         * 其他的属性就是入参传入进来的了</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * flags : 默认值是 0</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">status_t</span> status = IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">transact</span>(</span><br><span class="line">            mHandle, code, data, reply, flags);</span><br><span class="line">        <span class="keyword">if</span> (status == DEAD_OBJECT) mAlive = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来这些就是之前已经讲过的逻辑了，翻看前面文章吧。</p>
<p>前面讲完了数据的发送，那么后续数据的处理呢？</p>
<p>正如前面 Binder 类中存储的 JavaBBinder，在发送数据时，是取出它，然后发送到 Binder 内核驱动中的，那么后续有 code 要处理时，肯定是调用其 transact() 方法。因为它是一个 BBinder 实例，即Binder实体。可以翻看前面的文章复习下。</p>
<p>接着我们看 JavaBBinder是怎么处理 code 的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JavaBBinder</span> : <span class="keyword">public</span> BBinder</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">JavaBBinder</span>(JNIEnv* env, jobject <span class="comment">/* Java Binder */</span> object)</span><br><span class="line">        : <span class="built_in">mVM</span>(<span class="built_in">jnienv_to_javavm</span>(env)), <span class="built_in">mObject</span>(env-&gt;<span class="built_in">NewGlobalRef</span>(object))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ALOGV</span>(<span class="string">&quot;Creating JavaBBinder %p\n&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">        gNumLocalRefsCreated.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        <span class="built_in">gcIfManyNewRefs</span>(env);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span>    <span class="title">checkSubclass</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* subclassID)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> subclassID == &amp;gBinderOffsets;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">jobject <span class="title">object</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">JavaBBinder</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ALOGV</span>(<span class="string">&quot;Destroying JavaBBinder %p\n&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">        gNumLocalRefsDeleted.<span class="built_in">fetch_add</span>(<span class="number">1</span>, memory_order_relaxed);</span><br><span class="line">        JNIEnv* env = <span class="built_in">javavm_to_jnienv</span>(mVM);</span><br><span class="line">        env-&gt;<span class="built_in">DeleteGlobalRef</span>(mObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> String16&amp; <span class="title">getInterfaceDescriptor</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">call_once</span>(mPopulateDescriptor, [<span class="keyword">this</span>] &#123;</span><br><span class="line">            JNIEnv* env = <span class="built_in">javavm_to_jnienv</span>(mVM);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">ALOGV</span>(<span class="string">&quot;getInterfaceDescriptor() on %p calling object %p in env %p vm %p\n&quot;</span>, <span class="keyword">this</span>, mObject, env, mVM);</span><br><span class="line"></span><br><span class="line">            jstring descriptor = (jstring)env-&gt;<span class="built_in">CallObjectMethod</span>(mObject, gBinderOffsets.mGetInterfaceDescriptor);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (descriptor == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">static_assert</span>(<span class="built_in">sizeof</span>(jchar) == <span class="built_in">sizeof</span>(<span class="type">char16_t</span>), <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="type">const</span> jchar* descriptorChars = env-&gt;<span class="built_in">GetStringChars</span>(descriptor, <span class="literal">nullptr</span>);</span><br><span class="line">            <span class="type">const</span> <span class="type">char16_t</span>* rawDescriptor = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">char16_t</span>*&gt;(descriptorChars);</span><br><span class="line">            jsize rawDescriptorLen = env-&gt;<span class="built_in">GetStringLength</span>(descriptor);</span><br><span class="line">            mDescriptor = <span class="built_in">String16</span>(rawDescriptor, rawDescriptorLen);</span><br><span class="line">            env-&gt;<span class="built_in">ReleaseStringChars</span>(descriptor, descriptorChars);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mDescriptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">status_t</span> <span class="title">onTransact</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">uint32_t</span> code, <span class="type">const</span> Parcel&amp; data, Parcel* reply, <span class="type">uint32_t</span> flags = <span class="number">0</span>)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        JNIEnv* env = <span class="built_in">javavm_to_jnienv</span>(mVM);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ALOGV</span>(<span class="string">&quot;onTransact() on %p calling object %p in env %p vm %p\n&quot;</span>, <span class="keyword">this</span>, mObject, env, mVM);</span><br><span class="line"></span><br><span class="line">        IPCThreadState* thread_state = IPCThreadState::<span class="built_in">self</span>();</span><br><span class="line">        <span class="type">const</span> <span class="type">int32_t</span> strict_policy_before = thread_state-&gt;<span class="built_in">getStrictModePolicy</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//printf(&quot;Transact from %p to Java code sending: &quot;, this);</span></span><br><span class="line">        <span class="comment">//data.print();</span></span><br><span class="line">        <span class="comment">//printf(&quot;\n&quot;);</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 执行到 Java 层 Binder#execTransact 方法中去，将入参 code ，data 等传入过去。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        jboolean res = env-&gt;<span class="built_in">CallBooleanMethod</span>(mObject, gBinderOffsets.mExecTransact,</span><br><span class="line">            code, <span class="built_in">reinterpret_cast</span>&lt;jlong&gt;(&amp;data), <span class="built_in">reinterpret_cast</span>&lt;jlong&gt;(reply), flags);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (env-&gt;<span class="built_in">ExceptionCheck</span>()) &#123;</span><br><span class="line">            <span class="function">ScopedLocalRef&lt;jthrowable&gt; <span class="title">excep</span><span class="params">(env, env-&gt;ExceptionOccurred())</span></span>;</span><br><span class="line">            <span class="built_in">report_exception</span>(env, excep.<span class="built_in">get</span>(),</span><br><span class="line">                <span class="string">&quot;*** Uncaught remote exception!  &quot;</span></span><br><span class="line">                <span class="string">&quot;(Exceptions are not yet supported across processes.)&quot;</span>);</span><br><span class="line">            res = JNI_FALSE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if the strict mode state changed while processing the</span></span><br><span class="line">        <span class="comment">// call.  The Binder state will be restored by the underlying</span></span><br><span class="line">        <span class="comment">// Binder system in IPCThreadState, however we need to take care</span></span><br><span class="line">        <span class="comment">// of the parallel Java state as well.</span></span><br><span class="line">        <span class="keyword">if</span> (thread_state-&gt;<span class="built_in">getStrictModePolicy</span>() != strict_policy_before) &#123;</span><br><span class="line">            <span class="built_in">set_dalvik_blockguard_policy</span>(env, strict_policy_before);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (env-&gt;<span class="built_in">ExceptionCheck</span>()) &#123;</span><br><span class="line">            <span class="function">ScopedLocalRef&lt;jthrowable&gt; <span class="title">excep</span><span class="params">(env, env-&gt;ExceptionOccurred())</span></span>;</span><br><span class="line">            <span class="built_in">report_exception</span>(env, excep.<span class="built_in">get</span>(),</span><br><span class="line">                <span class="string">&quot;*** Uncaught exception in onBinderStrictModePolicyChange&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Need to always call through the native implementation of</span></span><br><span class="line">        <span class="comment">// SYSPROPS_TRANSACTION.</span></span><br><span class="line">        <span class="keyword">if</span> (code == SYSPROPS_TRANSACTION) &#123;</span><br><span class="line">            BBinder::<span class="built_in">onTransact</span>(code, data, reply, flags);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//aout &lt;&lt; &quot;onTransact to Java code; result=&quot; &lt;&lt; res &lt;&lt; endl</span></span><br><span class="line">        <span class="comment">//    &lt;&lt; &quot;Transact from &quot; &lt;&lt; this &lt;&lt; &quot; to Java code returning &quot;</span></span><br><span class="line">        <span class="comment">//    &lt;&lt; reply &lt;&lt; &quot;: &quot; &lt;&lt; *reply &lt;&lt; endl;</span></span><br><span class="line">        <span class="keyword">return</span> res != JNI_FALSE ? NO_ERROR : UNKNOWN_TRANSACTION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">status_t</span> <span class="title">dump</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> Vector&lt;String16&gt;&amp; args)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    JavaVM* <span class="type">const</span>   mVM;</span><br><span class="line">    jobject <span class="type">const</span>   mObject;  <span class="comment">// GlobalRef to Java Binder</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutable</span> std::once_flag mPopulateDescriptor;</span><br><span class="line">    <span class="keyword">mutable</span> String16 mDescriptor;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以知道，执行了 BBinder 的 transact() 之后，会再执行到其 onTransact() 方法中去，进而执行到 JavaBBinder 的onTransact() 方法中来。</p>
<p>而在该方法内部，会调用 env-&gt;CallBooleanMethod() ，并且传入了gBinderOffsets.mExecTransact ,表示去执行Java层 Binder 类中的 execTransact() 方法，即从 Native层调用到 Java层去。</p>
<blockquote>
<p>1、这个 gBinderOffsets.mExecTransact 等属性是在系统一开始启动时就会注册绑定好的映射关系，它对应 andriod.os.Binder 类中的execTransact() 方法，后面会简单提一下这个注册过程。</p>
<p>2、前面讲过，Java 层 Binder 中有一个 mObject 属性，会在Binder类构造方法执行时在Native层创建一个JavaBBinderHolder 实例，mObject会指向该地址。等到后面发送数据到 Binder内核时，会调用 Parcel 的android_os_Parcel_writeStrongBinder() 方法，进而调用 ibinderForJavaObject() 方法，该方法中会通过JavaBBinderHolder实例来创建一个 JavaBBinder 实例，并且将Java层 Binder对象实例存储到JavaBBinder.mObject 中去。那么后续这里就可以通过这个 mObject 和 gBinderOffsets.mExecTransact 来调用到该 Java 层 Binder对象中的 execTransact() 方法了</p>
</blockquote>
<p>接着也就是执行到 Java层 Binder 中了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android.os.Binder</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">execTransact</span><span class="params">(<span class="type">int</span> code, <span class="type">long</span> dataObj, <span class="type">long</span> replyObj,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">    <span class="comment">// At that point, the parcel request headers haven&#x27;t been parsed so we do not know what</span></span><br><span class="line">    <span class="comment">// WorkSource the caller has set. Use calling uid as the default.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">callingUid</span> <span class="operator">=</span> Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origWorkSource</span> <span class="operator">=</span> ThreadLocalWorkSource.setUid(callingUid);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> execTransactInternal(code, dataObj, replyObj, flags, callingUid);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ThreadLocalWorkSource.restore(origWorkSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">execTransactInternal</span><span class="params">(<span class="type">int</span> code, <span class="type">long</span> dataObj, <span class="type">long</span> replyObj, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> callingUid)</span> &#123;</span><br><span class="line">    <span class="comment">// Make sure the observer won&#x27;t change while processing a transaction.</span></span><br><span class="line">    <span class="keyword">final</span> BinderInternal.<span class="type">Observer</span> <span class="variable">observer</span> <span class="operator">=</span> sObserver;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">CallSession</span> <span class="variable">callSession</span> <span class="operator">=</span></span><br><span class="line">            observer != <span class="literal">null</span> ? observer.callStarted(<span class="built_in">this</span>, code, UNSET_WORKSOURCE) : <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain(dataObj);</span><br><span class="line">    <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain(replyObj);</span><br><span class="line">    <span class="comment">// theoretically, we should call transact, which will call onTransact,</span></span><br><span class="line">    <span class="comment">// but all that does is rewind it, and we just got these from an IPC,</span></span><br><span class="line">    <span class="comment">// so we&#x27;ll just call it directly.</span></span><br><span class="line">    <span class="type">boolean</span> res;</span><br><span class="line">    <span class="comment">// Log any exceptions as warnings, don&#x27;t silently suppress them.</span></span><br><span class="line">    <span class="comment">// If the call was FLAG_ONEWAY then these exceptions disappear into the ether.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">tracingEnabled</span> <span class="operator">=</span> Binder.isTracingEnabled();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tracingEnabled) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">transactionName</span> <span class="operator">=</span> getTransactionName(code);</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ALWAYS, getClass().getName() + <span class="string">&quot;:&quot;</span></span><br><span class="line">                    + (transactionName != <span class="literal">null</span> ? transactionName : code));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 执行到子类的 onTransact  方法中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        res = onTransact(code, data, reply, flags);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException|RuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">            observer.callThrewException(callSession, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (LOG_RUNTIME_EXCEPTION) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;Caught a RuntimeException from the binder stub implementation.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; FLAG_ONEWAY) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RemoteException) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">&quot;Binder call failed.&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">&quot;Caught a RuntimeException from the binder stub implementation.&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Clear the parcel before writing the exception</span></span><br><span class="line">            reply.setDataSize(<span class="number">0</span>);</span><br><span class="line">            reply.setDataPosition(<span class="number">0</span>);</span><br><span class="line">            reply.writeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        res = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tracingEnabled) &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ALWAYS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// The parcel RPC headers have been called during onTransact so we can now access</span></span><br><span class="line">            <span class="comment">// the worksource uid from the parcel.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">workSourceUid</span> <span class="operator">=</span> sWorkSourceProvider.resolveWorkSourceUid(</span><br><span class="line">                    data.readCallingWorkSourceUid());</span><br><span class="line">            observer.callEnded(callSession, data.dataSize(), reply.dataSize(), workSourceUid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    checkParcel(<span class="built_in">this</span>, code, reply, <span class="string">&quot;Unreasonably large binder reply buffer&quot;</span>);</span><br><span class="line">    reply.recycle();</span><br><span class="line">    data.recycle();</span><br><span class="line">    <span class="comment">// Just in case -- we are done with the IPC, so there should be no more strict</span></span><br><span class="line">    <span class="comment">// mode violations that have gathered for this thread.  Either they have been</span></span><br><span class="line">    <span class="comment">// parceled and are now in transport off to the caller, or we are returning back</span></span><br><span class="line">    <span class="comment">// to the main transaction loop to wait for another incoming transaction.  Either</span></span><br><span class="line">    <span class="comment">// way, strict mode begone!</span></span><br><span class="line">    StrictMode.clearGatheredViolations();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到最终是执行到了 onTransact() 方法中，而这个方法就是给子类来实现的。这不正好跟前面讲到的 IRemoteService.Stub 中的 onTransact() 方法接上了嘛。也就是完成了最终 Service侧 code 的处理逻辑。</p>
<h4 id="Binder-native-初始化注册"><a href="#Binder-native-初始化注册" class="headerlink" title="Binder native 初始化注册"></a>Binder native 初始化注册</h4><p>前面讲到的 javaObjectForIBinder 和 JavaBBinder 中的onTransact()等方法使用到了 gBinderOffsets 结构体中的属性，来开完成对应Java层方法的调用逻辑。这些属性的赋值是什么时候呢？</p>
<p>在Android系统开机的时候，会有一个 虚拟机注册过程，具体是调用到 AndroidRuntime::startReg() 方法中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AndroidRuntime.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*static*/</span> <span class="function"><span class="type">int</span> <span class="title">AndroidRuntime::startReg</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ATRACE_NAME</span>(<span class="string">&quot;RegisterAndroidNatives&quot;</span>);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This hook causes all future threads created in this process to be</span></span><br><span class="line"><span class="comment">     * attached to the JavaVM.  (This needs to go away in favor of JNI</span></span><br><span class="line"><span class="comment">     * Attach calls.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">androidSetCreateThreadFunc</span>((android_create_thread_fn) javaCreateThreadEtc);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;--- registering native functions ---\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Every &quot;register&quot; function calls one or more things that return</span></span><br><span class="line"><span class="comment">     * a local reference (e.g. FindClass).  Because we haven&#x27;t really</span></span><br><span class="line"><span class="comment">     * started the VM yet, they&#x27;re all getting stored in the base frame</span></span><br><span class="line"><span class="comment">     * and never released.  Use Push/Pop to manage the storage.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    env-&gt;<span class="built_in">PushLocalFrame</span>(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册 gRegJNI 数组中的方法，其中有一个方法是 register_android_os_Binder (android_util_Binder.cpp)</span></span><br><span class="line"><span class="comment">     * 在该方法内部会打通 Binder 相关的 C++层 和 Java层 的通道</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">register_jni_procs</span>(gRegJNI, <span class="built_in">NELEM</span>(gRegJNI), env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        env-&gt;<span class="built_in">PopLocalFrame</span>(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">PopLocalFrame</span>(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//createJavaThread(&quot;fubar&quot;, quickTest, (void*) &quot;hello&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gRegJNI 数组中存储着一系列的方法，这里会挨个执行其方法来完成注册，其中包括了位于 android_util_Binder.cpp 类中的register_android_os_Binder 方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册 android_os_Binder 相关类方法等</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">register_android_os_Binder</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册 android.os.Binder 类相关方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">int_register_android_os_Binder</span>(env) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册 com.android.internal.os.BinderInternal 类相关方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">int_register_android_os_BinderInternal</span>(env) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册 android.os.BinderProxy 类相关方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">int_register_android_os_BinderProxy</span>(env) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取上层 Log 、 ParcelFileDescriptor 、 StrictMode 、 Thread这些类的属性方法并保存起来供后续使用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    jclass clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;android/util/Log&quot;</span>);</span><br><span class="line">    gLogOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line">    gLogOffsets.mLogE = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;e&quot;</span>,</span><br><span class="line">            <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;android/os/ParcelFileDescriptor&quot;</span>);</span><br><span class="line">    gParcelFileDescriptorOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line">    gParcelFileDescriptorOffsets.mConstructor = <span class="built_in">GetMethodIDOrDie</span>(env, clazz, <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">                                                                 <span class="string">&quot;(Ljava/io/FileDescriptor;)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;android/os/StrictMode&quot;</span>);</span><br><span class="line">    gStrictModeCallbackOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line">    gStrictModeCallbackOffsets.mCallback = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz,</span><br><span class="line">            <span class="string">&quot;onBinderStrictModePolicyChange&quot;</span>, <span class="string">&quot;(I)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;java/lang/Thread&quot;</span>);</span><br><span class="line">    gThreadDispatchOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line">    gThreadDispatchOffsets.mDispatchUncaughtException = <span class="built_in">GetMethodIDOrDie</span>(env, clazz,</span><br><span class="line">            <span class="string">&quot;dispatchUncaughtException&quot;</span>, <span class="string">&quot;(Ljava/lang/Throwable;)V&quot;</span>);</span><br><span class="line">    gThreadDispatchOffsets.mCurrentThread = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;currentThread&quot;</span>,</span><br><span class="line">            <span class="string">&quot;()Ljava/lang/Thread;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">int_register_android_os_Binder</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * kBinderPathName : &quot;android/os/Binder&quot;</span></span><br><span class="line"><span class="comment">     * FindClassOrDie() 方法等价于 env-&gt;FindClass(kBinderPathName) 来获取对应的class</span></span><br><span class="line"><span class="comment">     * 即获取的是 android.os.Binder 类</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 相关方法解释：https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/functions.html</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    jclass clazz = <span class="built_in">FindClassOrDie</span>(env, kBinderPathName);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * gBinderOffsets 是定义的全局结构体实例，后续会将 android.os.Binder 类中属性保存进来</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    gBinderOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 android.os.Binder 的 execTransact 和 getInterfaceDescriptor 方法，保存到 gBinderOffsets 中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    gBinderOffsets.mExecTransact = <span class="built_in">GetMethodIDOrDie</span>(env, clazz, <span class="string">&quot;execTransact&quot;</span>, <span class="string">&quot;(IJJI)Z&quot;</span>);</span><br><span class="line">    gBinderOffsets.mGetInterfaceDescriptor = <span class="built_in">GetMethodIDOrDie</span>(env, clazz, <span class="string">&quot;getInterfaceDescriptor&quot;</span>,</span><br><span class="line">        <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gBinderOffsets.mObject = <span class="built_in">GetFieldIDOrDie</span>(env, clazz, <span class="string">&quot;mObject&quot;</span>, <span class="string">&quot;J&quot;</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以上这些是方便访问到上层Java Binder 类中的属性方法，即为c++层访问Java层提供通道支持</span></span><br><span class="line"><span class="comment">     * 而这里是注册 Java 层的native 方法，在上层调用其native方法时会调用到底层对应方法来，即为Java层访问c++层提供通道支持</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RegisterMethodsOrDie</span>(</span><br><span class="line">        env, kBinderPathName,</span><br><span class="line">        gBinderMethods, <span class="built_in">NELEM</span>(gBinderMethods));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">int_register_android_os_BinderInternal</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    jclass clazz = <span class="built_in">FindClassOrDie</span>(env, kBinderInternalPathName);</span><br><span class="line"></span><br><span class="line">    gBinderInternalOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line">    gBinderInternalOffsets.mForceGc = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;forceBinderGc&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    gBinderInternalOffsets.mProxyLimitCallback = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;binderProxyLimitCallbackFromNative&quot;</span>, <span class="string">&quot;(I)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jclass SparseIntArrayClass = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;android/util/SparseIntArray&quot;</span>);</span><br><span class="line">    gSparseIntArrayOffsets.classObject = <span class="built_in">MakeGlobalRefOrDie</span>(env, SparseIntArrayClass);</span><br><span class="line">    gSparseIntArrayOffsets.constructor = <span class="built_in">GetMethodIDOrDie</span>(env, gSparseIntArrayOffsets.classObject,</span><br><span class="line">                                                           <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    gSparseIntArrayOffsets.put = <span class="built_in">GetMethodIDOrDie</span>(env, gSparseIntArrayOffsets.classObject, <span class="string">&quot;put&quot;</span>,</span><br><span class="line">                                                   <span class="string">&quot;(II)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    BpBinder::<span class="built_in">setLimitCallback</span>(android_os_BinderInternal_proxyLimitcallback);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RegisterMethodsOrDie</span>(</span><br><span class="line">        env, kBinderInternalPathName,</span><br><span class="line">        gBinderInternalMethods, <span class="built_in">NELEM</span>(gBinderInternalMethods));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">int_register_android_os_BinderProxy</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    jclass clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;java/lang/Error&quot;</span>);</span><br><span class="line">    gErrorOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line"></span><br><span class="line">    clazz = <span class="built_in">FindClassOrDie</span>(env, kBinderProxyPathName);</span><br><span class="line">    gBinderProxyOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line">    gBinderProxyOffsets.mGetInstance = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;getInstance&quot;</span>,</span><br><span class="line">            <span class="string">&quot;(JJ)Landroid/os/BinderProxy;&quot;</span>);</span><br><span class="line">    gBinderProxyOffsets.mSendDeathNotice = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;sendDeathNotice&quot;</span>,</span><br><span class="line">            <span class="string">&quot;(Landroid/os/IBinder$DeathRecipient;)V&quot;</span>);</span><br><span class="line">    gBinderProxyOffsets.mNativeData = <span class="built_in">GetFieldIDOrDie</span>(env, clazz, <span class="string">&quot;mNativeData&quot;</span>, <span class="string">&quot;J&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;java/lang/Class&quot;</span>);</span><br><span class="line">    gClassOffsets.mGetName = <span class="built_in">GetMethodIDOrDie</span>(env, clazz, <span class="string">&quot;getName&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RegisterMethodsOrDie</span>(</span><br><span class="line">        env, kBinderProxyPathName,</span><br><span class="line">        gBinderProxyMethods, <span class="built_in">NELEM</span>(gBinderProxyMethods));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中会分别调用三个方法来分别注册 android.os.Binder 、com.android.internal.os.BinderInternal 以及 android.os.BinderProxy 这三个类。注册完毕之后，这三个类的关键方法信息就会存储在对应的结构体实例中，比如 Binder 类对应的结构体信息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义结构体 bindernative_offsets_t 并且同时声明一个它的变量：gBinderOffsets ，是static的全局变量</span></span><br><span class="line"><span class="comment"> * 该结构体内部的方法指向 android.os.Binder 类中指定的方法</span></span><br><span class="line"><span class="comment"> * 通过其内部的这些属性可以访问到上层Java Binder 类中的属性方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">bindernative_offsets_t</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Class state.</span></span><br><span class="line">    jclass mClass; <span class="comment">// 对应的是 android.os.Binder 类信息</span></span><br><span class="line">    jmethodID mExecTransact; <span class="comment">// 指向 execTransact 方法</span></span><br><span class="line">    jmethodID mGetInterfaceDescriptor; <span class="comment">// 指向 getInterfaceDescriptor 方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Object state.</span></span><br><span class="line">    jfieldID mObject; <span class="comment">// 指向 mObject 属性</span></span><br><span class="line"></span><br><span class="line">&#125; gBinderOffsets;</span><br></pre></td></tr></table></figure>

<p>这样的话，后期就可以直接使用了。</p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/Binder/">Binder</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/8dd4bfe0.html">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Jetpack- Lifecycle</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/1d5df811.html">
        <span class="next-text nav-default">Binder - Server数据处理</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2020 -
    
    2023
    <span class="footer-author">咔咔咔.</span>
    <span class="power-by">
        由 <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> and <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a> 强力驱动
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
