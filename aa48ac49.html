<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="GLES&EGL-EGL-01"/>




  <meta name="keywords" content="AndroidFrameworks,OpenGLES,EGL," />





  <link rel="alternate" href="/default" title="咔咔咔" >




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://youngkaaa.github.io/aa48ac49.html"/>


<meta name="description" content="我们知道：EGL 中提供了若干个方法，使用这些方法可以为OpenGL ES创建绘画环境，那具体在Android中EGL是怎么做的呢？ 在Android中，所有对于 EGL 的操作都是汇集到：frameworks&#x2F;native&#x2F;opengl&#x2F;libs&#x2F;EGL&#x2F;eglApi.cpp 中的，因此后续的 eglXXXX 方法基本都是在这个文件中的。 在正式">
<meta property="og:type" content="article">
<meta property="og:title" content="GLES&amp;EGL-EGL-01">
<meta property="og:url" content="https://youngkaaa.github.io/aa48ac49.html">
<meta property="og:site_name" content="咔咔咔">
<meta property="og:description" content="我们知道：EGL 中提供了若干个方法，使用这些方法可以为OpenGL ES创建绘画环境，那具体在Android中EGL是怎么做的呢？ 在Android中，所有对于 EGL 的操作都是汇集到：frameworks&#x2F;native&#x2F;opengl&#x2F;libs&#x2F;EGL&#x2F;eglApi.cpp 中的，因此后续的 eglXXXX 方法基本都是在这个文件中的。 在正式">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-20T11:49:56.000Z">
<meta property="article:modified_time" content="2023-03-03T14:01:44.567Z">
<meta property="article:author" content="咔咔咔">
<meta property="article:tag" content="AndroidFrameworks">
<meta property="article:tag" content="OpenGLES">
<meta property="article:tag" content="EGL">
<meta name="twitter:card" content="summary">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> GLES&EGL-EGL-01 - 咔咔咔 </title>
  <meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">咔咔咔</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          GLES&EGL-EGL-01
        
      </h1>

      <time class="post-time">
          8月 20 2022
      </time>
    </header>



    
            <div class="post-content">
            <p>我们知道：EGL 中提供了若干个方法，使用这些方法可以为OpenGL ES创建绘画环境，那具体在Android中EGL是怎么做的呢？</p>
<p>在Android中，所有对于 EGL 的操作都是汇集到：frameworks&#x2F;native&#x2F;opengl&#x2F;libs&#x2F;EGL&#x2F;eglApi.cpp 中的，因此后续的 eglXXXX 方法基本都是在这个文件中的。</p>
<p>在正式讲之前，可以先做一些知识铺垫，方便后续的内容讲解。</p>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><h4 id="GL-ENTRY-amp-EGL-ENTRY"><a href="#GL-ENTRY-amp-EGL-ENTRY" class="headerlink" title="GL_ENTRY &amp; EGL_ENTRY"></a>GL_ENTRY &amp; EGL_ENTRY</h4><p>在代码中，存在多个 XXXX.in 文件，这些文件内部定义了很多个 GL_ENTRY 或者 EGL_ENTRY 结构类型的数据，比如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/platform_entries.in</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLDisplay, eglGetDisplay, EGLNativeDisplayType)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLDisplay, eglGetPlatformDisplay, EGLenum, EGLNativeDisplayType, <span class="type">const</span> EGLAttrib*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglInitialize, EGLDisplay, EGLint*, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglTerminate, EGLDisplay)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglGetConfigs, EGLDisplay, EGLConfig*, EGLint, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglChooseConfig, EGLDisplay, <span class="type">const</span> EGLint*, EGLConfig*, EGLint, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglGetConfigAttrib, EGLDisplay, EGLConfig, EGLint, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLSurface, eglCreateWindowSurface, EGLDisplay, EGLConfig, NativeWindowType, <span class="type">const</span> EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLSurface, eglCreatePlatformWindowSurface, EGLDisplay, EGLConfig, <span class="type">void</span>*, <span class="type">const</span> EGLAttrib*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLSurface, eglCreatePixmapSurface, EGLDisplay, EGLConfig, NativePixmapType, <span class="type">const</span> EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLSurface, eglCreatePlatformPixmapSurface, EGLDisplay, EGLConfig, <span class="type">void</span>*, <span class="type">const</span> EGLAttrib*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLSurface, eglCreatePbufferSurface, EGLDisplay, EGLConfig, <span class="type">const</span> EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglDestroySurface, EGLDisplay, EGLSurface)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglQuerySurface, EGLDisplay, EGLSurface, EGLint, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(<span class="type">void</span>, eglBeginFrame, EGLDisplay, EGLSurface)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLContext, eglCreateContext, EGLDisplay, EGLConfig, EGLContext, <span class="type">const</span> EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglDestroyContext, EGLDisplay, EGLContext)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglMakeCurrent, EGLDisplay, EGLSurface, EGLSurface, EGLContext)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglQueryContext, EGLDisplay, EGLContext, EGLint, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLContext, eglGetCurrentContext, <span class="type">void</span>)</span><br><span class="line">.... 省略其他的 ....</span><br></pre></td></tr></table></figure>

<p>此时，对应的外部会有多个数组或者结构体中引用这些 in 文件，比如这里：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 先取消掉之前其他地方定义的 EGL_ENTRY 和 GL_ENTRY</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> GL_ENTRY</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> EGL_ENTRY</span></span><br><span class="line"><span class="comment">// 然后重新定义 EGL_ENTRY 和 GL_ENTRY </span></span><br><span class="line"><span class="comment">// 重新定义的 EGL_ENTRY 和 GL_ENTRY 这俩宏都是只返回 api 名，也就是方法名</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_ENTRY(_r, _api, ...) #_api,</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EGL_ENTRY(_r, _api, ...) #_api,</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> <span class="type">const</span> * <span class="type">const</span> gl_names[] = &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../entries.in&quot;</span></span></span><br><span class="line">    <span class="literal">nullptr</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> <span class="type">const</span> * <span class="type">const</span> gl_names_1[] = &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../entries_gles1.in&quot;</span></span></span><br><span class="line">    <span class="literal">nullptr</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> <span class="type">const</span> * <span class="type">const</span> egl_names[] = &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;egl_entries.in&quot;</span></span></span><br><span class="line">    <span class="literal">nullptr</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 指向 platform_entries.in 内部的每个声明</span></span><br><span class="line"><span class="comment"> * 而此时 #define EGL_ENTRY(_r, _api, ...) #_api, </span></span><br><span class="line"><span class="comment"> * 所以这里其实取出来的都是方法名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">char</span> <span class="type">const</span> * <span class="type">const</span> platform_names[] = &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;platform_entries.in&quot;</span></span></span><br><span class="line">    <span class="literal">nullptr</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用完就取消掉</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> GL_ENTRY</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> EGL_ENTRY</span></span><br></pre></td></tr></table></figure>

<p>可以看到这里的 egl_names 、gl_names 等数组中都是引入了对应的 XXX.in 文件的，也就是会把 in 文件中的内容引入到数组中来作为每一项。但是这里需要注意的是在数组定义之前，重新定义了 EGL_ENTRY 和 GL_ENTRY 这俩宏，此时这俩只返回了 api ，也就是 in 文件中的方法名。所以这些数组中存储的每一项不是 in 文件中的每一行内容，而是每一行中定义的方法名，比如对于上面的 frameworks&#x2F;native&#x2F;opengl&#x2F;libs&#x2F;platform_entries.in 文件来说，第一行对应的方法名是：eglGetDisplay 。</p>
<p>接着咱们看第二种情况：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/hooks.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> GL_ENTRY</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> EGL_ENTRY</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_ENTRY(_r, _api, ...) _r (*(_api))(__VA_ARGS__);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EGL_ENTRY(_r, _api, ...) _r (*(_api))(__VA_ARGS__);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">platform_impl_t</span> &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;platform_entries.in&quot;</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">egl_t</span> &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EGL/egl_entries.in&quot;</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">gl_hooks_t</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">gl_t</span> &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;entries.in&quot;</span></span></span><br><span class="line">    &#125; gl;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">gl_ext_t</span> &#123;</span><br><span class="line">        __eglMustCastToProperFunctionPointerType extensions[MAX_NUMBER_OF_GL_EXTENSIONS];</span><br><span class="line">    &#125; ext;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> GL_ENTRY</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> EGL_ENTRY</span></span><br></pre></td></tr></table></figure>

<p>此时又重新定义了 EGL_ENTRY 和 GL_ENTRY 这俩宏，此时返回的就不是前面的 api 方法名了，此时会翻译成：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_r (*(_api))(__VA_ARGS__);</span><br></pre></td></tr></table></figure>

<p>格式，比如还是用前面的 frameworks&#x2F;native&#x2F;opengl&#x2F;libs&#x2F;platform_entries.in 文件来举例，此时它内部的第一行转换之后就是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">EGLDisplay</span> (*(eglGetDisplay))(EGLNativeDisplayType)</span><br></pre></td></tr></table></figure>

<p>也就是一个函数指针，接收一个 EGLNativeDisplayType 类型参数，返回 EGLDisplay。</p>
<p>从始至终， in 文件都是同一个，但是在不同地方定义的属性引用它之后，拿到的结果不一样，这一切都得归功于 EGL_ENTRY 和 GL_ENTRY 这俩宏定义。</p>
<h4 id="egl-connection-t"><a href="#egl-connection-t" class="headerlink" title="egl_connection_t"></a>egl_connection_t</h4><p>先看看 egl_connection_t 它的使用，它在 frameworks&#x2F;native&#x2F;opengl&#x2F;libs&#x2F;EGL&#x2F;egl.cpp 中有定义一个全局变量 gEGLImpl：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl.cpp</span></span><br><span class="line"><span class="type">egl_connection_t</span> gEGLImpl;</span><br></pre></td></tr></table></figure>

<p>这个 egl_connection_t 类型的全局变量 gEGLImpl ，他可以被多个地方直接访问，它内部存储着已经加载了的 OpenGL ES 、EGL 动态库内部对应的函数实现。</p>
<p>接下来看看 egl_connection_t 的定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egldefs.h</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">egl_connection_t</span> &#123;</span><br><span class="line">    <span class="comment">// 两个枚举值，主要用于上面 gHooks 数组索引以及当前结构体内 hooks 数组索引</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        GLESv1_INDEX = <span class="number">0</span>,</span><br><span class="line">        GLESv2_INDEX = <span class="number">1</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="title">egl_connection_t</span><span class="params">()</span> : dso(nullptr),</span></span><br><span class="line"><span class="function">                                libEgl(nullptr),</span></span><br><span class="line"><span class="function">                                libGles1(nullptr),</span></span><br><span class="line"><span class="function">                                libGles2(nullptr),</span></span><br><span class="line"><span class="function">                                systemDriverUnloaded(false) &#123;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 准备遍历 platform_names 数组中的内容</span></span><br><span class="line">        <span class="type">char</span> <span class="type">const</span>* <span class="type">const</span>* entries = platform_names;</span><br><span class="line">        <span class="comment">// 这里会先初始化一下 platform 指针指向的位置</span></span><br><span class="line">        EGLFuncPointer* curr = <span class="built_in">reinterpret_cast</span>&lt;EGLFuncPointer*&gt;(&amp;platform);</span><br><span class="line">        <span class="keyword">while</span> (*entries) &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">char</span>* name = *entries;</span><br><span class="line">            <span class="comment">// 查找 platform_names 中每个函数方法对应的实际函数地址 ，所以说 platform 的调用默认的话会到 egl_platform_entries.cpp 中</span></span><br><span class="line">            EGLFuncPointer f = <span class="built_in">FindPlatformImplAddr</span>(name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (f == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                <span class="comment">// If no entry found, update the lookup table: sPlatformImplMap</span></span><br><span class="line">                <span class="built_in">ALOGE</span>(<span class="string">&quot;No entry found in platform lookup table for %s&quot;</span>, name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            *curr++ = f;</span><br><span class="line">            entries++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 加载的对应 gles so 文件句柄，driver_t 类型的，详见 Loader::open</span></span><br><span class="line">    <span class="type">void</span> *              dso;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * gHooks[0] : 保存了所有 GLESv1_CM 函数的符号地址</span></span><br><span class="line"><span class="comment">     * gHooks[1] : 保存了所有 GLESv2 函数的符号地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">gl_hooks_t</span> *        hooks[<span class="number">2</span>];</span><br><span class="line">    EGLint              major;</span><br><span class="line">    EGLint              minor;</span><br><span class="line">    EGLint              driverVersion;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * egl_entries.in 文件中声明的方法在 dso 对应的 so 文件中的内存地址，可以直接用来调用的</span></span><br><span class="line"><span class="comment">     * 保存了所有 EGL 函数的符号地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">egl_t</span>               egl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Functions implemented or redirected by platform libraries</span></span><br><span class="line">    <span class="type">platform_impl_t</span>     platform;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这三个参数分别保存了 libEGL.so，libGLESv1_CM.so，libGLESv2.so 这三个 wrapper 库的句柄</span></span><br><span class="line">    <span class="type">void</span>*               libEgl;</span><br><span class="line">    <span class="type">void</span>*               libGles1;</span><br><span class="line">    <span class="type">void</span>*               libGles2;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span>                systemDriverUnloaded;</span><br><span class="line">    <span class="type">bool</span>                shouldUseAngle; <span class="comment">// Should we attempt to load ANGLE</span></span><br><span class="line">    <span class="type">bool</span>                angleDecided;   <span class="comment">// Have we tried to load ANGLE</span></span><br><span class="line">    <span class="type">bool</span>                useAngle;       <span class="comment">// Was ANGLE successfully loaded</span></span><br><span class="line">    EGLint              angleBackend;</span><br><span class="line">    <span class="type">void</span>*               vendorEGL;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>egl_connection_t中定义了较多的属性，这里对这些属性先不做分析，等待后面遇到了再单独分析。</p>
<p>接下来主要看它的构造方法逻辑。</p>
<p>在 egl_connection_t 的构造方法中，会遍历 platform_names 数组中定义的函数名，然后通过 FindPlatformImplAddr() 方法来将其一一映射到具体的函数指针上去。</p>
<p>这里分为两步来介绍，第一步是先看看 platform_names 数组是啥？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> <span class="type">const</span> * <span class="type">const</span> platform_names[] = &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;platform_entries.in&quot;</span></span></span><br><span class="line">    <span class="literal">nullptr</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/platform_entries.in</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLDisplay, eglGetDisplay, EGLNativeDisplayType)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLDisplay, eglGetPlatformDisplay, EGLenum, EGLNativeDisplayType, <span class="type">const</span> EGLAttrib*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglInitialize, EGLDisplay, EGLint*, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglTerminate, EGLDisplay)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglGetConfigs, EGLDisplay, EGLConfig*, EGLint, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglChooseConfig, EGLDisplay, <span class="type">const</span> EGLint*, EGLConfig*, EGLint, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglGetConfigAttrib, EGLDisplay, EGLConfig, EGLint, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLSurface, eglCreateWindowSurface, EGLDisplay, EGLConfig, NativeWindowType, <span class="type">const</span> EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLSurface, eglCreatePlatformWindowSurface, EGLDisplay, EGLConfig, <span class="type">void</span>*, <span class="type">const</span> EGLAttrib*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLSurface, eglCreatePixmapSurface, EGLDisplay, EGLConfig, NativePixmapType, <span class="type">const</span> EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLSurface, eglCreatePlatformPixmapSurface, EGLDisplay, EGLConfig, <span class="type">void</span>*, <span class="type">const</span> EGLAttrib*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLSurface, eglCreatePbufferSurface, EGLDisplay, EGLConfig, <span class="type">const</span> EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglDestroySurface, EGLDisplay, EGLSurface)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglQuerySurface, EGLDisplay, EGLSurface, EGLint, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(<span class="type">void</span>, eglBeginFrame, EGLDisplay, EGLSurface)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLContext, eglCreateContext, EGLDisplay, EGLConfig, EGLContext, <span class="type">const</span> EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglDestroyContext, EGLDisplay, EGLContext)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglMakeCurrent, EGLDisplay, EGLSurface, EGLSurface, EGLContext)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLBoolean, eglQueryContext, EGLDisplay, EGLContext, EGLint, EGLint*)</span><br><span class="line"><span class="built_in">EGL_ENTRY</span>(EGLContext, eglGetCurrentContext, <span class="type">void</span>)</span><br><span class="line">.... 省略其他的 ....</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EGL_ENTRY(_r, _api, ...) _r (*(_api))(__VA_ARGS__);</span></span><br></pre></td></tr></table></figure>

<p>platform_names 数组中直接引入了 platform_entries.in 文件中定义的API规范，内部有多个 EGL_ENTRY ，每个里面都对应着api的定义。而最终读取到 platform_names 数组中的内容是其内部定义的方法名，也就是api值，原因前面讲过了。并且在其最后拼接了 nullptr 表示数组的结束。</p>
<p>因此后续可以将 platform_names 数组理解为是 platform_entries.in 文件中定义的那一系列API名。</p>
<p>接着会遍历该数据，然后挨个调用 FindPlatformImplAddr() 方法来查找到其对应的函数指针，然后将值挨个保存给当前 egl_connection_t 实例中的 platform 属性中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/hooks.h</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">platform_impl_t</span> &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;platform_entries.in&quot;</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_platform_entries.cpp</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">implementation_map_t</span> sPlatformImplMap[] = &#123;</span><br><span class="line">        <span class="comment">// clang-format off</span></span><br><span class="line">    &#123; <span class="string">&quot;eglGetDisplay&quot;</span>, (EGLFuncPointer)&amp;eglGetDisplayImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetPlatformDisplay&quot;</span>, (EGLFuncPointer)&amp;eglGetPlatformDisplayImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglInitialize&quot;</span>, (EGLFuncPointer)&amp;eglInitializeImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglTerminate&quot;</span>, (EGLFuncPointer)&amp;eglTerminateImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetConfigs&quot;</span>, (EGLFuncPointer)&amp;eglGetConfigsImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglChooseConfig&quot;</span>, (EGLFuncPointer)&amp;eglChooseConfigImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetConfigAttrib&quot;</span>, (EGLFuncPointer)&amp;eglGetConfigAttribImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreateWindowSurface&quot;</span>, (EGLFuncPointer)&amp;eglCreateWindowSurfaceImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreatePixmapSurface&quot;</span>, (EGLFuncPointer)&amp;eglCreatePixmapSurfaceImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreatePlatformWindowSurface&quot;</span>, (EGLFuncPointer)&amp;eglCreatePlatformWindowSurfaceImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreatePlatformPixmapSurface&quot;</span>, (EGLFuncPointer)&amp;eglCreatePlatformPixmapSurfaceImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreatePbufferSurface&quot;</span>, (EGLFuncPointer)&amp;eglCreatePbufferSurfaceImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglDestroySurface&quot;</span>, (EGLFuncPointer)&amp;eglDestroySurfaceImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglQuerySurface&quot;</span>, (EGLFuncPointer)&amp;eglQuerySurfaceImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglBeginFrame&quot;</span>, (EGLFuncPointer)&amp;eglBeginFrameImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreateContext&quot;</span>, (EGLFuncPointer)&amp;eglCreateContextImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglDestroyContext&quot;</span>, (EGLFuncPointer)&amp;eglDestroyContextImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglMakeCurrent&quot;</span>, (EGLFuncPointer)&amp;eglMakeCurrentImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglQueryContext&quot;</span>, (EGLFuncPointer)&amp;eglQueryContextImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetCurrentContext&quot;</span>, (EGLFuncPointer)&amp;eglGetCurrentContextImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetCurrentSurface&quot;</span>, (EGLFuncPointer)&amp;eglGetCurrentSurfaceImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetCurrentDisplay&quot;</span>, (EGLFuncPointer)&amp;eglGetCurrentDisplayImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglWaitGL&quot;</span>, (EGLFuncPointer)&amp;eglWaitGLImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglWaitNative&quot;</span>, (EGLFuncPointer)&amp;eglWaitNativeImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetError&quot;</span>, (EGLFuncPointer)&amp;eglGetErrorImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglSwapBuffersWithDamageKHR&quot;</span>, (EGLFuncPointer)&amp;eglSwapBuffersWithDamageKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetProcAddress&quot;</span>, (EGLFuncPointer)&amp;eglGetProcAddressImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglSwapBuffers&quot;</span>, (EGLFuncPointer)&amp;eglSwapBuffersImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCopyBuffers&quot;</span>, (EGLFuncPointer)&amp;eglCopyBuffersImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglQueryString&quot;</span>, (EGLFuncPointer)&amp;eglQueryStringImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglQueryStringImplementationANDROID&quot;</span>, (EGLFuncPointer)&amp;eglQueryStringImplementationANDROIDImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglSurfaceAttrib&quot;</span>, (EGLFuncPointer)&amp;eglSurfaceAttribImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglBindTexImage&quot;</span>, (EGLFuncPointer)&amp;eglBindTexImageImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglReleaseTexImage&quot;</span>, (EGLFuncPointer)&amp;eglReleaseTexImageImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglSwapInterval&quot;</span>, (EGLFuncPointer)&amp;eglSwapIntervalImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglWaitClient&quot;</span>, (EGLFuncPointer)&amp;eglWaitClientImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglBindAPI&quot;</span>, (EGLFuncPointer)&amp;eglBindAPIImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglQueryAPI&quot;</span>, (EGLFuncPointer)&amp;eglQueryAPIImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglReleaseThread&quot;</span>, (EGLFuncPointer)&amp;eglReleaseThreadImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreatePbufferFromClientBuffer&quot;</span>, (EGLFuncPointer)&amp;eglCreatePbufferFromClientBufferImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglLockSurfaceKHR&quot;</span>, (EGLFuncPointer)&amp;eglLockSurfaceKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglUnlockSurfaceKHR&quot;</span>, (EGLFuncPointer)&amp;eglUnlockSurfaceKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreateImageKHR&quot;</span>, (EGLFuncPointer)&amp;eglCreateImageKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglDestroyImageKHR&quot;</span>, (EGLFuncPointer)&amp;eglDestroyImageKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreateImage&quot;</span>, (EGLFuncPointer)&amp;eglCreateImageImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglDestroyImage&quot;</span>, (EGLFuncPointer)&amp;eglDestroyImageImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreateSync&quot;</span>, (EGLFuncPointer)&amp;eglCreateSyncImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglDestroySync&quot;</span>, (EGLFuncPointer)&amp;eglDestroySyncImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglClientWaitSync&quot;</span>, (EGLFuncPointer)&amp;eglClientWaitSyncImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetSyncAttrib&quot;</span>, (EGLFuncPointer)&amp;eglGetSyncAttribImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreateSyncKHR&quot;</span>, (EGLFuncPointer)&amp;eglCreateSyncKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglDestroySyncKHR&quot;</span>, (EGLFuncPointer)&amp;eglDestroySyncKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglSignalSyncKHR&quot;</span>, (EGLFuncPointer)&amp;eglSignalSyncKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglClientWaitSyncKHR&quot;</span>, (EGLFuncPointer)&amp;eglClientWaitSyncKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetSyncAttribKHR&quot;</span>, (EGLFuncPointer)&amp;eglGetSyncAttribKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreateStreamKHR&quot;</span>, (EGLFuncPointer)&amp;eglCreateStreamKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglDestroyStreamKHR&quot;</span>, (EGLFuncPointer)&amp;eglDestroyStreamKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglStreamAttribKHR&quot;</span>, (EGLFuncPointer)&amp;eglStreamAttribKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglQueryStreamKHR&quot;</span>, (EGLFuncPointer)&amp;eglQueryStreamKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglQueryStreamu64KHR&quot;</span>, (EGLFuncPointer)&amp;eglQueryStreamu64KHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglQueryStreamTimeKHR&quot;</span>, (EGLFuncPointer)&amp;eglQueryStreamTimeKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreateStreamProducerSurfaceKHR&quot;</span>, (EGLFuncPointer)&amp;eglCreateStreamProducerSurfaceKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglStreamConsumerGLTextureExternalKHR&quot;</span>, (EGLFuncPointer)&amp;eglStreamConsumerGLTextureExternalKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglStreamConsumerAcquireKHR&quot;</span>, (EGLFuncPointer)&amp;eglStreamConsumerAcquireKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglStreamConsumerReleaseKHR&quot;</span>, (EGLFuncPointer)&amp;eglStreamConsumerReleaseKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetStreamFileDescriptorKHR&quot;</span>, (EGLFuncPointer)&amp;eglGetStreamFileDescriptorKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglCreateStreamFromFileDescriptorKHR&quot;</span>, (EGLFuncPointer)&amp;eglCreateStreamFromFileDescriptorKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglWaitSync&quot;</span>, (EGLFuncPointer)&amp;eglWaitSyncImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglWaitSyncKHR&quot;</span>, (EGLFuncPointer)&amp;eglWaitSyncKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglDupNativeFenceFDANDROID&quot;</span>, (EGLFuncPointer)&amp;eglDupNativeFenceFDANDROIDImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglPresentationTimeANDROID&quot;</span>, (EGLFuncPointer)&amp;eglPresentationTimeANDROIDImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetNativeClientBufferANDROID&quot;</span>, (EGLFuncPointer)&amp;eglGetNativeClientBufferANDROIDImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetSystemTimeFrequencyNV&quot;</span>, (EGLFuncPointer)&amp;eglGetSystemTimeFrequencyNVImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetSystemTimeNV&quot;</span>, (EGLFuncPointer)&amp;eglGetSystemTimeNVImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglSetDamageRegionKHR&quot;</span>, (EGLFuncPointer)&amp;eglSetDamageRegionKHRImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetNextFrameIdANDROID&quot;</span>, (EGLFuncPointer)&amp;eglGetNextFrameIdANDROIDImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetCompositorTimingANDROID&quot;</span>, (EGLFuncPointer)&amp;eglGetCompositorTimingANDROIDImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetCompositorTimingSupportedANDROID&quot;</span>, (EGLFuncPointer)&amp;eglGetCompositorTimingSupportedANDROIDImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetFrameTimestampsANDROID&quot;</span>, (EGLFuncPointer)&amp;eglGetFrameTimestampsANDROIDImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;eglGetFrameTimestampSupportedANDROID&quot;</span>, (EGLFuncPointer)&amp;eglGetFrameTimestampSupportedANDROIDImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;glGetString&quot;</span>, (EGLFuncPointer)&amp;glGetStringImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;glGetStringi&quot;</span>, (EGLFuncPointer)&amp;glGetStringiImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;glGetBooleanv&quot;</span>, (EGLFuncPointer)&amp;glGetBooleanvImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;glGetFloatv&quot;</span>, (EGLFuncPointer)&amp;glGetFloatvImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;glGetIntegerv&quot;</span>, (EGLFuncPointer)&amp;glGetIntegervImpl &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;glGetInteger64v&quot;</span>, (EGLFuncPointer)&amp;glGetInteger64vImpl &#125;,</span><br><span class="line">        <span class="comment">// clang-format on</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">EGLFuncPointer <span class="title">FindPlatformImplAddr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">bool</span> DEBUG = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要查找的函数名为空则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">ALOGV</span>(<span class="string">&quot;FindPlatformImplAddr called with null name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历上面定义的 sPlatformImplMap ，然后挨个从该数组中找到当前函数名对应的函数指针值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">NELEM</span>(sPlatformImplMap); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sPlatformImplMap[i].name == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="built_in">ALOGV</span>(<span class="string">&quot;FindPlatformImplAddr found nullptr for sPlatformImplMap[%i].name (%s)&quot;</span>, i, name);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对比函数名</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, sPlatformImplMap[i].name)) &#123;</span><br><span class="line">            <span class="built_in">ALOGV</span>(<span class="string">&quot;FindPlatformImplAddr found %llu for sPlatformImplMap[%i].address (%s)&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)sPlatformImplMap[i].address, i, name);</span><br><span class="line">            <span class="keyword">return</span> sPlatformImplMap[i].address;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;FindPlatformImplAddr did not find an entry for %s&quot;</span>, name);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先可以看到 egl_connection_t.platform 的 platform_impl_t 类型的定义，其实也是引入了 platform_entries.in 文件中的内容，将该文件内部定义的一系列 EGL_ENTRY 通过宏转换成了platform_impl_t 结构体中的一系列函数。正是因为这样，这里才能遍历 platform_names 数组来给 egl_connection_t.platform 中函数赋值。</p>
<blockquote>
<p>其实 platform_names 和 platform(也就是platform_impl_t结构体)是一对，他俩都是从 platform_entries.in 文件中创建出来的，不同的是一个是函数名，一个是函数。</p>
</blockquote>
<p>而赋值操作是通过 FindPlatformImplAddr() 方法来实现的，具体实际就是去 egl_platform_entries.cpp 文件中预定义好的列表中查找对应的函数，比如eglGetDisplay 方法实际会找到 egl_platform_entries.cpp 中的 eglGetDisplayImpl() 方法，那么后续调用 platform.eglGetDisplay 方法时，实际就会转到 egl_platform_entries.cpp 中的 eglGetDisplayImpl() 中来执行的。</p>
<p>至此 egl_connection_t 构造方法执行完毕，此时他内部的 platform 中定义的函数就会有对应的实现了，具体实现是位于 egl_platform_entries.cpp 中的。也就是说， 外部每创建出 egl_connection_t 实例，其内部的 platform 中的函数就会有值了，可以直接用了。所以一开始提到的 gEGLImpl  属性，它内部的 platform 在一开始就自然被赋值过了。</p>
<h4 id="gl-hooks-t"><a href="#gl-hooks-t" class="headerlink" title="gl_hooks_t"></a>gl_hooks_t</h4><p>跟前面gEGLImpl 的定义相同的地方，还有一个定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl.cpp</span></span><br><span class="line"><span class="type">gl_hooks_t</span> gHooks[<span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<p>这是定义了一个 gl_hooks_t 类型的数组属性 gHooks ，他也是全局变量，长度为2。后期可以分别使用：egl_connection_t::GLESv1_INDEX 和 egl_connection_t::GLESv2_INDEX 作为索引来访问该数组。</p>
<p>看看 gl_hooks_t 的定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/hooks.h</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">gl_hooks_t</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">gl_t</span> &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;entries.in&quot;</span></span></span><br><span class="line">    &#125; gl;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">gl_ext_t</span> &#123;</span><br><span class="line">        __eglMustCastToProperFunctionPointerType extensions[MAX_NUMBER_OF_GL_EXTENSIONS];</span><br><span class="line">    &#125; ext;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/entries.in</span></span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glActiveShaderProgram, GLuint pipeline, GLuint program)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glActiveShaderProgramEXT, GLuint pipeline, GLuint program)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glActiveTexture, GLenum texture)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glAlphaFunc, GLenum func, GLfloat ref)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glAlphaFuncQCOM, GLenum func, GLclampf ref)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glAlphaFuncx, GLenum func, GLfixed ref)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glAlphaFuncxOES, GLenum func, GLfixed ref)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glApplyFramebufferAttachmentCMAAINTEL, <span class="type">void</span>)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glAttachShader, GLuint program, GLuint shader)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glBeginConditionalRenderNV, GLuint id, GLenum mode)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glBeginPerfMonitorAMD, GLuint monitor)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glBeginPerfQueryINTEL, GLuint queryHandle)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glBeginQuery, GLenum target, GLuint id)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glBeginQueryEXT, GLenum target, GLuint id)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glBeginTransformFeedback, GLenum primitiveMode)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glBindAttribLocation, GLuint program, GLuint index, <span class="type">const</span> GLchar *name)</span><br><span class="line"><span class="built_in">GL_ENTRY</span>(<span class="type">void</span>, glBindBuffer, GLenum target, GLuint buffer)</span><br><span class="line">.... 省略其他的 ....</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ta他内部又定义了一些结构体，比如 gl_t ，其中又读取了 entries.in 文件中定义的函数，将其填充为 gl_t 结构体内的函数定义，后续就可以使用了。</p>
<p>可以看到entries.in文件中的函数都是 gl 开头的，而前面的 platform_entries.in 文件中定义的都是 egl 开头的。其实这俩分别就是前面提到的 OpenGL ES 和 EGL 的API规范，只有方法名和参数返回值，具体实现并没有，需要去加载动态库so来获取。</p>
<h3 id="eglGetDisplay"><a href="#eglGetDisplay" class="headerlink" title="eglGetDisplay"></a>eglGetDisplay</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/eglApi.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLDisplay <span class="title">eglGetDisplay</span><span class="params">(EGLNativeDisplayType display)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ATRACE_CALL</span>();</span><br><span class="line">    <span class="built_in">clearError</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载 OpenGL es 动态库，初始化OpenGL es的api</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">egl_init_drivers</span>() == EGL_FALSE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_PARAMETER, EGL_NO_DISPLAY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上面 egl_init_drivers 之后，gEGLImpl 中就有值了</span></span><br><span class="line">    <span class="type">egl_connection_t</span>* <span class="type">const</span> cnx = &amp;gEGLImpl;</span><br><span class="line">    <span class="comment">// 从OpenGL es 中获取一个象征屏幕的 EGLDisplay 对象并返回出去</span></span><br><span class="line">    <span class="keyword">return</span> cnx-&gt;platform.<span class="built_in">eglGetDisplay</span>(display);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>eglGetDisplay() 方法很简单，就是接收一个 EGLNativeDisplayType 类型的入参，然后返回一个 EGLDisplay 实例。而这里提到的 EGLNativeDisplayType 和 EGLDisplay 类型具体是什么呢？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/include/EGL/eglplatform.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span>   EGLNativeDisplayType;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/include/EGL/egl.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> *EGLDisplay;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里的 EGLNativeDisplayType 实际对应的是 int ，而 EGLDisplay 实际是 void * 类型，也就是可以指向任何类型的数据。</p>
<blockquote>
<p>关于这里 EGLDisplay 的 void * 定义方式有疑问，可以看看 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/22447153/what-does-typedef-void-key-type-mean-in-c">这里</a> 的讲解</p>
</blockquote>
<p>而外部调用 eglGetDisplay() 方法时的参数一般传入的都是：EGL_DEFAULT_DISPLAY ，它的定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/include/EGL/egl.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EGL_DEFAULT_DISPLAY               EGL_CAST(EGLNativeDisplayType,0)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/include/EGL/eglplatform.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EGL_CAST(type, value) (static_cast<span class="string">&lt;type&gt;</span>(value))</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EGL_CAST(type, value) ((type) (value))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>也就是说，这里传入的 EGL_DEFAULT_DISPLAY 其实就是 0，代表当前获取的 EGLDisplay 是默认的显示设备。</p>
<blockquote>
<p>正如前面所讲的 ：入参 EGLNativeDisplayType 类型实际对应的是int，而这里的 EGL_DEFAULT_DISPLAY 是0，所以可以传入进来。另外，后续就可以把这个 EGLNativeDisplayType 当做是int来理解，或者可以把它当做是某个数组的索引。</p>
</blockquote>
<p>接着回到当前 eglGetDisplay() 方法中的逻辑分析，在该方法中主要的逻辑有两个：</p>
<p>① 加载OpenGL ES 和 EGL 的实现库，也就是加载相关驱动实现。</p>
<p>② 调用内部 platform.eglGetDisplay(display) 去完成真正的逻辑。</p>
<p>其中这里的前者是重点。</p>
<h4 id="egl-init-drivers"><a href="#egl-init-drivers" class="headerlink" title="egl_init_drivers"></a>egl_init_drivers</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">egl_init_drivers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    EGLBoolean res;</span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(&amp;sInitDriverMutex);</span><br><span class="line">    <span class="comment">// 主要执行该方法</span></span><br><span class="line">    res = <span class="built_in">egl_init_drivers_locked</span>();</span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;sInitDriverMutex);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> EGLBoolean <span class="title">egl_init_drivers_locked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sEarlyInitState) &#123;</span><br><span class="line">        <span class="comment">// initialized by static ctor. should be set here.</span></span><br><span class="line">        <span class="keyword">return</span> EGL_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到 Loader 实例，后续使用它来完成 so 库的加载</span></span><br><span class="line">    <span class="function">Loader&amp; <span class="title">loader</span><span class="params">(Loader::getInstance())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在此往后 cnx 就表示的是 gEGLImpl</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">egl_connection_t</span>* cnx = &amp;gEGLImpl;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 给 cnx-&gt;hooks 赋值，将它和全局属性 gHooks 指向同一块地址</span></span><br><span class="line"><span class="comment">     * 后续在 loader.open 方法中会对 cnx-&gt;hooks 中赋值，同时 gHooks 中也就有值了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    cnx-&gt;hooks[<span class="type">egl_connection_t</span>::GLESv1_INDEX] = &amp;gHooks[<span class="type">egl_connection_t</span>::GLESv1_INDEX];</span><br><span class="line">    cnx-&gt;hooks[<span class="type">egl_connection_t</span>::GLESv2_INDEX] = &amp;gHooks[<span class="type">egl_connection_t</span>::GLESv2_INDEX];</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * open() 返回一个 driver_t 实例</span></span><br><span class="line"><span class="comment">     * 这里的入参 cnx 是 gEGLImpl 的地址，所以说 open 方法内部对 cnx 可以进行修改操作，open之后 gEGLImpl 就被填充内容了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    cnx-&gt;dso = loader.<span class="built_in">open</span>(cnx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cnx-&gt;dso) &#123;</span><br><span class="line">        <span class="function">LayerLoader&amp; <span class="title">layer_loader</span><span class="params">(LayerLoader::getInstance())</span></span>;</span><br><span class="line">        layer_loader.<span class="built_in">InitLayers</span>(cnx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果加载成功的话，dso 则是一个 driver_t 实例</span></span><br><span class="line">    <span class="keyword">return</span> cnx-&gt;dso ? EGL_TRUE : EGL_FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在正式开始加载so之前，会先将 gEGLImpl 的 hooks 属性指向全局 gHooks ，这样的话后续对 gEGLImpl.hooks 属性内容的修改都会同步到全局 gHooks 中去。</p>
<p>接着往后，主要逻辑都在：<a href="3c88db7.html">loader.open() </a> 中。而在 open() 方法执行完成之后，这里的入参 cnx ，也就是全局的 gEGLImpl 属性中的：</p>
<p>① egl 属性内的函数定义，都会被赋值为EGL规范所对应的函数实现。</p>
<p>② hooks 数组内每个item的 gl 属性中定义的函数，都会被赋值为 OpenGL ES 规范所对应的函数实现。</p>
<blockquote>
<p>同时：全局属性 gHooks 数组中的gl也就同时被赋值了，他和这里的 hooks 指向同一块儿地址。</p>
</blockquote>
<p>③ libEgl 、 libGles1 和 libGles2 属性存储的是 libEGL.so，libGLESv1_CM.so，libGLESv2.so 这三个库的句柄。</p>
<p>④ dso ：open() 方法的返回值，在当前 egl_init_drivers_locked() 方法中赋值的，实际是一个 driver_t  实例，这个实例内部包装了对应so库句柄。</p>
<p>回到 eglGetDisplay() 方法中来，接下来会调用 gEGLImpl-&gt;platform.eglGetDisplay(display) 方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_platform_entries.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLDisplay <span class="title">eglGetDisplayImpl</span><span class="params">(EGLNativeDisplayType display)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eglGetPlatformDisplayTmpl</span>(EGL_PLATFORM_ANDROID_KHR, display, <span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> EGLDisplay <span class="title">eglGetPlatformDisplayTmpl</span><span class="params">(EGLenum platform, EGLNativeDisplayType display,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            <span class="type">const</span> EGLAttrib* attrib_list)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//  platform 目前只能是 EGL_PLATFORM_ANDROID_KHR</span></span><br><span class="line">    <span class="keyword">if</span> (platform != EGL_PLATFORM_ANDROID_KHR) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_PARAMETER, EGL_NO_DISPLAY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * EGLNativeDisplayType 实际对应的是 int ，因此可以把 display 当做是索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">uintptr_t</span> index = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(display);</span><br><span class="line">    <span class="comment">// NUM_DISPLAYS = 1 ，所以目前只支持一个显示设备，一般也就是 EGL_DEFAULT_DISPLAY = 0</span></span><br><span class="line">    <span class="keyword">if</span> (index &gt;= NUM_DISPLAYS) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_PARAMETER, EGL_NO_DISPLAY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 剩下的逻辑交给 egl_display_t::getFromNativeDisplay() 方法去完成</span></span><br><span class="line">    EGLDisplay dpy = <span class="type">egl_display_t</span>::<span class="built_in">getFromNativeDisplay</span>(display, attrib_list);</span><br><span class="line">    <span class="keyword">return</span> dpy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正如前面所言， cnx-&gt;platform 中的方式在一开始就被赋值了，而这里调用的 eglGetDisplay() 方法实际对应的是 frameworks&#x2F;native&#x2F;opengl&#x2F;libs&#x2F;EGL&#x2F;egl_platform_entries.cpp 文件中的 eglGetDisplayImpl()。</p>
<p>而在最终的 eglGetDisplayImpl() 方法中，会对入参做合法性校验，合法的话才会走真正的：egl_display_t::getFromNativeDisplay() 方法来完成真正的逻辑。</p>
<p>那么接下来就先简单看看这个 egl_display_t 是啥吧，这里先看其定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_display.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EGLAPI</span> <span class="type">egl_display_t</span> &#123; <span class="comment">// marked as EGLAPI for testing purposes</span></span><br><span class="line">    <span class="type">static</span> <span class="type">egl_display_t</span> sDisplay[NUM_DISPLAYS];</span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        NOT_INITIALIZED = <span class="number">0</span>,</span><br><span class="line">        INITIALIZED     = <span class="number">1</span>,</span><br><span class="line">        TERMINATED      = <span class="number">2</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">egl_display_t</span>();</span><br><span class="line">    ~<span class="built_in">egl_display_t</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">EGLBoolean <span class="title">initialize</span><span class="params">(EGLint *major, EGLint *minor)</span></span>;</span><br><span class="line">    <span class="function">EGLBoolean <span class="title">terminate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addObject</span><span class="params">(<span class="type">egl_object_t</span>* object)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">removeObject</span><span class="params">(<span class="type">egl_object_t</span>* object)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">getObject</span><span class="params">(<span class="type">egl_object_t</span>* object)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">egl_display_t</span>* <span class="title">get</span><span class="params">(EGLDisplay dpy)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> EGLDisplay <span class="title">getFromNativeDisplay</span><span class="params">(EGLNativeDisplayType disp, <span class="type">const</span> EGLAttrib* attrib_list)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">EGLBoolean <span class="title">makeCurrent</span><span class="params">(<span class="type">egl_context_t</span>* c, <span class="type">egl_context_t</span>* cur_c,</span></span></span><br><span class="line"><span class="params"><span class="function">            EGLSurface draw, EGLSurface read, EGLContext ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">            EGLSurface impl_draw, EGLSurface impl_read, EGLContext impl_ctx)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">loseCurrent</span><span class="params">(<span class="type">egl_context_t</span> * cur_c)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">isReady</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> (refs &gt; <span class="number">0</span>); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">isValid</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> magic == <span class="string">&#x27;_dpy&#x27;</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">isAlive</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">isValid</span>(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="type">const</span> * <span class="title">getVendorString</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> mVendorString.<span class="built_in">c_str</span>(); &#125;</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="type">const</span> * <span class="title">getVersionString</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> mVersionString.<span class="built_in">c_str</span>(); &#125;</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="type">const</span> * <span class="title">getClientApiString</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> mClientApiString.<span class="built_in">c_str</span>(); &#125;</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="type">const</span> * <span class="title">getExtensionString</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> mExtensionString.<span class="built_in">c_str</span>(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">haveExtension</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name, <span class="type">size_t</span> nameLen = <span class="number">0</span>)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title">getRefsCount</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> refs; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">strings_t</span> &#123;</span><br><span class="line">        <span class="type">char</span> <span class="type">const</span> * vendor;</span><br><span class="line">        <span class="type">char</span> <span class="type">const</span> * version;</span><br><span class="line">        <span class="type">char</span> <span class="type">const</span> * clientApi;</span><br><span class="line">        <span class="type">char</span> <span class="type">const</span> * extensions;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">DisplayImpl</span> &#123;</span><br><span class="line">        <span class="built_in">DisplayImpl</span>() : <span class="built_in">dpy</span>(EGL_NO_DISPLAY), <span class="built_in">state</span>(NOT_INITIALIZED) &#123; &#125;</span><br><span class="line">        EGLDisplay  dpy;</span><br><span class="line">        EGLint      state;</span><br><span class="line">        <span class="type">strings_t</span>   queryString;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">uint32_t</span>        magic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    DisplayImpl     disp;</span><br><span class="line">    <span class="type">bool</span>    finishOnSwap;   </span><br><span class="line">    <span class="type">bool</span>    traceGpuCompletion;</span><br><span class="line">    <span class="type">bool</span>    hasColorSpaceSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">egl_display_ptr</span>;</span><br><span class="line">            <span class="type">uint32_t</span>                    refs;</span><br><span class="line">            <span class="type">bool</span>                        eglIsInitialized;</span><br><span class="line">    <span class="keyword">mutable</span> std::mutex                  lock;</span><br><span class="line">    <span class="keyword">mutable</span> std::mutex                  refLock;</span><br><span class="line">    <span class="keyword">mutable</span> std::condition_variable     refCond;</span><br><span class="line">            std::unordered_set&lt;<span class="type">egl_object_t</span>*&gt; objects;</span><br><span class="line">            std::string mVendorString;</span><br><span class="line">            std::string mVersionString;</span><br><span class="line">            std::string mClientApiString;</span><br><span class="line">            std::string mExtensionString;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在 egl_display_t 类中，定义了较多的变量，这里先只关注 sDisplay，其他的属性和函数等后面遇到了再说，但是这里开始就要对 egl_display_t 有印象了，后续会很多次的遇到它。</p>
<p>egl_display_t 中定义的静态变量 sDisplay ，它是一个 egl_display_t 类型的数组，数组的大小是 NUM_DISPLAYS ，也就是长度是1。</p>
<p>同时 egl_display_t  其构造方法中，没有做其他操作，就是给内部的属性做了初始化赋值而已，这里不在贴代码了。</p>
<p>然后，我们接着前面的 egl_display_t::getFromNativeDisplay() 方法往下去看：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_display.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLDisplay <span class="title">egl_display_t::getFromNativeDisplay</span><span class="params">(EGLNativeDisplayType disp,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="type">const</span> EGLAttrib* attrib_list)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 同样还是检查 disp ，它实际是索引，因此不能超过最大长度</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">uintptr_t</span>(disp) &gt;= NUM_DISPLAYS)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 首先从 sDisplay 数组中找到入参 disp 位置对应的 egl_display_t 实例</span></span><br><span class="line"><span class="comment">     * 然后调用该 egl_display_t 实例的 getPlatformDisplay() 方法来完成后续操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> sDisplay[<span class="built_in">uintptr_t</span>(disp)].<span class="built_in">getPlatformDisplay</span>(disp, attrib_list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">EGLDisplay <span class="title">egl_display_t::getPlatformDisplay</span><span class="params">(EGLNativeDisplayType display,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">const</span> EGLAttrib* attrib_list)</span> </span>&#123;</span><br><span class="line">    std::lock_guard&lt;std::mutex&gt; _l(lock);</span><br><span class="line">    <span class="built_in">ATRACE_CALL</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">Loader&amp; <span class="title">loader</span><span class="params">(Loader::getInstance())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到全局的 gEGLImpl </span></span><br><span class="line">    <span class="type">egl_connection_t</span>* <span class="type">const</span> cnx = &amp;gEGLImpl;</span><br><span class="line">    <span class="comment">// 此时一般情况都是已加载驱动了的</span></span><br><span class="line">    <span class="keyword">if</span> (cnx-&gt;dso) &#123;</span><br><span class="line">        EGLDisplay dpy = EGL_NO_DISPLAY;</span><br><span class="line">        <span class="comment">// cnx-&gt;useAngle 当做false来理解吧</span></span><br><span class="line">        <span class="keyword">if</span> (cnx-&gt;useAngle) &#123;</span><br><span class="line">            EGLint error;</span><br><span class="line">            dpy = <span class="built_in">getPlatformDisplayAngle</span>(display, cnx, attrib_list, &amp;error);</span><br><span class="line">            <span class="keyword">if</span> (error != EGL_NONE) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">setError</span>(error, dpy);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 上面 cnx-&gt;useAngle 不考虑的话，这里的 dpy 此时肯定是 EGL_NO_DISPLAY</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (dpy == EGL_NO_DISPLAY) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 接下来开始调用真正的 egl 对应的函数实现了</span></span><br><span class="line"><span class="comment">             * 而这些函数实现之前在 Loader::open() 中基本已经都赋值过了</span></span><br><span class="line"><span class="comment">             * 这里优先判断并调用 eglGetPlatformDisplay ，传入 EGL_PLATFORM_ANDROID_KHR 可以拿到适合 Android 平台的 Display</span></span><br><span class="line"><span class="comment">             * 而这个方法暂时不考虑，因为google官方提供的 agl 实现中并没有该方法的实现</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (cnx-&gt;egl.eglGetPlatformDisplay) &#123;</span><br><span class="line">                dpy = cnx-&gt;egl.<span class="built_in">eglGetPlatformDisplay</span>(EGL_PLATFORM_ANDROID_KHR, display,</span><br><span class="line">                                                     attrib_list);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 上面的 eglGetPlatformDisplay 可能没有实现，所以这里兜底走 eglGetDisplay</span></span><br><span class="line">            <span class="keyword">if</span>(dpy == EGL_NO_DISPLAY) &#123;</span><br><span class="line">                <span class="keyword">if</span> (attrib_list) &#123;</span><br><span class="line">                    <span class="built_in">ALOGW</span>(<span class="string">&quot;getPlatformDisplay: unexpected attribute list, attributes ignored&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 调用到 egl.cpp 文件中的 eglGetDisplay ，也就是调用到 egl 具体实现的so库中</span></span><br><span class="line">                dpy = cnx-&gt;egl.<span class="built_in">eglGetDisplay</span>(display);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将获取到的 dpy 保存到当前 egl_display_t 实例中的 disp 中</span></span><br><span class="line"><span class="comment">         * 所以至此之后，就可以使用 egl_display_t.disp.dpy 拿到之前 eglGetDisplay 返回的 dpy 了</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        disp.dpy = dpy;</span><br><span class="line">        <span class="keyword">if</span> (dpy == EGL_NO_DISPLAY) &#123;</span><br><span class="line">            loader.<span class="built_in">close</span>(cnx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 注意这里返回的 EGLDisplay 是在入参 display 的基础上加1了</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">EGLDisplay</span>(<span class="built_in">uintptr_t</span>(display) + <span class="number">1U</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即调用到 egl_display_t 中的静态方法 getFromNativeDisplay() 中，在该方法中，会将入参 disp 作为索引，从egl_display_t 中的静态数组 sDisplay 中找到对应的 egl_display_t  实例，然后调用该 egl_display_t  实例的 getPlatformDisplay() 方法来完成后续操作。</p>
<p>接着到了 getPlatformDisplay() 方法中后，会判断 cnx-&gt;dso 是否有值，如果前面的 egl_init_drivers() 方法执行没问题的话，成功加载到了so库，那么此时 cnx-&gt;dso  就是有值的。</p>
<p>然后会先尝试调用 cnx-&gt;egl.eglGetPlatformDisplay() 方法来获取对应的 EGLDisplay ，如果该方法没有对应的实现，那么则调用 cnx-&gt;egl.eglGetDisplay() 方法。</p>
<p>最终将拿到的返回值 EGLDisplay  保存到当前 egl_display_t   实例中的 disp.dpy 属性中。因此可以说 ：egl_display_t. disp.dpy 属性是在调用 eglGetDisplay() 方法是赋值的，赋值为最终的返回值 EGLDisplay。</p>
<p>而接下来就需要去看 cnx-&gt;egl 中的这俩方法了，也就是看到其对应的函数实现了，而我们知道：cnx-&gt;egl 中的函数对应的实现，是从对应的so库中拿到的，我们应该怎么去拿到这些so库的源码呢？正如在 <a href="c4a594c7.html">GLES&amp;EGL-EGL-总述</a> 中所言，EGL 规范对应的实现是由操作系统来提供的，OpenGL ES规范对应的实现是由GPU厂商提供的，这些都是闭源的。我们没法拿到对应的实现库源码，而在Android 源码中提供了一套实现，位于：<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/native/+/refs/tags/android-10.0.0_r25/opengl/libagl/">https://android.googlesource.com/platform/frameworks/native/+/refs/tags/android-10.0.0_r25/opengl/libagl/</a> 目录下，我们后续关于 EGL 和 OpenGLES 的实现都在这个目录下分析，后续提到的 agl 其实指的就是这里的。</p>
<p>而在 libagl 中没有对 egl.eglGetPlatformDisplay() 方法做实现，所以我们只看另外一个方法：eglGetDisplay() 的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libagl/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLDisplay <span class="title">eglGetDisplay</span><span class="params">(NativeDisplayType display)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __ANDROID__</span></span><br><span class="line">    <span class="keyword">if</span> (gGLKey == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;gInitMutex);</span><br><span class="line">        <span class="keyword">if</span> (gGLKey == <span class="number">-1</span>)</span><br><span class="line">            <span class="built_in">pthread_key_create</span>(&amp;gGLKey, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;gInitMutex);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在 agl 中只处理 display 等于 EGL_DEFAULT_DISPLAY ，也就是默认显示设备</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (display == EGL_DEFAULT_DISPLAY) &#123;</span><br><span class="line">        <span class="comment">// 这里先给 dpy 设置1</span></span><br><span class="line">        EGLDisplay dpy = (EGLDisplay)<span class="number">1</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取一个 egl_display_t 实例，然后将其 type 设置为入参 display ，也就是 EGL_DEFAULT_DISPLAY = 0</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">egl_display_t</span>&amp; d = <span class="type">egl_display_t</span>::<span class="built_in">get_display</span>(dpy);</span><br><span class="line">        d.type = display;</span><br><span class="line">        <span class="comment">// 将 dpy 句柄返回出去,这里dpy还是1</span></span><br><span class="line">        <span class="keyword">return</span> dpy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> EGL_NO_DISPLAY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在agl中对于 eglGetDisplay() 的实现比较简单，只处理了 EGL_DEFAULT_DISPLAY 的情况，这个 EGL_DEFAULT_DISPLAY 在前面提到过了，一般外部调用 eglApi 的 eglGetDisplay() 方法时的参数一般传入的都是：EGL_DEFAULT_DISPLAY &#x3D; 0。</p>
<p>这里会先创建一个值是 1 的 EGLDisplay ，然后去调用 egl_display_t::get_display() 方法拿到该 EGLDisplay&#x3D;1 所对应的 egl_display_t 实例，然后修改其 type 值为入参 NativeDisplayType display ，最后返回这个值为1 的 EGLDisplay 。</p>
<p>其他情况的都是返回 EGL_NO_DISPLAY &#x3D; 0 ，也就是没找到该入参 NativeDisplayType 类型的显示设备。</p>
<p>上面又遇到了结构体 egl_display_t，前面不是讲过了嘛？注意这里的 egl_display_t 跟前面的只是同名而已，他俩是位于不同目录文件下的不同定义，这里的是位于 agl 下的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libagl/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">egl_display_t</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 构造方法将内部属性修改为默认值</span></span><br><span class="line">    <span class="built_in">egl_display_t</span>() : <span class="built_in">type</span>(<span class="number">0</span>), <span class="built_in">initialized</span>(<span class="number">0</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">egl_display_t</span>&amp; <span class="title">get_display</span><span class="params">(EGLDisplay dpy)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断传入的 EGLDisplay 是否合法，它可以理解为一个 index 索引</span></span><br><span class="line"><span class="comment">     * 因此就是判断该索引是否在数组范围内 NUM_DISPLAYS</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">static</span> EGLBoolean <span class="title">is_valid</span><span class="params">(EGLDisplay dpy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="built_in">uintptr_t</span>(dpy)<span class="number">-1U</span>) &gt;= NUM_DISPLAYS) ? EGL_FALSE : EGL_TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在 eglGetDisplay 中给它赋值,它存储的就是该 Display 的类型，一般就是 EGL_DEFAULT_DISPLAY</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    NativeDisplayType  type;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在 eglInitialize 中给它赋值，表示该 disp 已经调用过 eglInitialize 方法初始化过了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    std::<span class="type">atomic_size_t</span> initialized;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在 agl 中的 egl.cpp 内也有一个全局的长度为 NUM_DISPLAYS=1 的 egl_display_t 的数组</span></span><br><span class="line"><span class="comment"> * 但这里的 egl_display_t 是位于 agl 中的，而不是外面 egl 中的那个</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">egl_display_t</span> gDisplays[NUM_DISPLAYS];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 传入 EGLDisplay 来查找它所对应的 egl_display_t 实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">egl_display_t</span>&amp; <span class="title">egl_display_t::get_display</span><span class="params">(EGLDisplay dpy)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里要减1</span></span><br><span class="line">    <span class="keyword">return</span> gDisplays[<span class="built_in">uintptr_t</span>(dpy)<span class="number">-1U</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，agl 中的 egl_display_t 比较简单，就俩属性，其中 type 属性类型是 NativeDisplayType ，它内部保存着外部传来的设备类型，一般存储的就是前面提到的 EGL_DEFAULT_DISPLAY 。</p>
<p>而在 agl 中的 egl.cpp 中，同样有一个全局的，长度为 NUM_DISPLAYS 的 egl_display_t 数组，后续可以通过静态方法 egl_display_t::get_display() 来查找数组中对应的egl_display_t 实例，但是需要注意的是，这里传入的是 EGLDisplay 类型的参数，并且在内部会将其减一作为数组索引的。</p>
<blockquote>
<p>所以说，前面提到的egl中的 egl_display_t ，它和这里agl中的 egl_display_t 很类似。</p>
<p><strong>相同点：</strong></p>
<p>①都对应存在一个全局的，长度为 NUM_DISPLAYS 的数组；</p>
<p>②都存在一个静态方法用来获取数组中对应的 egl_display_t 实例，在 egl 中该方法叫做：egl_display_t::getFromNativeDisplay() ，而在这里 agl 中该方法叫做：egl_display_t::get_display() 。</p>
<p><strong>不同点：</strong></p>
<p>① 他俩所处的位置不同，一个处于 egl 中，一个处于 agl 中。但是他俩是一一对应的，只是所处的环境不同而已。</p>
<p>② 用来获取数组中对应的 egl_display_t 实例的对应方法中，入参不同，含义不同。在egl 中该方法叫做：egl_display_t::getFromNativeDisplay() ，接受的参数是：EGLNativeDisplayType ，它是从0开始的，一般就是 0，也就是EGL_DEFAULT_DISPLAY 。而在 agl中该方法叫做：egl_display_t::get_display() ，该方法接受的参数是EGLDisplay，是从1开始的，所以在该方法内部会将入参减一作为数组索引</p>
<p>因此：egl中： EGLNativeDisplayType &#x3D; EGL_DEFAULT_DISPLAY &#x3D; 0 ，对应着agl中的 EGLDisplay &#x3D; 1 。也就是这俩之间差个1，后续会经常看到 减一操作的。</p>
<p>而这俩 egl_display_t 的联系更确切的举个例子：在 agl 中EGLDisplay &#x3D; 1 的 egl_display_t 实例中的  type 存储着 EGLNativeDisplayType &#x3D; EGL_DEFAULT_DISPLAY &#x3D; 0 ；而在 egl 中的 EGLNativeDisplayType &#x3D; EGL_DEFAULT_DISPLAY &#x3D; 0 所对应的 egl_display_t 实例中的 disp.dpy 存储着 EGLDisplay &#x3D; 1 。这俩属性算是互相保存了对方吧。</p>
</blockquote>
<p>此时再次回头看看上面的 agl 中的 eglGetDisplay() 方法，是不是又更好理解了一些？</p>
<p>至此， eglApi 中的 eglGetDisplay() 方法执行完毕了，拿到了最终的返回值： EGLDisplay &#x3D; 1 。</p>
<h3 id="eglInitialize"><a href="#eglInitialize" class="headerlink" title="eglInitialize"></a>eglInitialize</h3><p>前面通过 eglGetDisplay() 方法拿到对应 EGLNativeDisplayType 的 EGLDisplay 之后，接着就可以使用 eglInitialize() 方法来初始化这个 EGLDisplay了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/eglApi.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglInitialize</span><span class="params">(EGLDisplay dpy, EGLint* major, EGLint* minor)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">clearError</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">egl_connection_t</span>* <span class="type">const</span> cnx = &amp;gEGLImpl;</span><br><span class="line">    <span class="comment">// 还是调用到 egl_platform_entries 中</span></span><br><span class="line">    <span class="keyword">return</span> cnx-&gt;platform.<span class="built_in">eglInitialize</span>(dpy, major, minor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_platform_entries.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglInitializeImpl</span><span class="params">(EGLDisplay dpy, EGLint *major, EGLint *minor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 从 sDisplay 中查找到对应的 egl_display_t 实例，并将其封装成 egl_display_ptr</span></span><br><span class="line">    egl_display_ptr dp = <span class="built_in">get_display</span>(dpy);</span><br><span class="line">    <span class="keyword">if</span> (!dp) <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_DISPLAY, (EGLBoolean)EGL_FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// egl_display_ptr 中重载了 -&gt; ，实际操作的是其内部的  egl_display_t-&gt;initialize</span></span><br><span class="line">    EGLBoolean res = dp-&gt;<span class="built_in">initialize</span>(major, minor);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_display.h</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> egl_display_ptr <span class="title">get_display</span><span class="params">(EGLDisplay dpy)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 先从全局的 sDisplay 中查找该 dpy 对应的 egl_display_t</span></span><br><span class="line">    <span class="comment">// 然后将其封装为 egl_display_ptr ，其实可以把 egl_display_ptr 当做 egl_display_t 来理解</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">egl_display_ptr</span>(<span class="type">egl_display_t</span>::<span class="built_in">get</span>(dpy));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">egl_display_ptr</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">egl_display_ptr</span><span class="params">(<span class="type">egl_display_t</span>* dpy)</span>: mDpy(dpy) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">egl_display_ptr</span>(<span class="type">const</span> egl_display_ptr&amp; other): <span class="built_in">mDpy</span>(other.mDpy) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">egl_display_ptr</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用到 -&gt; 时，其实操作的是 mDpy，也就是 egl_display_t</span></span><br><span class="line">    <span class="type">const</span> <span class="type">egl_display_t</span>* <span class="keyword">operator</span>-&gt;() <span class="type">const</span> &#123; <span class="keyword">return</span> mDpy; &#125;</span><br><span class="line">          <span class="type">egl_display_t</span>* <span class="keyword">operator</span>-&gt;()       &#123; <span class="keyword">return</span> mDpy; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="type">egl_display_t</span>* <span class="title">get</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> mDpy; &#125;</span><br><span class="line">          <span class="function"><span class="type">egl_display_t</span>* <span class="title">get</span><span class="params">()</span>       </span>&#123; <span class="keyword">return</span> mDpy; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> mDpy != <span class="literal">nullptr</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">egl_display_t</span>* mDpy;</span><br><span class="line"></span><br><span class="line">    egl_display_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> egl_display_ptr&amp;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_display.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">egl_display_t</span>* <span class="title">egl_display_t::get</span><span class="params">(EGLDisplay dpy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">uintptr_t</span>(dpy) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 需要减一</span></span><br><span class="line">    <span class="type">uintptr_t</span> index = <span class="built_in">uintptr_t</span>(dpy)<span class="number">-1U</span>;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= NUM_DISPLAYS || !sDisplay[index].<span class="built_in">isValid</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 找到对应的 egl_display_t 实例</span></span><br><span class="line">    <span class="keyword">return</span> &amp;sDisplay[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>z在eglApi中调用的方法，最终都是要转到 cnx-&gt;platform ，也就是 egl_platform_entries.cpp 中去执行，这里执行的是：eglInitializeImpl() 方法。</p>
<p>在该方法中，最先通过入参 EGLDisplay dpy 来确定其对应的 egl_display_t 实例，当然这个是位于 egl 中的 egl_display_t 实例。可以看到，这里获取 egl_display_t 实例时，也是从 egl 中的 sDisplay 数组中查找的，在使用 EGLDisplay dpy 来确定索引时，需要将其减一，才是对应的索引值，也就是转换成 EGLNativeDisplayType。</p>
<p>这里在拿到 egl_display_t 实例后，额外还将其包装成了  egl_display_ptr 实例，后续对于 egl_display_ptr 的方法调用都是相当于访问其内部的 egl_display_t 中对应方法，所以这里最终调用到了：egl_display_t::initialize() 方法中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_display.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">egl_display_t::initialize</span><span class="params">(EGLint *major, EGLint *minor)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// scope for refLock</span></span><br><span class="line">        std::unique_lock&lt;std::mutex&gt; _l(refLock);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将当前 egl_display_t 实例中的 refs 数加一，</span></span><br><span class="line"><span class="comment">         * 初始时它是0，第一次自增完变成1，此时不执行if，第二三...次调用时，会执行 if 条件体内的逻辑</span></span><br><span class="line"><span class="comment">         * 这是在多次 initialize 时，除去第一次之外的，都使用第一次的值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        refs++;</span><br><span class="line">        <span class="keyword">if</span> (refs &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span>(!eglIsInitialized) &#123;</span><br><span class="line">                refCond.<span class="built_in">wait</span>(_l);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">egl_connection_t</span>* <span class="type">const</span> cnx = &amp;gEGLImpl;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将之前初始化时拿到的版本号返回出去，也就是说只有第一次才执行真正的初始化</span></span><br><span class="line">            <span class="keyword">if</span> (major != <span class="literal">nullptr</span>) *major = cnx-&gt;major;</span><br><span class="line">            <span class="keyword">if</span> (minor != <span class="literal">nullptr</span>) *minor = cnx-&gt;minor;</span><br><span class="line">            <span class="keyword">return</span> EGL_TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(eglIsInitialized) &#123;</span><br><span class="line">            refCond.<span class="built_in">wait</span>(_l);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// scope for lock</span></span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; _l(lock);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">setGLHooksThreadSpecific</span>(&amp;gHooksNoContext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 第一次 initialize 时会执行到这里</span></span><br><span class="line"><span class="comment">         * 先把 gEGLImpl 中的版本号 major 和 minor 重置掉</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">egl_connection_t</span>* <span class="type">const</span> cnx = &amp;gEGLImpl;</span><br><span class="line">        cnx-&gt;major = <span class="number">-1</span>;</span><br><span class="line">        cnx-&gt;minor = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果驱动已被加载，当然一般都是已经加载过了</span></span><br><span class="line">        <span class="keyword">if</span> (cnx-&gt;dso) &#123;</span><br><span class="line">            <span class="comment">// 拿到当前 egl_display_t 中 disp.dpy 之前保存的 EGLDisplay 值</span></span><br><span class="line">            <span class="comment">// disp.dpy 在前面调用 eglGetDisplay() 方法时就会被赋值为当时对应的 EGLDisplay 值</span></span><br><span class="line">            EGLDisplay idpy = disp.dpy;</span><br><span class="line">            <span class="comment">// 调用 egl 函数去初始化 </span></span><br><span class="line">            <span class="keyword">if</span> (cnx-&gt;egl.<span class="built_in">eglInitialize</span>(idpy, &amp;cnx-&gt;major, &amp;cnx-&gt;minor)) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 初始化成功之后，修改 disp 中的 state 和 queryString 中的值</span></span><br><span class="line"><span class="comment">                 * 所以说，在 eglInitialize() 方法执行之后，state 和 queryString 中就有值了</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                disp.state = <span class="type">egl_display_t</span>::INITIALIZED;</span><br><span class="line"></span><br><span class="line">                disp.queryString.vendor = cnx-&gt;egl.<span class="built_in">eglQueryString</span>(idpy,</span><br><span class="line">                        EGL_VENDOR);</span><br><span class="line">                disp.queryString.version = cnx-&gt;egl.<span class="built_in">eglQueryString</span>(idpy,</span><br><span class="line">                        EGL_VERSION);</span><br><span class="line">                disp.queryString.extensions = cnx-&gt;egl.<span class="built_in">eglQueryString</span>(idpy,</span><br><span class="line">                        EGL_EXTENSIONS);</span><br><span class="line">                disp.queryString.clientApi = cnx-&gt;egl.<span class="built_in">eglQueryString</span>(idpy,</span><br><span class="line">                        EGL_CLIENT_APIS);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">ALOGW</span>(<span class="string">&quot;eglInitialize(%p) failed (%s)&quot;</span>, idpy,</span><br><span class="line">                        <span class="type">egl_tls_t</span>::<span class="built_in">egl_strerror</span>(cnx-&gt;egl.<span class="built_in">eglGetError</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 上面 egl.eglInitialize() 执行之后，内部会给 cnx-&gt;major 和 cnx-&gt;minor 赋值的</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 而这里则是尝试纠正返回的 minor ，返回的版本和支持的api不一致，那么将 egl 版本降级为 1.4</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (cnx-&gt;minor == <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!cnx-&gt;egl.eglCreateImage ||</span><br><span class="line">                !cnx-&gt;egl.eglDestroyImage ||</span><br><span class="line">                !cnx-&gt;egl.eglGetPlatformDisplay ||</span><br><span class="line">                !cnx-&gt;egl.eglCreatePlatformWindowSurface ||</span><br><span class="line">                !cnx-&gt;egl.eglCreatePlatformPixmapSurface ||</span><br><span class="line">                !cnx-&gt;egl.eglCreateSync ||</span><br><span class="line">                !cnx-&gt;egl.eglDestroySync ||</span><br><span class="line">                !cnx-&gt;egl.eglClientWaitSync ||</span><br><span class="line">                !cnx-&gt;egl.eglGetSyncAttrib ||</span><br><span class="line">                !cnx-&gt;egl.eglWaitSync) &#123;</span><br><span class="line">                <span class="built_in">ALOGE</span>(<span class="string">&quot;Driver indicates EGL 1.5 support, but does not have &quot;</span></span><br><span class="line">                      <span class="string">&quot;a critical API&quot;</span>);</span><br><span class="line">                cnx-&gt;minor = <span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sVendorString = &quot;Android&quot;</span></span><br><span class="line">        mVendorString = sVendorString;</span><br><span class="line">        mVersionString.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 先给EGL驱动版本等属性赋初始值 1.4</span></span><br><span class="line"><span class="comment">         * 后续也都是给 mVersionString mExtensionString 等属性赋值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        cnx-&gt;driverVersion = <span class="built_in">EGL_MAKE_VERSION</span>(<span class="number">1</span>, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">        mVersionString = sVersionString14;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 然后根据返回的版本，再设置不同的值</span></span><br><span class="line">        <span class="keyword">if</span> ((cnx-&gt;major == <span class="number">1</span>) &amp;&amp; (cnx-&gt;minor == <span class="number">5</span>)) &#123;</span><br><span class="line">            <span class="comment">// 将其修改为 1.5版本</span></span><br><span class="line">            mVersionString = sVersionString15;</span><br><span class="line">            cnx-&gt;driverVersion = <span class="built_in">EGL_MAKE_VERSION</span>(<span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mVersionString.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="built_in">ALOGW</span>(<span class="string">&quot;Unexpected driver version: %d.%d, want 1.4 or 1.5&quot;</span>, cnx-&gt;major, cnx-&gt;minor);</span><br><span class="line">            mVersionString = sVersionString14;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mClientApiString = sClientApiString;</span><br><span class="line">        mExtensionString = gBuiltinExtensionString;</span><br><span class="line"></span><br><span class="line">        hasColorSpaceSupport = <span class="built_in">findExtension</span>(disp.queryString.extensions, <span class="string">&quot;EGL_KHR_gl_colorspace&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">bool</span> wideColorBoardConfig =</span><br><span class="line">                <span class="built_in">getBool</span>&lt;ISurfaceFlingerConfigs, &amp;ISurfaceFlingerConfigs::hasWideColorDisplay&gt;(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (wideColorBoardConfig &amp;&amp; hasColorSpaceSupport) &#123;</span><br><span class="line">            mExtensionString.<span class="built_in">append</span>(</span><br><span class="line">                    <span class="string">&quot;EGL_EXT_gl_colorspace_scrgb EGL_EXT_gl_colorspace_scrgb_linear &quot;</span></span><br><span class="line">                    <span class="string">&quot;EGL_EXT_gl_colorspace_display_p3_linear EGL_EXT_gl_colorspace_display_p3 &quot;</span></span><br><span class="line">                    <span class="string">&quot;EGL_EXT_gl_colorspace_display_p3_passthrough &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">bool</span> hasHdrBoardConfig =</span><br><span class="line">                <span class="built_in">getBool</span>&lt;ISurfaceFlingerConfigs, &amp;ISurfaceFlingerConfigs::hasHDRDisplay&gt;(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasHdrBoardConfig &amp;&amp; hasColorSpaceSupport) &#123;</span><br><span class="line">            mExtensionString.<span class="built_in">append</span>(<span class="string">&quot;EGL_EXT_gl_colorspace_bt2020_linear EGL_EXT_gl_colorspace_bt2020_pq &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> <span class="type">const</span>* start = gExtensionString;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="type">size_t</span> len = <span class="built_in">strcspn</span>(start, <span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (len) &#123;</span><br><span class="line">                <span class="function"><span class="type">const</span> std::string <span class="title">ext</span><span class="params">(start, len)</span></span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">needsAndroidPEglMitigation</span>() &amp;&amp; ext == <span class="string">&quot;EGL_EXT_image_gl_colorspace&quot;</span> &amp;&amp;</span><br><span class="line">                    <span class="built_in">findExtension</span>(disp.queryString.extensions, <span class="string">&quot;EGL_KHR_image_gl_colorspace&quot;</span>)) &#123;</span><br><span class="line">                    mExtensionString.<span class="built_in">append</span>(<span class="string">&quot;EGL_EXT_image_gl_colorspace &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">findExtension</span>(disp.queryString.extensions, ext.<span class="built_in">c_str</span>(), len)) &#123;</span><br><span class="line">                    mExtensionString.<span class="built_in">append</span>(ext + <span class="string">&quot; &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                start += len;</span><br><span class="line">                start += (*start == <span class="string">&#x27; &#x27;</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (*start != <span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 着色器的初始化，先不管</span></span><br><span class="line">        <span class="type">egl_cache_t</span>::<span class="built_in">get</span>()-&gt;<span class="built_in">initialize</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 读取系统属性，来修改当前 egl_display_t 中的 finishOnSwap、traceGpuCompletion 属性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">char</span> value[PROPERTY_VALUE_MAX];</span><br><span class="line">        <span class="built_in">property_get</span>(<span class="string">&quot;debug.egl.finish&quot;</span>, value, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">atoi</span>(value)) &#123;</span><br><span class="line">            finishOnSwap = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">property_get</span>(<span class="string">&quot;debug.egl.traceGpuCompletion&quot;</span>, value, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">atoi</span>(value)) &#123;</span><br><span class="line">            traceGpuCompletion = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 最后会将纠正之后的 版本号保存给入参，外部就可以收到结果了</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (major != <span class="literal">nullptr</span>) *major = cnx-&gt;major;</span><br><span class="line">        <span class="keyword">if</span> (minor != <span class="literal">nullptr</span>) *minor = cnx-&gt;minor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最后一步，修改当前 egl_display_t 中的 eglIsInitialized 属性为true，</span></span><br><span class="line"><span class="comment">     * 表示该 egl_display_t 已经初始化过了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &#123; <span class="comment">// scope for refLock</span></span><br><span class="line">        std::unique_lock&lt;std::mutex&gt; _l(refLock);</span><br><span class="line">        eglIsInitialized = <span class="literal">true</span>;</span><br><span class="line">        refCond.<span class="built_in">notify_all</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EGL_TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 egl_display_t::initialize() 方法中，会根据当前 egl_display_t 实例中的  refs 属性来判断目前是第几次调用当前方法。</p>
<p>①如果是第一次调用，那么会执行后续的初始化逻辑。</p>
<p>②如果不是第一次调用，那么会直接返回第一次初始化时保存的版本号等信息，这些信息是保存在  gEGLImpl 中的，比如 gEGLImpl.major 和 gEGLImpl.minor 属性分别保存着当前 EGL 实现库中实现的 EGL 版本。</p>
<p>接下来主要看上面的第一种情况，这种情况，会拿到当前 egl_display_t 实例所对应的  EGLDisplay 实例，然后再调用 cnx-&gt;egl.eglInitialize() 方法来完成该 EGLDisplay 的初始化，这是调用到 libagl 那边的，那就是让 EGL 实现库那边去初始化该 EGLDisplay 。</p>
<blockquote>
<p>获取 EGLDisplay 是从当前 egl_display_t 实例中的  disp.dpy 中拿到的，而它正好是前面 调用 eglGetDisplay() 方法时保存的。</p>
</blockquote>
<p>下面看看那 libagl 那边是怎么实现的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libagl/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 一些常量属性，表示当前 EGL 实现库的信息，比如版本号是 1.2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VERSION_MAJOR 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VERSION_MINOR 2</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> <span class="type">const</span> * <span class="type">const</span> gVendorString     = <span class="string">&quot;Google Inc.&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> <span class="type">const</span> * <span class="type">const</span> gVersionString    = <span class="string">&quot;1.2 Android Driver 1.2.0&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> <span class="type">const</span> * <span class="type">const</span> gClientApiString  = <span class="string">&quot;OpenGL_ES&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> <span class="type">const</span> * <span class="type">const</span> gExtensionsString =</span><br><span class="line">        <span class="string">&quot;EGL_KHR_fence_sync &quot;</span></span><br><span class="line">        <span class="string">&quot;EGL_KHR_image_base &quot;</span></span><br><span class="line">        <span class="comment">// &quot;KHR_image_pixmap &quot;</span></span><br><span class="line">        <span class="string">&quot;EGL_ANDROID_image_native_buffer &quot;</span></span><br><span class="line">        <span class="string">&quot;EGL_ANDROID_swap_rectangle &quot;</span></span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglInitialize</span><span class="params">(EGLDisplay dpy, EGLint *major, EGLint *minor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 判断入参 dpy 是否合法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="type">egl_display_t</span>::<span class="built_in">is_valid</span>(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_DISPLAY, EGL_FALSE);</span><br><span class="line"></span><br><span class="line">    EGLBoolean res = EGL_TRUE;</span><br><span class="line">    <span class="comment">// 从 gDisplays 中取出 dpy-1 位置的 egl_display_t </span></span><br><span class="line">    <span class="type">egl_display_t</span>&amp; d = <span class="type">egl_display_t</span>::<span class="built_in">get_display</span>(dpy);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将其内部的 initialized 自增1 ,也就是从0变为1 表示已经初始化了</span></span><br><span class="line">    <span class="keyword">if</span> (d.initialized.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_acquire) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// initialize stuff here if needed</span></span><br><span class="line">        <span class="comment">//pthread_mutex_lock(&amp;gInitMutex);</span></span><br><span class="line">        <span class="comment">//pthread_mutex_unlock(&amp;gInitMutex);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 把内部预置好的 version 返回出去,major 是主版本， minor 是次版本，也就是 1.2</span></span><br><span class="line">    <span class="keyword">if</span> (res == EGL_TRUE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (major != <span class="literal">NULL</span>) *major = VERSION_MAJOR;</span><br><span class="line">        <span class="keyword">if</span> (minor != <span class="literal">NULL</span>) *minor = VERSION_MINOR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">eglQueryString</span><span class="params">(EGLDisplay dpy, EGLint name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="type">egl_display_t</span>::<span class="built_in">is_valid</span>(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_DISPLAY, (<span class="type">const</span> <span class="type">char</span>*)<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (name) &#123;</span><br><span class="line">        <span class="keyword">case</span> EGL_VENDOR:</span><br><span class="line">            <span class="keyword">return</span> gVendorString;</span><br><span class="line">        <span class="keyword">case</span> EGL_VERSION:</span><br><span class="line">            <span class="keyword">return</span> gVersionString;</span><br><span class="line">        <span class="keyword">case</span> EGL_EXTENSIONS:</span><br><span class="line">            <span class="keyword">return</span> gExtensionsString;</span><br><span class="line">        <span class="keyword">case</span> EGL_CLIENT_APIS:</span><br><span class="line">            <span class="keyword">return</span> gClientApiString;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_PARAMETER, (<span class="type">const</span> <span class="type">char</span> *)<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>agl那边的实现很简单，就两部：</p>
<p>① 拿到该 EGLDisplay 在 agl 这边对应的 egl_display_t 实例，然后将该 egl_display_t 实例的 initialized 属性从0自增为1，表示该 EGLDisplay 已经在 agl 这边被初始化过了。</p>
<p>② 将内部定义好的版本号返回出去，当前我看的这个版本是 EGL 的 1.2 的实现版本。</p>
<p>额外的在 agl 这边的 eglQueryString() 方法中可以支持指定key 的查询，用来查询该 EGL 实现的其他信息，这些信息都是已经定义好的常量，直接返回就行了。而这个 eglQueryString() 方法后面会遇到，这里提前讲一下。</p>
<p>agl 那边的 eglInitialize() 方法执行完毕后，入参 cnx-&gt;major 和 cnx-&gt;minor 中就有值了，也就是 gEGLImpl.major 和 gEGLImpl.minor 中就有值了。</p>
<p>接着往下就是完成一些属性赋值，以及版本号的纠正，这些暂时先不讲了，等后面遇到了再说吧。</p>
<p>到最后一步，会将当前 egl_display_t 实例（位于 egl 中，而不是 agl 中的 egl_display_t）中的 eglIsInitialized 属性修改为 true ，表示初始化成功了。</p>
<p>现在看来， eglInitialize() 方法中逻辑还算是比较简单的，就是修改了入参 EGLDisplay 所对应的 两个 egl_display_t 实例(一个是 egl 中的，一个是agl中的) 中的属性，分别表示这俩egl_display_t 被初始化过了，最后将从 agl 中读取到的 EGL实现版本号 保存并返回出去。</p>
<h3 id="eglGetConfigs"><a href="#eglGetConfigs" class="headerlink" title="eglGetConfigs"></a>eglGetConfigs</h3><p>在 eglInitialize() 方法执行之后，也就是初始化完成之后。就可以调用eglGetConfigs() 方法来获取当前系统中支持的配置，系统支持的配置通常是利用系统硬件提供最好的性能。</p>
<p>接下来看源码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/eglApi.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglGetConfigs</span><span class="params">(EGLDisplay dpy, EGLConfig* configs, EGLint config_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                         EGLint* num_config)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">clearError</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">egl_connection_t</span>* <span class="type">const</span> cnx = &amp;gEGLImpl;</span><br><span class="line">    <span class="keyword">return</span> cnx-&gt;platform.<span class="built_in">eglGetConfigs</span>(dpy, configs, config_size, num_config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl_platform_entries.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglGetConfigsImpl</span><span class="params">(EGLDisplay dpy,</span></span></span><br><span class="line"><span class="params"><span class="function">                             EGLConfig *configs,</span></span></span><br><span class="line"><span class="params"><span class="function">                             EGLint config_size, EGLint *num_config)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//拿到该 EGLDisplay 对应的 egl_display_ptr ，实际就是 egl_display_t</span></span><br><span class="line">    <span class="type">const</span> egl_display_ptr dp = <span class="built_in">validate_display</span>(dpy);</span><br><span class="line">    <span class="keyword">if</span> (!dp) <span class="keyword">return</span> EGL_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// num_config 不为空，为空则表示参数异常直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (num_config==<span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_PARAMETER, (EGLBoolean)EGL_FALSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EGLBoolean res = EGL_FALSE;</span><br><span class="line">    *num_config = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">egl_connection_t</span>* <span class="type">const</span> cnx = &amp;gEGLImpl;</span><br><span class="line">    <span class="keyword">if</span> (cnx-&gt;dso) &#123;</span><br><span class="line">        <span class="comment">// dp-&gt;disp.dpy 和入参 dpy 一样</span></span><br><span class="line">        res = cnx-&gt;egl.<span class="built_in">eglGetConfigs</span>(dp-&gt;disp.dpy, configs, config_size, num_config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/native/opengl/libs/EGL/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">egl_display_ptr <span class="title">validate_display</span><span class="params">(EGLDisplay dpy)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 拿到该 EGLDisplay 对应的 egl_display_ptr ，实际就是 egl_display_t</span></span><br><span class="line">    egl_display_ptr dp = <span class="built_in">get_display</span>(dpy);</span><br><span class="line">    <span class="keyword">if</span> (!dp)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_DISPLAY, <span class="built_in">egl_display_ptr</span>(<span class="literal">nullptr</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * isReady() 方法中会判断该 egl_display_t 内部的 refs 是否大于0 ，大于0则返回true，否则返回 false</span></span><br><span class="line"><span class="comment">     * 而只要你之前调用过 eglInitialize() 方法来初始化当前 dpy，那么其 refs 肯定大于0</span></span><br><span class="line"><span class="comment">     * 所以这里判断的就是该  dpy 之前是否被初始化过</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!dp-&gt;<span class="built_in">isReady</span>()) </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_NOT_INITIALIZED, <span class="built_in">egl_display_ptr</span>(<span class="literal">nullptr</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先不管 eglGetConfigs() 方法的参数都代表啥意思，你暂时只需要动第一个参数：EGLDisplay dpy 是啥就行了，他是啥？我不说，你肯定知道。</p>
<p>eglGetConfigs() 方法中最终转到 eglGetConfigsImpl() 中，首先会调用 validate_display() 方法来拿到该 dpy 对应的 egl_display_ptr ，实际就是 egl_display_t 。在 validate_display() 方法中会额外通过 ready() 方法来判断该 dpy 之前有没有没初始化过，所以说：eglGetConfigs() 方法必须在 eglInitialize() 方法之后执行。</p>
<p>接着会调用 cnx-&gt;egl.eglGetConfigs() 方法，就是调用到其对应的实现那边，也就是 agl 那边。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libagl/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglGetConfigs</span><span class="params">(   EGLDisplay dpy,</span></span></span><br><span class="line"><span class="params"><span class="function">                            EGLConfig *configs,</span></span></span><br><span class="line"><span class="params"><span class="function">                            EGLint config_size, EGLint *num_config)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 入参的合法性判断 </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="type">egl_display_t</span>::<span class="built_in">is_valid</span>(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_DISPLAY, EGL_FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ggl_unlikely</span>(num_config==<span class="literal">NULL</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_PARAMETER, EGL_FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到 gConfigs 数组的长度</span></span><br><span class="line">    GLint numConfigs = <span class="built_in">NELEM</span>(gConfigs);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 入参 configs 为空的话，则表示这次只是查询：内部支持的所有配置数量</span></span><br><span class="line"><span class="comment">     * 所以此时只给 num_config 赋值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!configs) &#123;</span><br><span class="line">        *num_config = numConfigs;</span><br><span class="line">        <span class="keyword">return</span> EGL_TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// configs 不为空，那么此时往 configs 中填充配置信息</span></span><br><span class="line">    <span class="comment">// 填充多少个配置信息，是以 config_size 为准的</span></span><br><span class="line">    GLint i;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span> ; i&lt;numConfigs &amp;&amp; i&lt;config_size ; i++) &#123;</span><br><span class="line">        *configs++ = (EGLConfig)(<span class="type">uintptr_t</span>)i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回了多少个配置，此时保存到 num_config 中</span></span><br><span class="line">    <span class="comment">// 所以说最终 num_config 可能不等于 config_size，因为 numConfigs 可能小于 num_config</span></span><br><span class="line">    *num_config = i;</span><br><span class="line">    <span class="keyword">return</span> EGL_TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下是当前EGL支持的配置</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">config_pair_t</span> <span class="type">const</span> config_0_attribute_list[] = &#123;</span><br><span class="line">        &#123; EGL_BUFFER_SIZE,     <span class="number">16</span> &#125;,</span><br><span class="line">        &#123; EGL_ALPHA_SIZE,       <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_BLUE_SIZE,        <span class="number">5</span> &#125;,</span><br><span class="line">        &#123; EGL_GREEN_SIZE,       <span class="number">6</span> &#125;,</span><br><span class="line">        &#123; EGL_RED_SIZE,         <span class="number">5</span> &#125;,</span><br><span class="line">        &#123; EGL_DEPTH_SIZE,       <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_CONFIG_ID,        <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_NATIVE_VISUAL_ID, GGL_PIXEL_FORMAT_RGB_565 &#125;,</span><br><span class="line">        &#123; EGL_SURFACE_TYPE,     EGL_WINDOW_BIT|EGL_PBUFFER_BIT|EGL_PIXMAP_BIT &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">config_pair_t</span> <span class="type">const</span> config_1_attribute_list[] = &#123;</span><br><span class="line">        &#123; EGL_BUFFER_SIZE,     <span class="number">16</span> &#125;,</span><br><span class="line">        &#123; EGL_ALPHA_SIZE,       <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_BLUE_SIZE,        <span class="number">5</span> &#125;,</span><br><span class="line">        &#123; EGL_GREEN_SIZE,       <span class="number">6</span> &#125;,</span><br><span class="line">        &#123; EGL_RED_SIZE,         <span class="number">5</span> &#125;,</span><br><span class="line">        &#123; EGL_DEPTH_SIZE,      <span class="number">16</span> &#125;,</span><br><span class="line">        &#123; EGL_CONFIG_ID,        <span class="number">1</span> &#125;,</span><br><span class="line">        &#123; EGL_NATIVE_VISUAL_ID, GGL_PIXEL_FORMAT_RGB_565 &#125;,</span><br><span class="line">        &#123; EGL_SURFACE_TYPE,     EGL_WINDOW_BIT|EGL_PBUFFER_BIT|EGL_PIXMAP_BIT &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RGB 888 configs</span></span><br><span class="line"><span class="type">static</span> <span class="type">config_pair_t</span> <span class="type">const</span> config_2_attribute_list[] = &#123;</span><br><span class="line">        &#123; EGL_BUFFER_SIZE,     <span class="number">32</span> &#125;,</span><br><span class="line">        &#123; EGL_ALPHA_SIZE,       <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_BLUE_SIZE,        <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_GREEN_SIZE,       <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_RED_SIZE,         <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_DEPTH_SIZE,       <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_CONFIG_ID,        <span class="number">6</span> &#125;,</span><br><span class="line">        &#123; EGL_NATIVE_VISUAL_ID, GGL_PIXEL_FORMAT_RGBX_8888 &#125;,</span><br><span class="line">        &#123; EGL_SURFACE_TYPE,     EGL_WINDOW_BIT|EGL_PBUFFER_BIT|EGL_PIXMAP_BIT &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">config_pair_t</span> <span class="type">const</span> config_3_attribute_list[] = &#123;</span><br><span class="line">        &#123; EGL_BUFFER_SIZE,     <span class="number">32</span> &#125;,</span><br><span class="line">        &#123; EGL_ALPHA_SIZE,       <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_BLUE_SIZE,        <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_GREEN_SIZE,       <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_RED_SIZE,         <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_DEPTH_SIZE,      <span class="number">16</span> &#125;,</span><br><span class="line">        &#123; EGL_CONFIG_ID,        <span class="number">7</span> &#125;,</span><br><span class="line">        &#123; EGL_NATIVE_VISUAL_ID, GGL_PIXEL_FORMAT_RGBX_8888 &#125;,</span><br><span class="line">        &#123; EGL_SURFACE_TYPE,     EGL_WINDOW_BIT|EGL_PBUFFER_BIT|EGL_PIXMAP_BIT &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8888 configs</span></span><br><span class="line"><span class="type">static</span> <span class="type">config_pair_t</span> <span class="type">const</span> config_4_attribute_list[] = &#123;</span><br><span class="line">        &#123; EGL_BUFFER_SIZE,     <span class="number">32</span> &#125;,</span><br><span class="line">        &#123; EGL_ALPHA_SIZE,       <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_BLUE_SIZE,        <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_GREEN_SIZE,       <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_RED_SIZE,         <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_DEPTH_SIZE,       <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_CONFIG_ID,        <span class="number">2</span> &#125;,</span><br><span class="line">        &#123; EGL_NATIVE_VISUAL_ID, GGL_PIXEL_FORMAT_RGBA_8888 &#125;,</span><br><span class="line">        &#123; EGL_SURFACE_TYPE,     EGL_WINDOW_BIT|EGL_PBUFFER_BIT|EGL_PIXMAP_BIT &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">config_pair_t</span> <span class="type">const</span> config_5_attribute_list[] = &#123;</span><br><span class="line">        &#123; EGL_BUFFER_SIZE,     <span class="number">32</span> &#125;,</span><br><span class="line">        &#123; EGL_ALPHA_SIZE,       <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_BLUE_SIZE,        <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_GREEN_SIZE,       <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_RED_SIZE,         <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_DEPTH_SIZE,      <span class="number">16</span> &#125;,</span><br><span class="line">        &#123; EGL_CONFIG_ID,        <span class="number">3</span> &#125;,</span><br><span class="line">        &#123; EGL_NATIVE_VISUAL_ID, GGL_PIXEL_FORMAT_RGBA_8888 &#125;,</span><br><span class="line">        &#123; EGL_SURFACE_TYPE,     EGL_WINDOW_BIT|EGL_PBUFFER_BIT|EGL_PIXMAP_BIT &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A8 configs</span></span><br><span class="line"><span class="type">static</span> <span class="type">config_pair_t</span> <span class="type">const</span> config_6_attribute_list[] = &#123;</span><br><span class="line">        &#123; EGL_BUFFER_SIZE,      <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_ALPHA_SIZE,       <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_BLUE_SIZE,        <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_GREEN_SIZE,       <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_RED_SIZE,         <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_DEPTH_SIZE,       <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_CONFIG_ID,        <span class="number">4</span> &#125;,</span><br><span class="line">        &#123; EGL_NATIVE_VISUAL_ID, GGL_PIXEL_FORMAT_A_8 &#125;,</span><br><span class="line">        &#123; EGL_SURFACE_TYPE,     EGL_WINDOW_BIT|EGL_PBUFFER_BIT|EGL_PIXMAP_BIT &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">config_pair_t</span> <span class="type">const</span> config_7_attribute_list[] = &#123;</span><br><span class="line">        &#123; EGL_BUFFER_SIZE,      <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_ALPHA_SIZE,       <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_BLUE_SIZE,        <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_GREEN_SIZE,       <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_RED_SIZE,         <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_DEPTH_SIZE,      <span class="number">16</span> &#125;,</span><br><span class="line">        &#123; EGL_CONFIG_ID,        <span class="number">5</span> &#125;,</span><br><span class="line">        &#123; EGL_NATIVE_VISUAL_ID, GGL_PIXEL_FORMAT_A_8 &#125;,</span><br><span class="line">        &#123; EGL_SURFACE_TYPE,     EGL_WINDOW_BIT|EGL_PBUFFER_BIT|EGL_PIXMAP_BIT &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BGRA 8888 config</span></span><br><span class="line"><span class="type">static</span> <span class="type">config_pair_t</span> <span class="type">const</span> config_8_attribute_list[] = &#123;</span><br><span class="line">        &#123; EGL_BUFFER_SIZE,     <span class="number">32</span> &#125;,</span><br><span class="line">        &#123; EGL_ALPHA_SIZE,       <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_BLUE_SIZE,        <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_GREEN_SIZE,       <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_RED_SIZE,         <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_DEPTH_SIZE,       <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; EGL_CONFIG_ID,        <span class="number">8</span> &#125;,</span><br><span class="line">        &#123; EGL_NATIVE_VISUAL_ID, GGL_PIXEL_FORMAT_BGRA_8888 &#125;,</span><br><span class="line">        &#123; EGL_SURFACE_TYPE,     EGL_WINDOW_BIT|EGL_PBUFFER_BIT|EGL_PIXMAP_BIT &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 内部存储着目前支持的 config 类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">configs_t</span> <span class="type">const</span> gConfigs[] = &#123;</span><br><span class="line">        &#123; config_0_attribute_list, <span class="built_in">NELEM</span>(config_0_attribute_list) &#125;,</span><br><span class="line">        &#123; config_1_attribute_list, <span class="built_in">NELEM</span>(config_1_attribute_list) &#125;,</span><br><span class="line">        &#123; config_2_attribute_list, <span class="built_in">NELEM</span>(config_2_attribute_list) &#125;,</span><br><span class="line">        &#123; config_3_attribute_list, <span class="built_in">NELEM</span>(config_3_attribute_list) &#125;,</span><br><span class="line">        &#123; config_4_attribute_list, <span class="built_in">NELEM</span>(config_4_attribute_list) &#125;,</span><br><span class="line">        &#123; config_5_attribute_list, <span class="built_in">NELEM</span>(config_5_attribute_list) &#125;,</span><br><span class="line">        &#123; config_6_attribute_list, <span class="built_in">NELEM</span>(config_6_attribute_list) &#125;,</span><br><span class="line">        &#123; config_7_attribute_list, <span class="built_in">NELEM</span>(config_7_attribute_list) &#125;,</span><br><span class="line">        &#123; config_8_attribute_list, <span class="built_in">NELEM</span>(config_8_attribute_list) &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在agl那边的 eglGetConfigs() 方法中，首先会拿到其内部提前定义好的 gConfigs 数组的长度，这个 gConfigs 数组中存储的就是当前 EGL 实现库中支持的所有的配置信息。</p>
<p>接着会分为两种情况来处理：</p>
<p>① 入参 configs 为空时，此时只给入参 num_config 赋值为 gConfigs 数组的长度。</p>
<p>这种情况适用于外部想知道EGL在当前系统上总共支持多少种配置，所以会预先进来查询一下总数量，然后后续再分配指定数量的 configs 来取内部所有的配置。</p>
<p>有点类似Android中加载 Bitmap 时设置的 inJustDecodeBounds 标识，true时只返回其宽高，后续设置成 false 再拿真正的内容。</p>
<p>② 入参 configs 不为空，此时另外一个参数 config_size 会指定该 configs 的长度，这样内部在给这个 configs 中复制数据时就知道复制多少个了。</p>
<p>这种情况下，会将对应的索引保存到 configs 中。可以看到 configs 其实是 EGLConfig 类型的数组，但是代码中实际存储的是 gConfigs 数组的索引值，也就是int 数组。</p>
<blockquote>
<p>EGLConfig 的定义是 ：typedef void *EGLConfig; ，也就是可以存放任何类型的值，这些值外部拿到之后也不需要自己去操作使用，只需要在后续合适的时候把它传到 EGL 中来，此时内部看到 EGLConfig 自然把它当做 int 来用就行了。italy常量也类似，比如 EGLDisplay。</p>
<p>这种方式在库的开发中很常见，详见 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/22447153/what-does-typedef-void-key-type-mean-in-c">这里</a> 的讲解。</p>
</blockquote>
<p>现在，你对 eglGetConfigs() 方法的入参就理解了吧。</p>
<blockquote>
<p>有没有发现，你看这些逻辑越来越简单了，哈哈接着看吧。</p>
</blockquote>
<h3 id="eglChooseConfig"><a href="#eglChooseConfig" class="headerlink" title="eglChooseConfig"></a>eglChooseConfig</h3><p>让 EGL 去给你返回符合你要求的配置，你的要求可以在入参attrib_list 中指定，它是一个数组，最后一位放置 EGL_NONE 来作为结束，比如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> EGLint attribs[] = &#123;</span><br><span class="line">        EGL_RED_SIZE,   <span class="number">8</span>,</span><br><span class="line">        EGL_GREEN_SIZE, <span class="number">8</span>,</span><br><span class="line">        EGL_BLUE_SIZE,  <span class="number">8</span>,</span><br><span class="line">        EGL_DEPTH_SIZE, <span class="number">0</span>,</span><br><span class="line">        EGL_NONE</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>eglChooseConfig() 方法中还是会转到 eglChooseConfigImpl() 中去实现，最终还是会调用到 cnx-&gt;egl.eglChooseConfig() 方法内去指定，也就是执行到 agl 那边去执行剩余逻辑。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/native/opengl/libagl/egl.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">EGLBoolean <span class="title">eglChooseConfig</span><span class="params">( EGLDisplay dpy, <span class="type">const</span> EGLint *attrib_list,</span></span></span><br><span class="line"><span class="params"><span class="function">                            EGLConfig *configs, EGLint config_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                            EGLint *num_config)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="type">egl_display_t</span>::<span class="built_in">is_valid</span>(dpy) == EGL_FALSE)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_DISPLAY, EGL_FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ggl_unlikely</span>(num_config==<span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setError</span>(EGL_BAD_PARAMETER, EGL_FALSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// attrib_list 为空则给它一个默认值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ggl_unlikely</span>(attrib_list==<span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="type">static</span> <span class="type">const</span> EGLint dummy = EGL_NONE;</span><br><span class="line">        attrib_list = &amp;dummy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> numAttributes = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 拿到 gConfigs 数组中列出来的支持的配置数</span></span><br><span class="line">    <span class="type">int</span> numConfigs =  <span class="built_in">NELEM</span>(gConfigs);</span><br><span class="line">    <span class="comment">// 匹配标识</span></span><br><span class="line">    <span class="type">uint32_t</span> possibleMatch = (<span class="number">1</span>&lt;&lt;numConfigs)<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始匹配入参 attrib_list 中指定的参数</span></span><br><span class="line">    <span class="keyword">while</span>(possibleMatch &amp;&amp; *attrib_list != EGL_NONE) &#123;</span><br><span class="line">        numAttributes++;</span><br><span class="line">        EGLint attr = *attrib_list++;</span><br><span class="line">        EGLint val  = *attrib_list++;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span> ; possibleMatch &amp;&amp; i&lt;numConfigs ; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(possibleMatch &amp; (<span class="number">1</span>&lt;&lt;i)))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">isAttributeMatching</span>(i, attr, val) == <span class="number">0</span>) &#123;</span><br><span class="line">                possibleMatch &amp;= ~(<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历 config_defaults 数组去查找</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> j=<span class="number">0</span> ; possibleMatch &amp;&amp; j&lt;<span class="built_in">NELEM</span>(config_defaults) ; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">binarySearch</span>&lt;<span class="type">config_pair_t</span>&gt;(</span><br><span class="line">                (<span class="type">config_pair_t</span> <span class="type">const</span>*)attrib_list,</span><br><span class="line">                <span class="number">0</span>, numAttributes<span class="number">-1</span>,</span><br><span class="line">                config_defaults[j].key) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span> ; possibleMatch &amp;&amp; i&lt;numConfigs ; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(possibleMatch &amp; (<span class="number">1</span>&lt;&lt;i)))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">isAttributeMatching</span>(i,</span><br><span class="line">                        config_defaults[j].key,</span><br><span class="line">                        config_defaults[j].value) == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    possibleMatch &amp;= ~(<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将找到的结果设置给入参</span></span><br><span class="line">    <span class="type">int</span> n=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (possibleMatch) &#123;</span><br><span class="line">        <span class="comment">// 如果入参  configs 不为空，则将找到的配置索引值保存给它</span></span><br><span class="line">        <span class="keyword">if</span> (configs) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span> ; config_size &amp;&amp; i&lt;numConfigs ; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (possibleMatch &amp; (<span class="number">1</span>&lt;&lt;i)) &#123;</span><br><span class="line">                    *configs++ = (EGLConfig)(<span class="type">uintptr_t</span>)i;</span><br><span class="line">                    config_size--;</span><br><span class="line">                    n++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 入参  configs 为空，则只返回找到的配置个数</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span> ; i&lt;numConfigs ; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (possibleMatch &amp; (<span class="number">1</span>&lt;&lt;i)) &#123;</span><br><span class="line">                    n++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *num_config = n;</span><br><span class="line">    <span class="keyword">return</span> EGL_TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到了 agl 这边，会遍历 gConfigs 数组，去查找符合入参 attrib_list 所要求的参数类型的配置，然后将找到的配置索引保存到入参 configs 中返回出去。</p>
<p>到这里，我们介绍了 EGL 操作中的前几个步骤，剩下的步骤请见下篇文章：<a href="3341fdf3.html">GLES&amp;EGL-EGL-02</a> </p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/AndroidFrameworks/">AndroidFrameworks</a>
		  
			<a href="/tags/OpenGLES/">OpenGLES</a>
		  
			<a href="/tags/EGL/">EGL</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/3341fdf3.html">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">GLES&EGL-EGL-02</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/c4a594c7.html">
        <span class="next-text nav-default">GLES&EGL-总述</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2020 -
    
    2023
    <span class="footer-author">咔咔咔.</span>
    <span class="power-by">
        由 <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> and <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a> 强力驱动
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
