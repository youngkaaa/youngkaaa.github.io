<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Ijkplayer-video_refresh_thread"/>




  <meta name="keywords" content="ijkplayer," />





  <link rel="alternate" href="/default" title="å’”å’”å’”" >




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://youngkaaa.github.io/e1139ab6.html"/>


<meta name="description" content="æœ¬æ–‡ä¸»è¦ä»‹ç»ä½äºff_ffplay.cæ–‡ä»¶ä¸­çš„video_refresh_thread()æ–¹æ³•ã€‚ æœ¬æ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯å®ç°è§†é¢‘å¸§åˆ·æ–°æ˜¾ç¤ºï¼Œä¸»è¦é€»è¾‘ä¸ºï¼šä»å¯¹åº”FrameQueueä¸­å–å‡ºä¹‹å‰è§£ç æ—¶å­˜å…¥çš„è§£ç åæ•°æ®ï¼Œç„¶ååšç›¸å…³æ’­æ”¾åŒæ­¥æ“ä½œä¹‹å(åŒ…æ‹¬ä¸¢å¸§ä»¥åŠ å¿«æ’­æ”¾æˆ–é‡å¤æ’­æ”¾ä»¥å‡ç¼“æ’­æ”¾)ï¼Œå†åšå¸§å±•ç¤ºæ“ä½œã€‚ä¸»è¦æ˜¯è¿™ä¸‰æ­¥ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Ijkplayer-video_refresh_thread">
<meta property="og:url" content="https://youngkaaa.github.io/e1139ab6.html">
<meta property="og:site_name" content="å’”å’”å’”">
<meta property="og:description" content="æœ¬æ–‡ä¸»è¦ä»‹ç»ä½äºff_ffplay.cæ–‡ä»¶ä¸­çš„video_refresh_thread()æ–¹æ³•ã€‚ æœ¬æ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯å®ç°è§†é¢‘å¸§åˆ·æ–°æ˜¾ç¤ºï¼Œä¸»è¦é€»è¾‘ä¸ºï¼šä»å¯¹åº”FrameQueueä¸­å–å‡ºä¹‹å‰è§£ç æ—¶å­˜å…¥çš„è§£ç åæ•°æ®ï¼Œç„¶ååšç›¸å…³æ’­æ”¾åŒæ­¥æ“ä½œä¹‹å(åŒ…æ‹¬ä¸¢å¸§ä»¥åŠ å¿«æ’­æ”¾æˆ–é‡å¤æ’­æ”¾ä»¥å‡ç¼“æ’­æ”¾)ï¼Œå†åšå¸§å±•ç¤ºæ“ä½œã€‚ä¸»è¦æ˜¯è¿™ä¸‰æ­¥ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-03-22T01:20:54.000Z">
<meta property="article:modified_time" content="2022-07-29T15:03:31.424Z">
<meta property="article:author" content="å’”å’”å’”">
<meta property="article:tag" content="ijkplayer">
<meta name="twitter:card" content="summary">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Ijkplayer-video_refresh_thread - å’”å’”å’” </title>
  <meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">å’”å’”å’”</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Ijkplayer-video_refresh_thread
        
      </h1>

      <time class="post-time">
          3æœˆ 22 2020
      </time>
    </header>



    
            <div class="post-content">
            <p>æœ¬æ–‡ä¸»è¦ä»‹ç»ä½äºff_ffplay.cæ–‡ä»¶ä¸­çš„video_refresh_thread()æ–¹æ³•ã€‚</p>
<p>æœ¬æ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯å®ç°è§†é¢‘å¸§åˆ·æ–°æ˜¾ç¤ºï¼Œä¸»è¦é€»è¾‘ä¸ºï¼šä»å¯¹åº”<a href="866c32fa.html">FrameQueue</a>ä¸­å–å‡ºä¹‹å‰è§£ç æ—¶å­˜å…¥çš„è§£ç åæ•°æ®ï¼Œç„¶ååšç›¸å…³æ’­æ”¾åŒæ­¥æ“ä½œä¹‹å(åŒ…æ‹¬ä¸¢å¸§ä»¥åŠ å¿«æ’­æ”¾æˆ–é‡å¤æ’­æ”¾ä»¥å‡ç¼“æ’­æ”¾)ï¼Œå†åšå¸§å±•ç¤ºæ“ä½œã€‚ä¸»è¦æ˜¯è¿™ä¸‰æ­¥ã€‚</p>
<span id="more"></span>

<blockquote>
<p>TODO:</p>
<p>ç¬¬6æ­¥å­—å¹•åˆ·æ–°é€»è¾‘åˆ†æ</p>
</blockquote>
<h4 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h4><p>å…ˆä»‹ç»æœ¬æ–¹æ³•çš„è°ƒç”¨è·¯å¾„ï¼Œå…ˆæ˜ç¡®æœ¬æ–¹æ³•çš„è°ƒç”¨æ—¶åˆ»å†ä»‹ç»æœ¬æ–¹æ³•é€»è¾‘ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IjkMediaPlayer#prepareAsync()</span><br><span class="line">---&gt;ijkplayer_jni.c#IjkMediaPlayer_prepareAsync()</span><br><span class="line">------&gt;ijkplayer.c#ijkmp_prepare_async()</span><br><span class="line">---------&gt;ijkplayer.c#ijkmp_prepare_async_l()</span><br><span class="line">-------------&gt;ff_ffplay.c#ffp_prepare_async_l()</span><br><span class="line">------------------&gt;ff_ffplay.c#stream_open()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ff_ffplay.c#stream_open()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">static</span> VideoState *<span class="title function_">stream_open</span><span class="params">(FFPlayer *ffp, <span class="type">const</span> <span class="type">char</span> *filename, AVInputFormat*iformat)</span> &#123;</span><br><span class="line">     <span class="comment">// çœç•¥æ— å…³ä»£ç </span></span><br><span class="line">    is-&gt;video_refresh_tid = SDL_CreateThreadEx(&amp;is-&gt;_video_refresh_tid, video_refresh_thread, ffp, <span class="string">&quot;ff_vout&quot;</span>);</span><br><span class="line">     <span class="comment">// çœç•¥æ— å…³ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>å¯ä»¥çœ‹å‡º:</p>
<ol>
<li>video_refresh_threadæ–¹æ³•æ˜¯å•ç‹¬åœ¨ä¸€ä¸ªæ–°çº¿ç¨‹ä¸­æ‰§è¡Œçš„</li>
<li>åˆ›å»ºvideo_refresh_threadçº¿ç¨‹çš„æœ€åˆæ˜¯ç”±äºè°ƒç”¨äº†ä¸Šå±‚IjkMediaPlayerå¯¹è±¡å®ä¾‹ä¸­çš„prepareAsync()æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯åˆ›å»ºæ—¶æœºæ˜¯ä¸Šå±‚prepareæ—¶ã€‚</li>
</ol>
<h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ:"></a>åˆ†æ:</h4><blockquote>
<p>ff_ffplay.c#video_refresh_thread()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">video_refresh_thread</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    FFPlayer *ffp = arg;</span><br><span class="line">    VideoState *is = ffp-&gt;is;</span><br><span class="line">    <span class="type">double</span> remaining_time = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!is-&gt;abort_request) &#123;</span><br><span class="line">        <span class="keyword">if</span> (remaining_time &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">            av_usleep((<span class="type">int</span>) (<span class="type">int64_t</span>) (remaining_time * <span class="number">1000000.0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">      	remaining_time = REFRESH_RATE;</span><br><span class="line">        <span class="keyword">if</span> (is-&gt;show_mode != SHOW_MODE_NONE &amp;&amp; (!is-&gt;paused || is-&gt;force_refresh))</span><br><span class="line">            video_refresh(ffp, &amp;remaining_time);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ¬æ–¹æ³•ä¸­å…ˆå®šä¹‰çš„remaining_time&#x3D;0.0,ç”¨äºè¡¨ç¤ºä¸‹æ¬¡åˆ·æ–°éœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼Œå•ä½ä¸ºsã€‚æ‰€ä»¥åˆšå¼€å§‹æ˜¯0è¡¨ç¤ºç›´æ¥å¼€å§‹åˆ·æ–°ã€‚</p>
<p>å…¶æ¬¡åˆ·æ–°ç­‰ä¸»è¦é€»è¾‘å°±åœ¨whileå¾ªç¯ä¸­äº†ï¼Œå¾ªç¯æ¡ä»¶æ˜¯:is-&gt;abort_request&#x3D;0ï¼Œè€Œabort_requestä¸€èˆ¬æ˜¯å½“æš‚åœæˆ–è€…é”€æ¯æ’­æ”¾å™¨æ—¶ä¼šå°†å…¶ç½®ä¸º1ï¼Œè¡¨ç¤ºåœæ­¢æ’­æ”¾(åŒ…æ‹¬åœæ­¢ç›¸å…³é˜Ÿåˆ—ç­‰)ã€‚æ‰€ä»¥è¿™é‡Œçš„whileå¾ªç¯å°±æ˜¯å½“è¿˜åœ¨æ’­æ”¾ä¸­æ—¶ï¼Œå°±å¾ªç¯ä¸€ç›´æ‰§è¡Œå¾ªç¯ä½“å†…çš„é€»è¾‘ã€‚</p>
<ol>
<li><p>å…ˆåˆ¤æ–­remaining_timeæ˜¯å¦å¤§äº0ï¼Œå¦‚æœå¤§äº0çš„è¯é‚£ä¹ˆå°±ç­‰å¾…ä¼‘çœ remaining_timeæ—¶é•¿ã€‚ç„¶åå†è€ƒè™‘åé¢åˆ·æ–°çš„äº‹å„¿ã€‚</p>
</li>
<li><p>å°†remaining_timeèµ‹å€¼ä¸ºREFRESH_RATEï¼Œä¹Ÿå°±æ˜¯0.01sï¼Œä¹Ÿå°±æ˜¯åˆ·æ–°é—´éš”ä¸º0.01sã€‚</p>
</li>
<li><p>åˆ·æ–°å±•ç¤ºè§†é¢‘å¸§é€»è¾‘ï¼Œä¸»è¦åœ¨video_refresh()æ–¹æ³•(ä¸‹é¢ä¼šåˆ†æ)ä¸­ï¼Œä½†æ˜¯è¿™é‡Œæ‰§è¡Œvideo_refresh()æ–¹æ³•(ä¸‹é¢ä¼šåˆ†æ)æ˜¯æœ‰æ¡ä»¶çš„ï¼Œæ¯”å¦‚</p>
<ul>
<li>show_modeä¸ç­‰äºSHOW_MODE_NONEï¼šshow_modeè¡¨ç¤ºå½“å‰å±•ç¤ºç±»å‹ï¼Œæ˜¯åªæ’­éŸ³é¢‘è¿˜æ˜¯è§†é¢‘æˆ–è€…å•¥éƒ½ä¸å±•ç¤ºï¼Œæ¯”å¦‚åœ¨read_thread()ä¸­æ‰“å¼€æ¯ä¸ªè½¨é“æµæ—¶èµ‹å€¼ï¼Œæ¯”å¦‚è§†é¢‘è½¨é“æ‰“å¼€æˆåŠŸæ—¶ä¼šç½®ä¸ºSHOW_MODE_VIDEOã€‚</li>
<li>!is-&gt;pausedï¼šè¿™ä¸ªä¸è§£é‡Šäº†ï¼Œå°±æ˜¯å¤„äºæ’­æ”¾ä¸­æ‰åˆ·æ–°ï¼Œæš‚åœäº†å°±ä¸åˆ·æ–°(æ³¨æ„è¿™é‡Œå…³ç³»æ˜¯æˆ–ï¼Œæ‰€ä»¥å¦‚æœforce_refresh&#x3D;1æ—¶æ‹¿å°±ç®—æš‚åœäº†ä¹Ÿè¦åˆ·æ–°)</li>
<li>is-&gt;force_refreshï¼šæ˜¯å¦å¼ºåˆ¶åˆ·æ–°ã€‚è¯¥å€¼ä¸€èˆ¬åœ¨video_refresh()æ–¹æ³•ä¸­(ä¸‹é¢ä¼šåˆ†æ)èµ‹å€¼ï¼Œå½“åˆ°äº†æ–°çš„ä¸€å¸§çš„æ˜¾ç¤ºæ—¶é—´æ—¶ä¼šå°†å…¶ç½®ä¸º1ï¼Œè¡¨ç¤ºè¯¥åˆ·æ–°äº†ã€‚</li>
</ul>
<p>éœ€æ³¨æ„ä¸Šé¢ä¸‰ä¸ªæ¡ä»¶çš„ <strong>å’Œ</strong> ã€<strong>æˆ–</strong> å…³ç³»å“¦ã€‚</p>
<p>æ¡ä»¶æ»¡è¶³æ—¶ä¼šè°ƒç”¨video_refreshæ¥å®Œæˆå‰©ä¸‹çš„é€»è¾‘ï¼Œæ³¨æ„è¿™é‡Œå°†remaining_timeçš„åœ°å€ä¼ è¿›å»äº†ï¼Œé‡Œé¢ä¼šæ ¹æ®æƒ…å†µæ¥ä¿®æ”¹remaining_timeçš„å€¼ã€‚ç„¶åæ‰§è¡Œå®Œvideo_refreshåwhileä¸‹ä¸€æ¬¡å¾ªç¯ä¼šæ ¹æ®ä¿®æ”¹åçš„remaining_timeçš„å¤§å°æ¥ä¼‘çœ ç­‰å¾…ã€‚</p>
</li>
</ol>
<p>ä¸‹é¢ä¸»è¦çœ‹video_refreshæ–¹æ³•äº†:</p>
<blockquote>
<p>ff_ffplay.c#video_refresh()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">video_refresh</span><span class="params">(FFPlayer *opaque, <span class="type">double</span> *remaining_time)</span> &#123;</span><br><span class="line">    FFPlayer *ffp = opaque;</span><br><span class="line">    VideoState *is = ffp-&gt;is;</span><br><span class="line">    <span class="type">double</span> time;</span><br><span class="line">    Frame *sp, *sp2;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// çœç•¥æ— å…³ä»£ç </span></span><br><span class="line">		</span><br><span class="line">    <span class="keyword">if</span> (is-&gt;video_st) &#123;</span><br><span class="line">        retry:</span><br><span class="line">        <span class="keyword">if</span> (frame_queue_nb_remaining(&amp;is-&gt;pictq) == <span class="number">0</span>) &#123; </span><br><span class="line">            <span class="comment">// nothing to do, no picture to display in the queue</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          	<span class="comment">// ç¬¬1æ­¥</span></span><br><span class="line">            <span class="type">double</span> last_duration, duration, delay;</span><br><span class="line">            Frame *vp, *lastvp;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* dequeue the picture */</span></span><br><span class="line">            lastvp = frame_queue_peek_last(&amp;is-&gt;pictq);</span><br><span class="line">            vp = frame_queue_peek(&amp;is-&gt;pictq);</span><br><span class="line">            <span class="keyword">if</span> (vp-&gt;serial != is-&gt;videoq.serial) &#123;</span><br><span class="line">                frame_queue_next(&amp;is-&gt;pictq);</span><br><span class="line">                <span class="keyword">goto</span> retry;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (lastvp-&gt;serial != vp-&gt;serial) &#123;</span><br><span class="line">                is-&gt;frame_timer = av_gettime_relative() / <span class="number">1000000.0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is-&gt;paused) &#123;</span><br><span class="line">                <span class="keyword">goto</span> display;</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">// ç¬¬2æ­¥</span></span><br><span class="line">            <span class="comment">/* compute nominal last_duration */</span></span><br><span class="line">            last_duration = vp_duration(is, lastvp, vp);</span><br><span class="line">            delay = compute_target_delay(ffp, last_duration, is);</span><br><span class="line">          	<span class="comment">// ç¬¬3æ­¥</span></span><br><span class="line">            time = av_gettime_relative() / <span class="number">1000000.0</span>;</span><br><span class="line">            <span class="keyword">if</span> (isnan(is-&gt;frame_timer) || time &lt; is-&gt;frame_timer) &#123;</span><br><span class="line">                is-&gt;frame_timer = time;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (time &lt; is-&gt;frame_timer + delay) &#123;</span><br><span class="line">                *remaining_time = FFMIN(is-&gt;frame_timer + delay - time, *remaining_time);</span><br><span class="line">                <span class="keyword">goto</span> display;</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">// ç¬¬4æ­¥</span></span><br><span class="line">            is-&gt;frame_timer += delay;</span><br><span class="line">            <span class="keyword">if</span> (delay &gt; <span class="number">0</span> &amp;&amp; time - is-&gt;frame_timer &gt; AV_SYNC_THRESHOLD_MAX) &#123;</span><br><span class="line">                is-&gt;frame_timer = time;</span><br><span class="line">            &#125;</span><br><span class="line">            SDL_LockMutex(is-&gt;pictq.mutex);</span><br><span class="line">            <span class="keyword">if</span> (!isnan(vp-&gt;pts)) &#123;</span><br><span class="line">                update_video_pts(is, vp-&gt;pts, vp-&gt;pos, vp-&gt;serial);</span><br><span class="line">            &#125;</span><br><span class="line">            SDL_UnlockMutex(is-&gt;pictq.mutex);</span><br><span class="line">          	<span class="comment">// ç¬¬5æ­¥</span></span><br><span class="line">            <span class="keyword">if</span> (frame_queue_nb_remaining(&amp;is-&gt;pictq) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                Frame *nextvp = frame_queue_peek_next(&amp;is-&gt;pictq);</span><br><span class="line">                duration = vp_duration(is, vp, nextvp);</span><br><span class="line">                <span class="keyword">if</span> (!is-&gt;step &amp;&amp;</span><br><span class="line">                    (ffp-&gt;framedrop &gt; <span class="number">0</span> || (ffp-&gt;framedrop &amp;&amp; get_master_sync_type(is) != AV_SYNC_VIDEO_MASTER)) &amp;&amp;</span><br><span class="line">                    time &gt; is-&gt;frame_timer + duration) &#123;</span><br><span class="line">                    frame_queue_next(&amp;is-&gt;pictq);</span><br><span class="line">                    <span class="keyword">goto</span> retry;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">// ç¬¬6æ­¥</span></span><br><span class="line">            <span class="keyword">if</span> (is-&gt;subtitle_st) &#123;</span><br><span class="line">                <span class="keyword">while</span> (frame_queue_nb_remaining(&amp;is-&gt;subpq) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    sp = frame_queue_peek(&amp;is-&gt;subpq);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (frame_queue_nb_remaining(&amp;is-&gt;subpq) &gt; <span class="number">1</span>)</span><br><span class="line">                        sp2 = frame_queue_peek_next(&amp;is-&gt;subpq);</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        sp2 = <span class="literal">NULL</span>;</span><br><span class="line">                    <span class="keyword">if</span> (sp-&gt;serial != is-&gt;subtitleq.serial</span><br><span class="line">                        || (is-&gt;vidclk.pts &gt; (sp-&gt;pts + ((<span class="type">float</span>) sp-&gt;sub.end_display_time / <span class="number">1000</span>)))</span><br><span class="line">                        || (sp2 &amp;&amp; is-&gt;vidclk.pts &gt; (sp2-&gt;pts + ((<span class="type">float</span>) sp2-&gt;sub.start_display_time / <span class="number">1000</span>)))) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (sp-&gt;uploaded) &#123;</span><br><span class="line">                            ffp_notify_msg4(ffp, FFP_MSG_TIMED_TEXT, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;&quot;</span>, <span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        frame_queue_next(&amp;is-&gt;subpq);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">// ç¬¬7æ­¥</span></span><br><span class="line">            frame_queue_next(&amp;is-&gt;pictq);</span><br><span class="line">            is-&gt;force_refresh = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            SDL_LockMutex(ffp-&gt;is-&gt;play_mutex);</span><br><span class="line">            <span class="keyword">if</span> (is-&gt;step) &#123;</span><br><span class="line">                is-&gt;step = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (!is-&gt;paused)</span><br><span class="line">                    stream_update_pause_l(ffp);</span><br><span class="line">            &#125;</span><br><span class="line">            SDL_UnlockMutex(ffp-&gt;is-&gt;play_mutex);</span><br><span class="line">        &#125;</span><br><span class="line">        display:</span><br><span class="line">        <span class="comment">// ç¬¬8æ­¥</span></span><br><span class="line">        <span class="comment">/* display picture */</span></span><br><span class="line">        <span class="keyword">if</span> (!ffp-&gt;display_disable &amp;&amp; is-&gt;force_refresh &amp;&amp; is-&gt;show_mode == SHOW_MODE_VIDEO &amp;&amp;</span><br><span class="line">            is-&gt;pictq.rindex_shown) &#123;</span><br><span class="line">            video_display2(ffp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// ç¬¬9æ­¥</span></span><br><span class="line">    is-&gt;force_refresh = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// çœç•¥éƒ¨åˆ†æ— å…³ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³äºvideo_refresh()æ–¹æ³•ï¼Œçœç•¥äº†éƒ¨åˆ†æš‚æ—¶æ— å…³ä»£ç ï¼Œç„¶ååœ¨ä»£ç ä¸­æ ‡ä¸Šäº†æ­¥éª¤ï¼Œåç»­æŒ‰ç…§ä¸Šé¢æ­¥éª¤æ¥åˆ†æã€‚</p>
</blockquote>
<p>åˆ†æä¹‹å‰ï¼Œé¦–å…ˆå°†ä¸Šé¢é€»è¾‘ç»“æ„çœç•¥ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">video_refresh</span><span class="params">(FFPlayer *opaque, <span class="type">double</span> *remaining_time)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (is-&gt;video_st) &#123;</span><br><span class="line">        retry:</span><br><span class="line">        <span class="keyword">if</span> (frame_queue_nb_remaining(&amp;is-&gt;pictq) == <span class="number">0</span>) &#123; </span><br><span class="line">            <span class="comment">// nothing to do, no picture to display in the queue</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          	<span class="comment">// ç¬¬1æ­¥</span></span><br><span class="line">          	<span class="comment">// ç¬¬2æ­¥</span></span><br><span class="line">          	<span class="comment">// ç¬¬3æ­¥</span></span><br><span class="line">          	<span class="comment">// ç¬¬4æ­¥</span></span><br><span class="line">          	<span class="comment">// ç¬¬5æ­¥</span></span><br><span class="line">          	<span class="comment">// ç¬¬6æ­¥</span></span><br><span class="line">          	<span class="comment">// ç¬¬7æ­¥</span></span><br><span class="line">        &#125;</span><br><span class="line">        display:</span><br><span class="line">        <span class="comment">// ç¬¬8æ­¥</span></span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// ç¬¬9æ­¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœç•¥ä¹‹åçš„æ¡†æ¶å¦‚ä¸Šï¼Œè¿™é‡Œéœ€è¦å…³æ³¨ä¸¤ä¸ªç¨‹åºç‚¹ï¼šretryå’Œdisplayï¼Œè¿™ä¸¤ä¸ªç¨‹åºç‚¹ä¸»è¦æ˜¯ä¸ºgotoè¯­è¨€åšå‡†å¤‡ï¼Œç¬¬8æ­¥ä¹Ÿå°±å¯¹åº”ç€displayç‚¹ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œvideo_refresh()æ–¹æ³•ä¸»è¦å…ˆåˆ¤æ–­is-&gt;video_stæ˜¯å¦ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯è§†é¢‘è½¨é“æ˜¯å¦å­˜åœ¨ï¼Œè§†é¢‘è½¨é“å­˜åœ¨æ‰æœ‰ä¹‹åçš„åˆ†æï¼Œå› ä¸ºæœ¬æ–¹æ³•å°±æ˜¯è§†é¢‘å¸§åˆ·æ–°çš„ï¼Œå¦‚æœè§†é¢‘è½¨é“ä¸å­˜åœ¨é‚£è¿˜åˆ·æ–°ä¸ªå±å“Ÿã€‚</p>
<p>ç„¶åè°ƒç”¨frame_queue_nb_remaining()æ–¹æ³•åˆ¤æ–­is-&gt;pictqæ‰€å¯¹åº”çš„<a href="866c32fa.html">FrameQueue</a>é˜Ÿé‡Œä¸­æ˜¯å¦è¿˜æœ‰å¾…æ˜¾ç¤ºçš„å·²è§£ç æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®é‚£ä¹ˆå°±ä¸åšä»»ä½•æ“ä½œã€‚è€Œå…³äº<a href="866c32fa.html">frame_queue_nb_remaining()</a>æ–¹æ³•åœ¨<a href="866c32fa.html">FrameQueue</a>ä¸­æœ‰è§£é‡Šï¼Œè¿™é‡Œä¸åœ¨èµ˜è¿°ã€‚åç»­ç›¸å…³æ–¹æ³•ç›´æ¥é“¾æ¥åˆ°å¯¹åº”åœ°å€ï¼Œä¸å†åšå•ç‹¬è§£é‡Šã€‚</p>
<p>å¦‚æœé˜Ÿåˆ—ä¸­æœ‰å¾…å±•ç¤ºçš„æ•°æ®ï¼Œé‚£ä¹ˆæŒ‰é¡ºåºæ‰§è¡Œä¸‹é¢çš„å‡ æ­¥ï¼š</p>
<h5 id="ç¬¬1æ­¥ï¼š"><a href="#ç¬¬1æ­¥ï¼š" class="headerlink" title="ç¬¬1æ­¥ï¼š"></a>ç¬¬1æ­¥ï¼š</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> last_duration, duration, delay;</span><br><span class="line">Frame *vp, *lastvp;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* dequeue the picture */</span></span><br><span class="line">lastvp = frame_queue_peek_last(&amp;is-&gt;pictq);</span><br><span class="line">vp = frame_queue_peek(&amp;is-&gt;pictq);</span><br><span class="line"><span class="keyword">if</span> (vp-&gt;serial != is-&gt;videoq.serial) &#123;</span><br><span class="line">    frame_queue_next(&amp;is-&gt;pictq);</span><br><span class="line">    <span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (lastvp-&gt;serial != vp-&gt;serial) &#123;</span><br><span class="line">		is-&gt;frame_timer = av_gettime_relative() / <span class="number">1000000.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (is-&gt;paused) &#123;</span><br><span class="line">		<span class="keyword">goto</span> display;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬æ­¥å¾ˆç®€å•ï¼Œé¦–å…ˆå…ˆå®šä¹‰ç›¸å…³å˜é‡ï¼š</p>
<ul>
<li>last_duration:è¡¨ç¤ºlastvpå¸§çš„æŒç»­æ—¶é—´ï¼Œå…¶å®å°±æ˜¯lastvpçš„ptså’Œvpçš„ptsä¹‹é—´çš„å·®å€¼ã€‚æ ¹æ®vp_duration()æ–¹æ³•è®¡ç®—çš„ã€‚</li>
<li>duration:è¡¨ç¤ºvpå¸§çš„æŒç»­æ—¶é—´ï¼Œå…¶å®å°±æ˜¯vpçš„ptså’Œnextvp(åç»­ä»‹ç»)çš„ptsä¹‹é—´çš„å·®å€¼ã€‚æ ¹æ®vp_duration()æ–¹æ³•è®¡ç®—çš„ã€‚</li>
<li>delay:è¡¨ç¤ºlastvpå¸§ç»è¿‡æ’­æ”¾åŒæ­¥ä¹‹åçš„æŒç»­æ—¶é—´ã€‚ç®€å•æ¥è¯´å°±æ˜¯è€ƒè™‘äº†éŸ³è§†é¢‘åŒæ­¥ä¹‹åï¼Œè®¡ç®—å‡ºæ¥lastvpå¸§åº”æŒç»­çš„æ—¶é—´ï¼Œæœ€ç»ˆlastvpå¸§çš„æŒç»­æ—¶é—´å…¶å®æ˜¯ä»¥delayä¸ºå‡†çš„ï¼Œä¸Šé¢è®¡ç®—å‡ºæ¥çš„last_durationåªæ˜¯ä¸ºäº†è®¡ç®—delayåšå‡†å¤‡è€Œå·²ã€‚</li>
<li>lastvp:å½“å‰æ­£åœ¨æ˜¾ç¤ºçš„Frameï¼Œä¸ºä½•å«lastvpå‘¢ï¼Ÿå› ä¸ºè¯¥å¸§ä¸€èˆ¬æ˜¯æ­¤åˆ»å·²ç»åœ¨å±å¹•ä¸Šæ˜¾ç¤ºç€çš„äº†ï¼Œæ‰€ä»¥å®ƒçš„æ˜¾ç¤ºæ“ä½œè‚¯å®šåœ¨æ­¤åˆ»ä¹‹å‰(ä¸ç„¶æ­¤åˆ»æ€èƒ½çœ‹åˆ°è¯¥å¸§ï¼Ÿ)ã€‚</li>
<li>vp:åé¢è¦æ˜¾ç¤ºçš„ä¸‹ä¸€å¸§ï¼Œä¹Ÿå°±æ˜¯æœ¬æ¬¡å³å°†è¦æ˜¾ç¤ºçš„å¸§ã€‚è¿™é‡Œéœ€å¤šå¤šç†è§£ï¼Œä¸è¦å’Œåé¢ç¬¬5æ­¥ä¸­çš„nextvpæ··æ·†äº†ã€‚</li>
</ul>
<p>å¯¹äºä¸Šé¢æåˆ°çš„lastvpï¼Œvpï¼Œnextvp(å¾€åç¿»çœ‹ç¬¬5æ­¥)ï¼Œå¯ä»¥çœ‹å¦‚ä¸‹çš„ç¤ºæ„å›¾:</p>


<p>è¿™é‡Œéœ€æ³¨æ„<a href="866c32fa.html">FrameQueue</a>å…¶å®æ˜¯ä½¿ç”¨æ•°ç»„å®ç°çš„ç¯å½¢é˜Ÿåˆ—ï¼Œè¿™é‡Œä¸ºäº†çœ‹èµ·æ¥æ–¹ä¾¿å°±æ²¡æœ‰ç”»æˆç¯å½¢ã€‚</p>
<p>ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œlastvpå’Œvpä»¥åŠåé¢çš„nextvpã€nextvpAã€nextvpBæ­¤åˆ»åœ¨<a href="866c32fa.html">FrameQueue</a>ä¸­çš„é¡ºåºã€‚åé¢ä¼šå¤šæ¬¡ä½¿ç”¨æœ¬å›¾ä¸­çš„å±æ€§åã€‚</p>
<p>å®šä¹‰å®Œç›¸å…³å˜é‡ï¼Œåé¢å°±å…ˆè°ƒç”¨<a href="866c32fa.html">frame_queue_peek_last</a>æ–¹æ³•æ¥è·å–å½“å‰æ­£åœ¨æ˜¾ç¤ºçš„è§†é¢‘å¸§ï¼Œä»¥åŠè°ƒç”¨<a href="866c32fa.html">frame_queue_peek</a>æ–¹æ³•æ¥è·å–å³å°†è¦æ˜¾ç¤ºçš„ä¸‹ä¸€å¸§ã€‚</p>
<p>æ‹¿åˆ°å½“å‰è§†é¢‘å¸§lastvpå’Œå³å°†è¦æ˜¾ç¤ºçš„vpå¸§ä¹‹åï¼Œå…ˆåˆ¤æ–­å³å°†è¦æ˜¾ç¤ºçš„vpå¸§çš„serialå’Œå½“å‰é˜Ÿåˆ—çš„serialæ˜¯å¦ä¸€æ ·ï¼Œä¸ä¸€æ ·çš„è¯è¡¨ç¤ºå‘ç”Ÿè¿‡seekï¼Œè€Œè¯¥å³å°†è¦æ˜¾ç¤ºçš„vpå¸§æ˜¯seekä¹‹å‰çš„æ—§çš„è§†é¢‘å¸§(lastvpåœ¨vpä¹‹å‰è‚¯å®šä¹Ÿæ˜¯seekä¹‹å‰çš„æ—§æ•°æ®)ï¼Œæ‰€ä»¥æ­¤æ—¶è°ƒç”¨<a href="866c32fa.html">frame_queue_next</a>æ–¹æ³•æ¥ä¸¢å¼ƒlastvpã€‚ç„¶åä»é¡¶éƒ¨retryå¤„é‡æ–°å¾€ä¸‹æ‰§è¡Œã€‚</p>
<blockquote>
<p>ä¸ºä½•è¿™é‡Œä¸¢å¼ƒçš„æ˜¯lastvpï¼Ÿ</p>
<p>åœ¨éŸ³é¢‘ã€è§†é¢‘çš„FrameQueueä¸­æ˜¯æœ‰<a href="866c32fa.html">keep_last</a>æœºåˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯ä¿ç•™å·²æ’­æ”¾çš„ä¸Šä¸€å¸§ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ­¤å¤„å¯ä»¥æ‹¿åˆ°lastvpäº†ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªæœºåˆ¶çš„è¯æ’­æ”¾å®Œå°±ç›´æ¥æ‰”æ‰è¯¥å¸§äº†ã€‚è€Œåˆå› ä¸ºåœ¨åç»­çš„åŒæ­¥æ—¶ï¼Œå¯èƒ½ä¼šé‡å¤æ’­æ”¾å½“å‰å¸§(å½“å‰æ’­æ”¾ä¸­çš„å°±æ˜¯lastvp)ï¼Œæ‰€ä»¥lastvpä¸èƒ½æ‰”ã€‚</p>
<p>è€Œå›åˆ°è¿™ä¸ªé—®é¢˜ä¸Šæ¥ï¼Œä¸ºä½•åªä¸¢å¼ƒlastvpï¼Œæˆ‘çš„ç†è§£æ˜¯å’Œè¿™ä¸ªæœ‰å…³ï¼Œå¦‚æœæ­¤æ—¶ä¸ä»…ä¸¢æ‰lastvpè¿˜æŠŠvpä¹Ÿä¸¢æ‰ï¼Œé‚£ä¹ˆå‡å¦‚vpä¹‹åçš„nextvpæ˜¯åˆæ³•çš„è¯ï¼Œå°±è¯¥æ’­æ”¾nextvpäº†ï¼Œæ­¤æ—¶nextvpå°±æ²¡æœ‰ä¸Šä¸€å¸§äº†ï¼Œè¿èƒŒäº†<a href="866c32fa.html">keep_last</a>æœºåˆ¶ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªåŸå› å°±æ˜¯ä¸Šé¢å·²çŸ¥lastvpå’Œvpéƒ½æ˜¯è¿‡æ—¶çš„æ•°æ®ï¼Œå‡å¦‚nextvpæ˜¯æ–°æ•°æ®(seekä¹‹åçš„)ï¼Œé‚£ä¹ˆå¦‚æœæŠŠlastvpå’ŒvpåŒæ—¶ä¸¢æ‰ï¼Œä¸‹é¢çš„æ›´æ–°æ—¶é—´æˆ³é€»è¾‘å°±æ°¸è¿œä¸ä¼šæ‰§è¡Œäº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lastvp-&gt;serial != vp-&gt;serial) &#123;</span><br><span class="line">		is-&gt;frame_timer = av_gettime_relative() / <span class="number">1000000.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å½“ç„¶ä¸Šè¿°åªæ˜¯é’ˆå¯¹æ—¢å®šç»“æœçš„åŸå› çŒœæµ‹è€Œå·²ï¼Œä¹Ÿè¯´ä¸å®šæ˜¯ä½œè€…æ— å¿ƒä¸ºä¹‹è€Œæˆ‘åœ¨å¼ºåŠ è§£é‡Šç½¢äº†ğŸ˜„</p>
</blockquote>
<p>å†å¾€åå°±æ˜¯åˆ¤æ–­lastvpå’Œvpçš„serialæ˜¯å¦ç›¸åŒï¼Œè€Œä¸Šé¢åˆ¤æ–­è¿‡å¦‚æœvpçš„serialå’ŒPacketQueueä¸­æœ€æ–°çš„serialä¸ä¸€è‡´çš„è¯å°±ç›´æ¥retryäº†ï¼Œæ‰€ä»¥è¯´èƒ½æ‰§è¡Œåˆ°è¿™é‡Œå°±è¡¨ç¤ºvpæ˜¯seekä¹‹åçš„æ–°æ•°æ®ï¼Œè€Œlastvpæ˜¯seekä¹‹å‰çš„æ—§æ•°æ®ï¼Œæ­¤æ—¶å¤„äºseekåæ–°è€æ•°æ®çš„äº¤æ±‡ç‚¹ã€‚æ‰€ä»¥æ­¤æ—¶ç”¨ç³»ç»Ÿå½“å‰æ—¶é—´æ¥æ›´æ–°frame_timerï¼Œä¹Ÿæ˜¯ç›¸å½“äºæ ¡å‡†æ—¶é—´å§ã€‚</p>
<blockquote>
<p>is-&gt;frame_timer</p>
<p>frame_timerè¡¨ç¤ºçš„æ˜¯ä¸Šä¸€å¸§çš„å±•ç¤ºæ’­æ”¾æ—¶é—´ï¼Œä¸€èˆ¬å½“æ–°çš„ä¸€å¸§è¦å±•ç¤ºæ—¶æ‰ä¼šæ›´æ–°æ­¤å€¼ã€‚</p>
</blockquote>
<p>æœ€åå°±æ˜¯åˆ¤æ–­å½“å‰æ˜¯å¦å·²æš‚åœï¼Œå¦‚æœå·²æš‚åœçš„è¯å°±è·³åˆ°displayå¤„ï¼Œä¹Ÿå°±æ˜¯ç¬¬8æ­¥ã€‚å½“ç„¶è·³åˆ°ç¬¬8æ­¥å¤„ä¹Ÿä¸ä¸€å®šä¼šåšå±•ç¤ºæ“ä½œï¼Œå› ä¸ºç¬¬8æ­¥å¤„è¦å±•ç¤ºè¿˜è¦æœ‰ä¸€äº›æ¡ä»¶çš„ã€‚è¿™é‡Œè·³åˆ°displayå¤„è¡¨ç¤ºæš‚åœçŠ¶æ€å°±ç»´æŒä¹‹å‰çš„æ’­æ”¾å¸§çŠ¶æ€ï¼Œä¸åšå¸§æ˜¾ç¤ºä¸Šçš„æ›´æ–°ã€‚</p>
<h5 id="ç¬¬1æ­¥å°ç»“ï¼š"><a href="#ç¬¬1æ­¥å°ç»“ï¼š" class="headerlink" title="ç¬¬1æ­¥å°ç»“ï¼š"></a>ç¬¬1æ­¥å°ç»“ï¼š</h5><p>æ€»çš„æ¥è¯´ä¸Šé¢ç¬¬1æ­¥å°±æ˜¯ç”¨æ¥å‡†å¤‡å¥½lastvpå’Œvpï¼Œå¹¶åšä¸€äº›ç®€å•çš„ç­›é€‰å¤„ç†ï¼Œæ¯”å¦‚æ–°å–å‡ºçš„vpæ˜¯å¦å·²è¿‡æ—¶ã€‚</p>
<h5 id="ç¬¬2æ­¥ï¼š"><a href="#ç¬¬2æ­¥ï¼š" class="headerlink" title="ç¬¬2æ­¥ï¼š"></a>ç¬¬2æ­¥ï¼š</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* compute nominal last_duration */</span></span><br><span class="line">last_duration = vp_duration(is, lastvp, vp);</span><br><span class="line">delay = compute_target_delay(ffp, last_duration, is);</span><br></pre></td></tr></table></figure>

<p>ç¬¬2æ­¥çœ‹ä¸Šå»å¾ˆç®€å•ï¼Œå°±ä¸¤å¥è€Œå·²ã€‚ç„¶è€Œè¿™ä¸¤å¥éœ€è¦è§£é‡Šçš„å†…å®¹å¯ä¸å°‘ï¼ŒåŒ…æ‹¬äº†è§†é¢‘æ’­æ”¾åŒæ­¥çš„ä¸»è¦é€»è¾‘ã€‚</p>
<ol>
<li><p>è°ƒç”¨vp_duration()æ–¹æ³•æ¥è®¡ç®—å½“å‰æ­£åœ¨å±•ç¤ºçš„è§†é¢‘å¸§(lastvp)çš„å±•ç¤ºæŒç»­æ—¶é•¿:</p>
<blockquote>
<p>ff_ffplay.c#vp_duration()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static double vp_duration(VideoState *is, Frame *vp, Frame *nextvp) &#123;</span><br><span class="line">    if (vp-&gt;serial == nextvp-&gt;serial) &#123;</span><br><span class="line">        double duration = nextvp-&gt;pts - vp-&gt;pts;</span><br><span class="line">        if (isnan(duration) || duration &lt;= 0 || duration &gt; is-&gt;max_frame_duration)</span><br><span class="line">            return vp-&gt;duration;</span><br><span class="line">        else</span><br><span class="line">            return duration;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return 0.0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®vp_duration()ä¸»è¦è®¡ç®—é€»è¾‘å°±æ˜¯ä½¿ç”¨ä¼ å…¥çš„ä¸¤ä¸ªFrameçš„ptsç›¸å‡æ¥è®¡ç®—å‡ºæŒç»­æ—¶é•¿ï¼Œæœ¬æ–¹æ³•ä¸­è¿˜æœ‰ä¸€äº›å®¹é”™å¤„ç†è¿”å›å…œåº•çš„æ—¶é•¿ï¼Œå½“ç„¶å¤§å¤šæ•°è¿˜æ˜¯è¿”å›ä¸¤ä¸ªFrameçš„ptsä¹‹å·®ã€‚</p>
</blockquote>
</li>
<li><p>è°ƒç”¨compute_target_delay()æ–¹æ³•æ¥è®¡ç®—å‡ºè¯¥å¸§æœ€ç»ˆçš„æŒç»­æ—¶é•¿delayã€‚æ³¨æ„æ­¤æ—¶å°†ä¸Šé¢åˆšè®¡ç®—å¥½çš„last_durationä¼ å…¥ï¼Œæ‰€ä»¥è¯´last_durationçš„è®¡ç®—åªæ˜¯ä¸ºdelayçš„è®¡ç®—åšé“ºå«ï¼Œæœ€ç»ˆå¸§çš„åº”æŒç»­å±•ç¤ºæ—¶é•¿è¿˜æ˜¯delayæ¥å†³å®šã€‚</p>
<blockquote>
<p>ff_ffplay.c#compute_target_delay()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">double</span> <span class="title function_">compute_target_delay</span><span class="params">(FFPlayer *ffp, <span class="type">double</span> delay, VideoState *is)</span> &#123;</span><br><span class="line">    <span class="type">double</span> sync_threshold, diff = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* update delay to follow master synchronisation source */</span></span><br><span class="line">    <span class="keyword">if</span> (get_master_sync_type(is) != AV_SYNC_VIDEO_MASTER) &#123;</span><br><span class="line">        <span class="comment">/* if video is slave, we try to correct big delays by</span></span><br><span class="line"><span class="comment">           duplicating or deleting a frame */</span></span><br><span class="line">        <span class="type">double</span> videoClock = get_clock(&amp;is-&gt;vidclk);</span><br><span class="line">        <span class="type">double</span> masterClock = get_master_clock(is);</span><br><span class="line">        diff = videoClock - masterClock;</span><br><span class="line">        <span class="comment">/* skip or repeat frame. We take into account the</span></span><br><span class="line"><span class="comment">           delay to compute the threshold. I still don&#x27;t know</span></span><br><span class="line"><span class="comment">           if it is the best guess */</span></span><br><span class="line">        sync_threshold = FFMAX(AV_SYNC_THRESHOLD_MIN, FFMIN(AV_SYNC_THRESHOLD_MAX, delay));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* -- by bbcallen: replace is-&gt;max_frame_duration with AV_NOSYNC_THRESHOLD */</span></span><br><span class="line">        <span class="keyword">if</span> (!isnan(diff) &amp;&amp; <span class="built_in">fabs</span>(diff) &lt; AV_NOSYNC_THRESHOLD) &#123;</span><br><span class="line">            <span class="keyword">if</span> (diff &lt;= -sync_threshold) &#123;</span><br><span class="line">                delay = FFMAX(<span class="number">0</span>, delay + diff);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (diff &gt;= sync_threshold &amp;&amp; delay &gt; AV_SYNC_FRAMEDUP_THRESHOLD) &#123;</span><br><span class="line">                delay = delay + diff;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (diff &gt;= sync_threshold) &#123;</span><br><span class="line">                delay = <span class="number">2</span> * delay;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> delay;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ¬æ–¹æ³•ä¸­æ³¨é‡Šè¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œè¶³ä»¥çœ‹å‡ºæœ¬æ–¹æ³•çš„é‡è¦æ€§ã€‚</p>
<p>æœ¬æ–¹æ³•ä¸­ï¼Œé¦–å…ˆå‰ææ¡ä»¶æ˜¯å½“å‰æ—¶é’ŸåŒæ­¥ç±»å‹ä¸æ˜¯ä»¥è§†é¢‘æ—¶é’Ÿä¸ºä¸»æ—¶é’Ÿçš„ã€‚å› ä¸ºå¦‚æœæ˜¯ä»¥è§†é¢‘æ—¶é’Ÿä¸ºä¸»æ—¶é’Ÿçš„è¯ï¼Œè§†é¢‘å¸§æ˜¯ä¸éœ€è¦åŒæ­¥çš„ï¼Œåªéœ€è¦æŒ‰é¡ºåºå¾€ä¸‹æ’­æ”¾å°±è¡Œäº†ï¼Œè€Œå…¶ä»–éŸ³é¢‘æ˜¯éœ€è¦æ ¹æ®è§†é¢‘æ—¶é’Ÿæ¥è°ƒæ•´åŒæ­¥çš„ã€‚åŒç†å¦‚æœæ˜¯ä»¥éŸ³é¢‘æ—¶é’Ÿä¸ºä¸»æ—¶é’Ÿçš„ï¼Œé‚£ä¹ˆéŸ³é¢‘æ­£å¸¸æ’­æ”¾ï¼Œå…¶ä»–æ—¶é’Ÿæ¯”å¦‚è§†é¢‘æ—¶é’Ÿåº”è¯¥å»åŠ¨æ€è°ƒæ•´é€Ÿåº¦ä»¥é€‚åº”(æˆ–è€…è¯´å¯¹é½)éŸ³é¢‘æ—¶é’Ÿã€‚è¯¦è§<a href="217ddfcf.html">Clock</a>ä¸­çš„åˆ†æã€‚</p>
<ol>
<li><p>é€šè¿‡<a href="217ddfcf.html">get_clock()</a>æ–¹æ³•æ¥è·å–å½“å‰è§†é¢‘æ—¶é’Ÿçš„å½“å‰æ—¶é—´ï¼Œä»¥åŠé€šè¿‡<a href="217ddfcf.html">get_master_clock()</a>æ–¹æ³•æ¥è·å–ä¸»æ—¶é’Ÿçš„å½“å‰æ—¶é—´ã€‚ç„¶åç”¨å½“å‰è§†é¢‘æ—¶é’Ÿçš„æ—¶é—´å‡å»ä¸»æ—¶é’Ÿçš„æ—¶é—´ï¼Œè®¡ç®—å‡ºè§†é¢‘æ—¶é’Ÿå’Œä¸»æ—¶é’Ÿçš„æ—¶é—´å·®diffã€‚å•ä½ä¸ºç§’ã€‚</p>
</li>
<li><p>è®¡ç®—sync_thresholdçš„å€¼ï¼Œå³å°†å…¥å‚delay(å¤–é¢çš„last_duration)èµ‹å€¼ç»™sync_thresholdï¼Œå¹¶ä¸”ä¿è¯sync_thresholdçš„å€¼ä¸å¤§äºAV_SYNC_THRESHOLD_MAXï¼Œä¸å°äºAV_SYNC_THRESHOLD_MINã€‚è¿™é‡Œçš„sync_thresholdå…¶å®å°±æ˜¯ä¸€ä¸ªåŒæ­¥åŒºé—´ï¼Œdiffåœ¨æ¬¡åŒºé—´å†…çš„åˆ™è®¤ä¸ºæ˜¯åŒæ­¥çš„ï¼Œä¸åšé¢å¤–è°ƒæ•´æ­£å¸¸æŒ‰ç…§last_durationæ—¶é•¿æ¥æ˜¾ç¤ºã€‚</p>
</li>
<li><p>åˆ¤æ–­æ—¶é—´å·®æ˜¯å¦åˆæ³•ä¸”å°äºAV_NOSYNC_THRESHOLDçš„ï¼Œè€ŒAV_NOSYNC_THRESHOLDæ˜¯100ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æ—¶é’Ÿå·®å¼‚å¤§äº100sæ—¶ï¼Œå¯èƒ½æœ‰å¤§çš„é”™è¯¯å‘ç”Ÿäº†ï¼Œæ­¤æ—¶å°±ä¸åšéŸ³è§†é¢‘åŒæ­¥æ“ä½œäº†ã€‚</p>
</li>
<li><p>æ»¡è¶³3ä¸­çš„æ¡ä»¶æ—¶ï¼Œæ¥ä¸‹æ¥å°±è¦æ ¹æ®diffå’Œsync_thresholdçš„å¤§å°å…³ç³»æ¥åšç›¸å…³æ“ä½œäº†ã€‚è€Œä»”ç»†çœ‹ä¸Šé¢åˆ†ææ—¶å¯ä»¥å°†ä¸Šé¢ifè¯­å¥ç­‰ä»·å˜æ¢ä¸ºä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isnan(diff) &amp;&amp; <span class="built_in">fabs</span>(diff) &lt; AV_NOSYNC_THRESHOLD) &#123;</span><br><span class="line">  <span class="keyword">if</span> (diff &lt;= -sync_threshold) &#123;</span><br><span class="line">    	delay = FFMAX(<span class="number">0</span>, delay + diff);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (diff &gt;= sync_threshold)&#123;</span><br><span class="line">      <span class="keyword">if</span> (delay &gt; AV_SYNC_FRAMEDUP_THRESHOLD) &#123;</span><br><span class="line">          delay = delay + diff;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          delay = <span class="number">2</span> * delay;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥å¯ä»¥æŒ‰ç…§diffä¸ºåæ ‡è½´ï¼Œç”»å‡ºå¦‚ä¸‹çš„ç¤ºæ„å›¾:</p>


<p>æ‰€ä»¥æ ¹æ®ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼š</p>
<ul>
<li><p>å½“diffè½åœ¨äº†-sync_thresholdå·¦è¾¹(åŒ…æ‹¬)æ—¶ï¼Œè€Œsync_thresholdè‚¯å®šæ˜¯å¤§äº0ï¼Œæ‰€ä»¥æ­¤æ—¶diffè‚¯å®šå°äº0ï¼Œä¹Ÿå°±æ˜¯è§†é¢‘æ—¶é’Ÿçš„å½“å‰æ—¶é—´å°äºä¸»æ—¶é’Ÿçš„å½“å‰æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è§†é¢‘æ’­æ”¾çš„æ…¢äº†ï¼Œæ‰€ä»¥æ­¤æ—¶è¿”å›FFMAX(0, delay + diff)ï¼š</p>
<ol>
<li>å¦‚æœdelay+diff&gt;0ï¼Œä¹Ÿå°±æ˜¯ä»delayä¸Šå‡å»äº†fab(diff)ï¼Œä¹Ÿå°±æ˜¯å‡å»äº†æ—¶é’Ÿå·®ï¼Œæ­¤æ—¶è§†é¢‘æ—¶é’Ÿå’Œä¸»æ—¶é’Ÿå¯¹é½äº†ï¼Œè¡¨ç¤ºè™½ç„¶lastvpçš„æ˜¾ç¤ºæ—¶é•¿ç¼©çŸ­äº†diffï¼Œä½†è¿™æ ·ä¿è¯äº†æ—¶é’Ÿçš„åŒæ­¥ã€‚</li>
<li>å¦‚æœdelay+diff&lt;0ï¼Œä¹Ÿå°±æ˜¯ä»delayä¸Šå‡å»äº†æ—¶é’Ÿå·®ä¹‹åå°äº0äº†ï¼Œé‚£ä¹ˆæ­¤æ—¶è¿”å›0ã€‚æ€»ä¸èƒ½è¿”å›è´Ÿæ•°å§ï¼Œè¿”å›è´Ÿæ•°å°±ç›¸å½“äºæ—¶å…‰å€’æµäº†å“ˆå“ˆã€‚</li>
<li>å¦‚æœdelay+diff&#x3D;0ï¼Œé‚£ä¹ˆè¿”å›0ã€‚è¡¨ç¤ºlastvpå‰©ä¸‹çš„æ—¶é—´éƒ½åˆ«å±•ç¤ºäº†ï¼Œç‰ºç‰²äº†lastvpçš„å±•ç¤ºæ—¶é—´èµ¢å¾—äº†æ—¶é’Ÿçš„åŒæ­¥ã€‚ä¸è¿‡delay+diff&#x3D;0è¿™æƒ…å†µä¹Ÿå¤ªå°‘äº†å“ˆå“ˆ</li>
</ol>
</li>
<li><p>å½“diffè½åœ¨(-sync_threshold,sync_threshold)ä¹‹é—´æ—¶ï¼Œè®¤ä¸ºéŸ³è§†é¢‘æ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥æ­¤æ—¶åŸå°ä¸åŠ¨è¿”å›delayï¼Œä¹Ÿå°±æ˜¯lastvpæœ¬è¯¥æ’­æ”¾æŒç»­çš„æ—¶é•¿ï¼ŒæŒ‰åŸå®šæ­¥ä¼èµ°ï¼Œä¸åŠ å¿«ä¹Ÿä¸å»¶è¿Ÿæ’­æ”¾ã€‚</p>
</li>
<li><p>å½“diffè½åœ¨äº†sync_thresholdå³è¾¹(åŒ…æ‹¬)æ—¶ï¼Œæ­¤æ—¶diffè‚¯å®šå¤§äº0ï¼Œä¹Ÿå°±æ˜¯è§†é¢‘æ’­æ”¾è¿‡å¿«ï¼Œæ­¤æ—¶éœ€è¦å‡ç¼“æ’­æ”¾ï¼š</p>
<ol>
<li><p>å¦‚æœdelay &gt; AV_SYNC_FRAMEDUP_THRESHOLDï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥lastvpå¸§åº”è¯¥æ˜¾ç¤ºçš„æ—¶é—´æœ¬æ¥å°±å¾ˆé•¿ï¼Œé‚£ä¹ˆæ²¡åŠæ³•ï¼Œä¸èƒ½é‡å¤æ’­æ”¾æ­¤å¸§ï¼Œå› ä¸ºè¯¥æ—¶é•¿ååŒå€å°±æ›´å¤§äº†ï¼Œåé¢å°±ä¼šè¶Šè¿‡æ›´å¤šçš„å¸§ï¼Œæ‰€ä»¥æ­¤æ—¶ç»™è¯¥lastvpå¸§åŸæ¥åº”æ’­æ”¾çš„æ—¶é•¿ä¸Šå†å¢åŠ diffï¼Œè¡¨ç¤ºè®©å…¶åœ¨åŸåŸºç¡€ä¸Šå¤šæ’­æ”¾diffç§’ï¼Œä»¥å®ç°æ—¶é’ŸåŒæ­¥ã€‚è€Œè¿™ä¹Ÿæ­£å’Œå®˜æ–¹å¯¹äºAV_SYNC_FRAMEDUP_THRESHOLDçš„æ³¨é‡Šä¸­æ‰€è¨€:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* If a frame duration is longer than this, it will not be duplicated to compensate AV sync */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¦‚æœdelay &lt;&#x3D; AV_SYNC_FRAMEDUP_THRESHOLDï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ç®€å•çš„å°†è¯¥å¸§åœ¨æ’­æ”¾ä¸€æ¬¡å§ï¼Œä¹Ÿå°±æ˜¯å°†åŸæ’­æ”¾æ—¶é—´åŒå€ã€‚</p>
</li>
</ol>
</li>
</ul>
</li>
</ol>
<p>æ€»ç»“compute_target_delay()æ–¹æ³•ï¼š</p>
<ul>
<li>ä¸»è¦ç”¨äºå®ç°æ’­æ”¾åŒæ­¥ï¼Œä¿è¯è§†é¢‘æ—¶é’Ÿå’Œä¸»æ—¶é’ŸåŒæ­¥ã€‚å…¥å‚delayä¸ºå½“å‰å¸§(lastvp)ç†åº”æŒç»­çš„æ—¶é—´ã€‚</li>
<li>è®¡ç®—å‡ºsync_thresholdï¼Œè¡¨ç¤ºåŒæ­¥åŒºé—´ï¼Œåœ¨æ­¤åŒºé—´å†…é»˜è®¤ä¸ºæ—¶é’Ÿæ˜¯åŒæ­¥ï¼Œä¸åšåŒæ­¥çº æ­£ï¼ŒåŸå°ä¸åŠ¨è¿”å›delayã€‚</li>
<li>å¦‚è‹¥è§†é¢‘æ—¶é’Ÿæ…¢äºä¸»æ—¶é’Ÿï¼Œä¸”è¶…è¿‡åŒæ­¥åŒºé—´ï¼Œé‚£ä¹ˆåŠ å¿«è§†é¢‘çš„æ’­æ”¾ï¼Œé€šè¿‡çš„æ–¹æ³•å°±æ˜¯å‡å°‘å½“å‰å¸§lastvpçš„å±•ç¤ºæ—¶é•¿ï¼Œä¹Ÿå°±æ˜¯å‡å°‘delayçš„å€¼ã€‚</li>
<li>å¦‚æœè§†é¢‘æ—¶é’Ÿå¿«äºä¸»æ—¶é’Ÿï¼Œä¸”è¶…è¿‡åŒæ­¥åŒºé—´ï¼Œé‚£ä¹ˆå‡ç¼“è§†é¢‘çš„æ’­æ”¾ï¼Œé€šè¿‡çš„æ–¹æ³•å°±æ˜¯å¢åŠ å½“å‰å¸§lastvpçš„å±•ç¤ºæ—¶é•¿ï¼Œä¹Ÿå°±æ˜¯å¢åŠ delayçš„å€¼ã€‚</li>
</ul>
</li>
</ol>
<h5 id="ç¬¬2æ­¥å°ç»“ï¼š"><a href="#ç¬¬2æ­¥å°ç»“ï¼š" class="headerlink" title="ç¬¬2æ­¥å°ç»“ï¼š"></a>ç¬¬2æ­¥å°ç»“ï¼š</h5><p>ç¬¬2æ­¥ä¸»è¦é€»è¾‘å°±æ˜¯è®¡ç®—å½“å‰æ­£åœ¨å±•ç¤ºæ’­æ”¾çš„å¸§lastvpåº”æŒç»­çš„æ—¶é•¿ï¼Œå…ˆè®¡ç®—å‡ºlast_durationï¼Œåœ¨é€šè¿‡last_durationè®¡ç®—å‡ºæœ€ç»ˆçš„æ—¶é•¿delayï¼Œä»¥ä¾›åé¢åˆ¤æ–­ä½¿ç”¨ã€‚</p>
<h5 id="ç¬¬3æ­¥"><a href="#ç¬¬3æ­¥" class="headerlink" title="ç¬¬3æ­¥:"></a>ç¬¬3æ­¥:</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">time = av_gettime_relative() / <span class="number">1000000.0</span>;</span><br><span class="line"><span class="keyword">if</span> (isnan(is-&gt;frame_timer) || time &lt; is-&gt;frame_timer) &#123;</span><br><span class="line">		is-&gt;frame_timer = time;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (time &lt; is-&gt;frame_timer + delay) &#123;</span><br><span class="line">		*remaining_time = FFMIN(is-&gt;frame_timer + delay - time, *remaining_time);</span><br><span class="line">		<span class="keyword">goto</span> display;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬3æ­¥ä¸­é¦–å…ˆé€šè¿‡av_gettime_relative()æ–¹æ³•æ‹¿åˆ°ç³»ç»Ÿå½“å‰æ—¶é—´timeï¼Œå•ä½ä¸ºsã€‚ç„¶ååˆ¤æ–­å¦‚æœframe_timerå€¼ä¸åˆæ³•æˆ–è€…è¯´å¤§äºå½“å‰ç³»ç»Ÿæ—¶é—´ï¼Œé‚£ä¹ˆå°±å°†å…¶æ›´æ–°ä¸ºç³»ç»Ÿå½“å‰æ—¶é—´ã€‚å› ä¸ºframe_timerè¡¨ç¤ºçš„æ˜¯ä¸Šä¸€å¸§æ˜¾ç¤ºæ—¶çš„æ—¶é—´ï¼Œè‚¯å®šå°äºç³»ç»Ÿå½“å‰æ—¶é—´çš„ï¼Œè€Œè¿™é‡Œå°±æ˜¯åšæ—¶é—´çº æ­£ã€‚</p>
<p>ç„¶åè®¡ç®—å½“å‰å¸§lastvpçš„ç»“æŸæ—¶é—´ï¼šä¹Ÿå°±æ˜¯å½“å‰å¸§lastvpçš„å¼€å§‹å±•ç¤ºæ—¶é—´is-&gt;frame_timeråŠ ä¸Šå½“å‰å¸§lastvpçš„åº”æŒç»­æ—¶é•¿(ç»è¿‡ä¸Šé¢ç¬¬2æ­¥ä¸­æ—¶é’ŸåŒæ­¥é€»è¾‘åçš„)ï¼Œç„¶åå°†ç³»ç»Ÿå½“å‰æ—¶é—´å’Œå½“å‰å¸§lastvpçš„ç»“æŸæ—¶é—´åšæ¯”è¾ƒï¼Œå¦‚æœå°äºï¼Œè¡¨ç¤ºå½“å‰å¸§lastvpè¿˜æ²¡æœ‰æ’­æ”¾å®Œï¼Œåº”è¯¥æ¥ç€å±•ç¤ºè¯¥å¸§ï¼Œé‚£ä¹ˆæ­¤æ—¶å…ˆä¿®æ”¹å…¥å‚remaining_timeçš„å€¼ä¸ºå½“å‰å¸§lastvpå‰©ä½™çš„å±•ç¤ºæ—¶é—´(is-&gt;frame_timer + delay - time)ï¼Œè¡¨ç¤ºç­‰ä¸‹æ¬¡video_refresh_thread()æ–¹æ³•ä¸­å¾ªç¯æ—¶å…ˆä¼‘çœ è¿™ä¹ˆé•¿æ—¶é—´åå†æ¥æ‰§è¡Œæœ¬æ–¹æ³•video_refreshæ¥åˆ·æ–°å±•ç¤ºä¸‹ä¸€å¸§ï¼Œä¿®æ”¹å®Œremaining_timeçš„å€¼åå°±è·³åˆ°displayå¤„ï¼Œè¡¨ç¤ºæ­¤æ¬¡video_refreshé€»è¾‘ç»“æŸ(è·³åˆ°displayå¤„ä¸ä¸€å®šæ˜¯å±•ç¤ºå“¦ï¼Œå› ä¸ºä¼šæœ‰å…¶ä»–æ¡ä»¶åˆ¤æ–­ï¼Œæ¯”å¦‚force_refresh)ã€‚</p>
<h5 id="ç¬¬3æ­¥å°ç»“ï¼š"><a href="#ç¬¬3æ­¥å°ç»“ï¼š" class="headerlink" title="ç¬¬3æ­¥å°ç»“ï¼š"></a>ç¬¬3æ­¥å°ç»“ï¼š</h5><p>ç¬¬3æ­¥ä¸»è¦æ˜¯åˆ¤æ–­å½“å‰å¸§lastvpçš„å±•ç¤ºæ—¶é—´æ˜¯å¦å·²ç»ç»“æŸï¼Œå¦‚æœæœªç»“æŸå°±æ¥ç€å±•ç¤ºï¼Œä¸ä¼šæ‰§è¡Œä¸‹é¢çš„ç¬¬4æ­¥ç¬¬5æ­¥ç­‰æ­¥éª¤äº†ã€‚</p>
<h5 id="ç¬¬4æ­¥"><a href="#ç¬¬4æ­¥" class="headerlink" title="ç¬¬4æ­¥:"></a>ç¬¬4æ­¥:</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">is-&gt;frame_timer += delay;</span><br><span class="line"><span class="keyword">if</span> (delay &gt; <span class="number">0</span> &amp;&amp; time - is-&gt;frame_timer &gt; AV_SYNC_THRESHOLD_MAX) &#123;</span><br><span class="line">		is-&gt;frame_timer = time;</span><br><span class="line">&#125;</span><br><span class="line">SDL_LockMutex(is-&gt;pictq.mutex);</span><br><span class="line"><span class="keyword">if</span> (!isnan(vp-&gt;pts)) &#123;</span><br><span class="line">		update_video_pts(is, vp-&gt;pts, vp-&gt;pos, vp-&gt;serial);</span><br><span class="line">&#125;</span><br><span class="line">SDL_UnlockMutex(is-&gt;pictq.mutex);</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ç¬¬3æ­¥ä¸­å·²ç»åˆ¤æ–­äº†å½“å‰å¸§lastvpçš„å±•ç¤ºæ—¶é•¿ï¼Œå¦‚æœå…¶å±•ç¤ºæ—¶é—´æœªç»“æŸï¼Œé‚£ä¹ˆä¸ä¼šèµ°å½“å‰é€»è¾‘ï¼Œæ‰€ä»¥å½“å‰é€»è¾‘æ˜¯åŸºäºå½“å‰å¸§lastvpçš„å±•ç¤ºæ—¶é—´å·²ç»åˆ°äº†çš„å‰æä¸‹çš„ã€‚</p>
<p>æ‰€ä»¥æ­¤æ—¶å…ˆæ›´æ–°is-&gt;frame_timerçš„å€¼ï¼Œç»™å…¶åŠ ä¸Šdelayï¼Œä¹Ÿå°±æ˜¯åŠ ä¸Šå½“å‰å¸§lastvpçš„æŒç»­æ—¶é—´ï¼Œæ‰€ä»¥åŠ å®Œdelayä¹‹åï¼Œis-&gt;frame_timerå°±è¡¨ç¤ºçš„æ˜¯lastvpçš„ç»“æŸæ—¶é—´ç‚¹ï¼Œvpçš„å¼€å§‹æ—¶é—´ç‚¹ã€‚</p>
<p>ç„¶åå†åšæ—¶é—´æ ¡å‡†ï¼Œå³å½“å½“å‰æ—¶é—´å‡å»is-&gt;frame_timerçš„å€¼å¤§äºAV_SYNC_THRESHOLD_MAX(0.1s)ï¼Œé‚£ä¹ˆå°±å°†frame_timerç½®ä¸ºå½“å‰æ—¶é—´ã€‚</p>
<p>ç„¶åé€šè¿‡<a href="217ddfcf.html">update_video_pts()</a>æ–¹æ³•æ¥æ›´æ–°è§†é¢‘æ—¶é’Ÿçš„æ—¶é—´ï¼Œæ³¨æ„è¿™é‡Œæ›´æ–°ç”¨çš„ptsæ˜¯vpçš„è€Œä¸æ˜¯lastvpçš„ï¼Œä¹Ÿå°±æ˜¯å½“å‰å‡†å¤‡æ’­æ”¾vpäº†ã€‚</p>
<h5 id="ç¬¬4æ­¥å°ç»“ï¼š"><a href="#ç¬¬4æ­¥å°ç»“ï¼š" class="headerlink" title="ç¬¬4æ­¥å°ç»“ï¼š"></a>ç¬¬4æ­¥å°ç»“ï¼š</h5><p>ç¬¬4æ­¥ä¸»è¦é€»è¾‘å°±æ˜¯å°†ç›¸å…³ä¿¡æ¯æ›´æ–°æˆvpçš„ï¼Œæ¯”å¦‚frame_timeræ›´æ–°æˆvpçš„å¼€å§‹æ—¶é—´(ä¹Ÿå°±æ˜¯lastvpçš„ç»“æŸæ—¶é—´)ï¼Œå·²ç»è§†é¢‘æ—¶é’Ÿçš„æ›´æ–°ã€‚åšè¿™äº›æ›´æ–°ä¸»è¦æ˜¯ä¸ºäº†åé¢åšå‡†å¤‡ã€‚</p>
<h5 id="ç¬¬5æ­¥"><a href="#ç¬¬5æ­¥" class="headerlink" title="ç¬¬5æ­¥:"></a>ç¬¬5æ­¥:</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (frame_queue_nb_remaining(&amp;is-&gt;pictq) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    Frame *nextvp = frame_queue_peek_next(&amp;is-&gt;pictq);</span><br><span class="line">    duration = vp_duration(is, vp, nextvp);</span><br><span class="line">    <span class="keyword">if</span> (!is-&gt;step &amp;&amp; (ffp-&gt;framedrop &gt; <span class="number">0</span> || (ffp-&gt;framedrop &amp;&amp; get_master_sync_type(is) != AV_SYNC_VIDEO_MASTER)) &amp;&amp; time &gt; is-&gt;frame_timer + duration) &#123;</span><br><span class="line">        frame_queue_next(&amp;is-&gt;pictq);</span><br><span class="line">        <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè¿˜æ˜¯å…ˆè°ƒç”¨<a href="866c32fa.html">frame_queue_nb_remaining()</a>æ–¹æ³•æ¥è·å–å½“å‰pictqé˜Ÿåˆ—ä¸­å‰©ä½™çš„æ•°æ®ä¸ªæ•°ï¼Œåˆ¤æ–­å…¶æ˜¯å¦å¤§äº1ï¼Œå¦‚æœå¤§äº1ï¼Œä¹Ÿå°±æ˜¯è¡¨ç¤ºåœ¨vpä¹‹åè¿˜æœ‰nextvpï¼Œé‚£ä¹ˆé€šè¿‡<a href="866c32fa.html">frame_queue_peek_next</a>æ–¹æ³•æ¥è·å–vpä¹‹åçš„æ•°æ®nextvp(è¯¦è§ä¸Šé¢ç¬¬ä¸€å¼ å›¾)ã€‚ç„¶ååŒæ ·è¿˜æ˜¯é€šè¿‡vp_duration()æ–¹æ³•æ¥è®¡ç®—æŒç»­æ—¶é•¿ï¼Œä¸è¿‡æ­¤æ—¶è®¡ç®—çš„æ˜¯vpçš„æŒç»­æ—¶é•¿ï¼Œä¸Šé¢è®¡ç®—çš„æ˜¯lastvpçš„æŒç»­æ—¶é•¿ã€‚ç„¶åå°±æ˜¯ifæ¡ä»¶åˆ¤æ–­ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦ä¸¢å¸§:</p>
<ol>
<li><p>is-&gt;stepï¼š</p>
<p>å…³äºstepï¼Œä¸€èˆ¬æ˜¯æš‚åœçŠ¶æ€æ—¶seekï¼Œæ­¤æ—¶ä¼šå°†èµ·ç½®ä¸º1ï¼Œç„¶åseekæˆåŠŸåä¼šæ˜¾ç¤ºseekåçš„ä¸€å¸§ç”»é¢ç”¨äºä½“ç°seekæˆåŠŸäº†ã€‚è¿™é‡Œä¸æ˜¯stepçŠ¶æ€æ‰ä¸¢å¸§èµ°retryï¼Œå¦‚æœæ—¶stepçŠ¶æ€ä¸èµ°ä¸¢å¸§retryé€»è¾‘ï¼Œå…·ä½“ä¸‹é¢ä¼šæœ‰ã€‚</p>
</li>
<li><p>(ffp-&gt;framedrop &gt; 0 || (ffp-&gt;framedrop &amp;&amp; get_master_sync_type(is) !&#x3D; AV_SYNC_VIDEO_MASTER)ï¼š</p>
</li>
</ol>
<p>   framedropæ˜¯ç”¨æˆ·å¯é…ç½®çš„å¼€å…³ï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸ä¸¢å¸§ã€‚å…³äºframedropåœ¨<a href="8876f557.html">func_run_sync</a>ã€<a href="3da735d9.html">drain_output_buffer2</a>ã€<a href="33f55665.html">get_video_frame</a>ä¸­éƒ½æœ‰ç®€å•ä»‹ç»è¿‡ï¼Œä¹Ÿå°±æ˜¯è§£ç æ—¶çš„ä¸¢å¸§æ“ä½œã€‚è€Œè¿™é‡Œçš„æ˜¯å±•ç¤ºä¸­çš„ä¸¢å¸§æ“ä½œï¼Œæ‰€ä»¥åœ¨ijkplayer(ç”šè‡³ffplay)ä¸­ï¼Œè§†é¢‘ä¸¢å¸§çš„æ“ä½œå­˜åœ¨äºè§†é¢‘è§£ç æ—¶å’Œè§†é¢‘å±•ç¤ºæ—¶ã€‚</p>
<ol start="3">
<li><p>time &gt; is-&gt;frame_timer + duration</p>
<p>ç”±äºä¸Šé¢ç¬¬4æ­¥ä¸­å·²ç»å°†frame_timeræ›´æ–°æˆvpçš„å¼€å§‹æ—¶é—´äº†(ä¹Ÿå°±æ˜¯lastvpçš„ç»“æŸæ—¶é—´)ï¼Œè€Œæ­¤æ—¶durationåˆæ˜¯vpçš„å±•ç¤ºæŒç»­æ—¶é•¿ï¼Œæ‰€ä»¥is-&gt;frame_timer + durationå°±æ˜¯vpçš„ç»“æŸæ—¶é—´ã€‚ä¹Ÿå°±æ˜¯è¯´æ­¤å¤„åˆ¤æ–­å½“å‰æ—¶é—´æ˜¯å¦å¤§äºvpçš„ç»“æŸæ—¶é—´ï¼Œå¦‚æœå¤§äºè¡¨ç¤ºå½“å‰å·²ç»è¿‡äº†vpè¿™å¸§çš„å±•ç¤ºæ—¶é—´äº†ï¼Œä¹Ÿå°±æ˜¯è¯´vpè¯¥å¸§æ°¸æ— å‡ºå¤´ä¹‹æ—¥ã€‚</p>
</li>
</ol>
<p>æ‰€ä»¥å½“ä¸Šé¢æ¡ä»¶æ»¡è¶³æ—¶ï¼Œè¡¨ç¤ºéœ€è¦ä¸¢å¸§ï¼Œæ‰€ä»¥è°ƒç”¨<a href="866c32fa.html">frame_queue_next</a>æ–¹æ³•æ¥å®Œæˆä¸¢å¸§æ“ä½œï¼Œä½†æ˜¯éœ€æ³¨æ„æ­¤å¤„ä¸¢å¼ƒçš„ä»æ˜¯lastvpè€Œä¸æ˜¯vpã€‚</p>
<blockquote>
<p>ä¸ºä½•è¿™é‡Œä¸¢å¼ƒçš„æ˜¯lastvpï¼Ÿ</p>
<p>è‡³äºè¿™é‡Œä¸ºä»€ä¹ˆåªä¸¢å¼ƒlastvpï¼Œè€Œä¸æ˜¯å°†lastvpå’Œvpä¸€åŒä¸¢æ‰ï¼Œæˆ‘è§‰å¾—åŸå› æœ‰ä¸‰ï¼š</p>
<ol>
<li>å’Œä¸Šé¢ç¬¬1æ­¥ä¸­çš„åˆ†æå·®ä¸å¤šï¼Œä¸»è¦è¿˜æ˜¯ä¸ºäº†ä¿æŒkeep_lastæœºåˆ¶å§ã€‚</li>
<li>å› ä¸ºä¸Šé¢ç¬¬4æ­¥ä¸­åªæ˜¯å°†frame_timeræ›´æ–°æˆvpçš„å¼€å§‹æ—¶é—´ï¼Œè€Œæ­¤å¤„å¦‚æœå°†vpä¸€åŒä¸¢æ‰ï¼Œé‚£ä¹ˆè¿˜éœ€å†æ›´æ–°frame_timerï¼Œå°†å…¶æ›´æ–°æˆvpçš„ç»“æŸæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯nextvpçš„å¼€å§‹æ—¶é—´ã€‚</li>
<li>å¦‚æœåŒæ—¶ä¸¢æ‰vpçš„è¯ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€å¸§æ²¡æœ‰ç»è¿‡åŒæ­¥é€»è¾‘è®¡ç®—ã€‚è€Œå¦‚æœåªä¸¢æ‰lastvpï¼Œé‚£ä¹ˆè¿™æ ·é€»è¾‘ç»Ÿä¸€äº†ï¼Œæ¯ä¸€å¸§éƒ½ä¼šç»è¿‡åŒæ­¥é€»è¾‘è®¡ç®—ï¼Œè€Œä¸”å°±ç®—æ­¤æ—¶ä¸ä¸¢æ‰ç­‰ä¸‹ä¸€æ¬¡retryæ—¶å†ä¸¢æ‰ä¹Ÿæ˜¯okçš„ã€‚</li>
</ol>
</blockquote>
<h5 id="ç¬¬5æ­¥å°ç»“"><a href="#ç¬¬5æ­¥å°ç»“" class="headerlink" title="ç¬¬5æ­¥å°ç»“:"></a>ç¬¬5æ­¥å°ç»“:</h5><p>ç¬¬5æ­¥ä¸»è¦é€»è¾‘å°±æ˜¯ä¸¢å¸§ã€‚åˆ¤æ–­å½“å‰æ˜¯å¦å·²ç»è¿‡äº†vpçš„æ˜¾ç¤ºæ—¶é—´ã€‚å¦‚æœå·²è¶…è¿‡ï¼Œæ­¤å¤„ä¸¢å¼ƒçš„æ˜¯lastvpï¼Œè€Œä¸æ˜¯lastvpå’Œvpã€‚</p>
<h5 id="ç¬¬6æ­¥"><a href="#ç¬¬6æ­¥" class="headerlink" title="ç¬¬6æ­¥:"></a>ç¬¬6æ­¥:</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (is-&gt;subtitle_st) &#123;</span><br><span class="line">     <span class="keyword">while</span> (frame_queue_nb_remaining(&amp;is-&gt;subpq) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        sp = frame_queue_peek(&amp;is-&gt;subpq);</span><br><span class="line">				<span class="keyword">if</span> (frame_queue_nb_remaining(&amp;is-&gt;subpq) &gt; <span class="number">1</span>)</span><br><span class="line">        		sp2 = frame_queue_peek_next(&amp;is-&gt;subpq);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        		sp2 = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (sp-&gt;serial != is-&gt;subtitleq.serial || (is-&gt;vidclk.pts &gt; (sp-&gt;pts + ((<span class="type">float</span>) sp-&gt;sub.end_display_time / <span class="number">1000</span>)))|| (sp2 &amp;&amp; is-&gt;vidclk.pts &gt; (sp2-&gt;pts + ((<span class="type">float</span>) sp2-&gt;sub.start_display_time / <span class="number">1000</span>)))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sp-&gt;uploaded) &#123;</span><br><span class="line">            		ffp_notify_msg4(ffp, FFP_MSG_TIMED_TEXT, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;&quot;</span>, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            frame_queue_next(&amp;is-&gt;subpq);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        		<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬6æ­¥ä¸»è¦æ˜¯å­—å¹•æ’­æ”¾ï¼Œè¿™é‡Œç•™ä¸ªTODOæš‚ä¸åˆ†æã€‚</p>
<h5 id="ç¬¬6æ­¥å°ç»“"><a href="#ç¬¬6æ­¥å°ç»“" class="headerlink" title="ç¬¬6æ­¥å°ç»“:"></a>ç¬¬6æ­¥å°ç»“:</h5><p>TODO</p>
<h5 id="ç¬¬7æ­¥ï¼š"><a href="#ç¬¬7æ­¥ï¼š" class="headerlink" title="ç¬¬7æ­¥ï¼š"></a>ç¬¬7æ­¥ï¼š</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">frame_queue_next(&amp;is-&gt;pictq);</span><br><span class="line">is-&gt;force_refresh = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">SDL_LockMutex(ffp-&gt;is-&gt;play_mutex);</span><br><span class="line"><span class="keyword">if</span> (is-&gt;step) &#123;</span><br><span class="line">    is-&gt;step = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!is-&gt;paused)</span><br><span class="line">   		 stream_update_pause_l(ffp);</span><br><span class="line">&#125;</span><br><span class="line">SDL_UnlockMutex(ffp-&gt;is-&gt;play_mutex);</span><br></pre></td></tr></table></figure>

<p>èƒ½æ‰§è¡Œåˆ°è¿™ä¸€æ­¥ï¼Œè¡¨ç¤ºå½“å‰è§†é¢‘å¸§lastvpçš„å±•ç¤ºæ—¶é—´å·²ç»ç”¨å®Œäº†ï¼Œè¯¥å±•ç¤ºvpäº†ã€‚é‚£ä¹ˆæ­¤æ—¶è°ƒç”¨è°ƒç”¨<a href="866c32fa.html">frame_queue_next</a>æ–¹æ³•æ¥å°†lastvpä¸¢æ‰ï¼Œç„¶åå°†force_refreshç½®ä¸º1ï¼Œè¡¨ç¤ºvpå¸§å³å°†è¦å±•ç¤ºã€‚è¿™é‡Œä¸¢å¼ƒçš„æ˜¯lastvpå°±å¾ˆåˆæƒ…ç†äº†ï¼Œå› ä¸ºlastvpå±•ç¤ºå®Œäº†ï¼Œè¯¥vpäº†ï¼Œæ‰€ä»¥lastvpä¸¢æ‰ï¼Œæ­¤æ—¶é˜Ÿåˆ—å¤´éƒ¨å°±æ˜¯vpäº†ã€‚ä½†æ˜¯æ­¤æ—¶å¯èƒ½å°±æœ‰ç–‘é—®ï¼š</p>
<blockquote>
<p>ä¸ºå•¥ç°åœ¨ä¸è¯´keep_lastæœºåˆ¶äº†ï¼Ÿ</p>
<p>å› ä¸ºæ­¤æ—¶æœ¬å°±æ»¡è¶³keep_lastæœºåˆ¶ã€‚force_refreshç½®ä¸ºäº†1ï¼Œé‚£ä¹ˆæ‰§è¡Œåˆ°ä¸‹é¢çš„displayå¤„æ—¶ï¼Œä¼šæ»¡è¶³æ¡ä»¶è€Œè°ƒç”¨<a href="205c40e1.html">video_display2</a>æ–¹æ³•æ¥å±•ç¤ºvpè¿™ä¸€å¸§ï¼Œé‚£ä¹ˆæ­¤æ—¶vpå°±å’Œä¸Šé¢è¯´çš„lastvpä¸€æ ·äº†ã€‚è€Œkeep_lastæœºåˆ¶å°±æ˜¯ä¿ç•™å·²æ’­æ”¾çš„ä¸Šä¸€å¸§ï¼Œå¯¹æ­¤å¤„æ¥è¯´å°±æ˜¯ä¿ç•™vpè¿™ä¸€å¸§ï¼Œæ‰€ä»¥æ²¡é—®é¢˜ã€‚</p>
</blockquote>
<p>ç„¶ååˆ¤æ–­stepæ˜¯å¦ä¸º1ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œè¡¨ç¤ºå½“å‰æ˜¯æš‚åœçŠ¶æ€çš„seekæˆåŠŸäº†ï¼Œæ­¤æ—¶éœ€è¦å±•ç¤ºseekæˆåŠŸåçš„ä¸€å¸§ï¼Œä»¥ä½“ç°seekæˆåŠŸã€‚é‚£ä¹ˆå…ˆå°†stepç½®ä¸º0è¡¨ç¤ºstepæˆåŠŸï¼Œç„¶åå°†æ’­æ”¾å™¨çŠ¶æ€ç»´æŒä¸ºæš‚åœã€‚è€Œä¸Šé¢ç¬¬5æ­¥ä¸­çš„ä¸¢å¸§æ“ä½œä¸­ä¹Ÿæœ‰å¯¹stepçš„åˆ¤æ–­ï¼Œå¯ä»¥å¯¹ç…§ä¸Šé¢ç¬¬5æ­¥ä¸­çš„é€»è¾‘æ¥ç†è§£ã€‚</p>
<h5 id="ç¬¬7æ­¥å°ç»“"><a href="#ç¬¬7æ­¥å°ç»“" class="headerlink" title="ç¬¬7æ­¥å°ç»“:"></a>ç¬¬7æ­¥å°ç»“:</h5><p>æ€»çš„æ¥è¯´ç¬¬7æ­¥å°±æ˜¯ç”¨æ¥æ­£å¸¸é€»è¾‘çš„ä¸¢å¼ƒlastvpï¼Œç„¶åä¸ºåé¢çš„å±•ç¤ºvpåšå‡†å¤‡(å°†force_refreshç½®ä¸º1)ã€‚</p>
<h5 id="ç¬¬8æ­¥ï¼š"><a href="#ç¬¬8æ­¥ï¼š" class="headerlink" title="ç¬¬8æ­¥ï¼š"></a>ç¬¬8æ­¥ï¼š</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!ffp-&gt;display_disable &amp;&amp; is-&gt;force_refresh &amp;&amp; is-&gt;show_mode == SHOW_MODE_VIDEO &amp;&amp; is-&gt;pictq.rindex_shown) &#123;</span><br><span class="line">		video_display2(ffp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬8æ­¥ä¹Ÿå°±æ˜¯ä¸Šé¢ä¸€ç›´æåˆ°çš„displayå¤„ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œè¦å±•ç¤ºvpè¿™ä¸€å¸§è¿˜æ˜¯æœ‰å¾ˆå¤šæ¡ä»¶çš„:</p>
<ul>
<li><p>!ffp-&gt;display_disable</p>
<p>å½“å‰è§†é¢‘å¸§å±•ç¤ºæ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿå°±æ˜¯display_disableæ˜¯0ã€‚è¿™ä¸ªå¼€å…³ä¸€èˆ¬ç”¨æˆ·æ¥è®¾ç½®ï¼Œè¯¦è§ff_ffplay_options.c#ffp_context_optionsä¸­çš„å®šä¹‰ã€‚</p>
</li>
<li><p>is-&gt;force_refresh</p>
<p>ä¸Šé¢ä»‹ç»è¿‡äº†ï¼Œå†ç¬¬7æ­¥ä¸­ä¹Ÿæœ‰ä»‹ç»ã€‚æœ€ç»ˆæ»¡ä¸æ»¡è¶³ifæ¡ä»¶å¤šåŠæ˜¯ç”±è¿™ä¸ªå€¼æ¥å†³å®šçš„ï¼Œè€Œåœ¨ä¸Šé¢å¥½å¤šæ­¥ä¸­éƒ½æœ‰è·³displayçš„é€»è¾‘ï¼Œä½†æ˜¯å¤§å¤šæ•°æ˜¯è¿›ä¸å»è¿™ä¸ªifçš„ï¼Œé™¤éç¬¬7æ­¥ã€‚</p>
</li>
<li><p>is-&gt;show_mode &#x3D;&#x3D; SHOW_MODE_VIDEO</p>
<p>ä¸Šé¢ä¸€å¼€å§‹æœ‰ä»‹ç»ï¼Œä¸å†èµ˜è¿°ã€‚</p>
</li>
<li><p>is-&gt;pictq.rindex_shown</p>
<p>è¯¥å€¼å¯¹äºéŸ³é¢‘ã€è§†é¢‘é˜Ÿåˆ—ä¸€èˆ¬æ˜¯1ï¼Œå­—å¹•é˜Ÿåˆ—æ˜¯0ã€‚è¯¥å€¼çš„å­˜åœ¨å°±æ˜¯ä¸ºäº†å®ç°<a href="866c32fa.html">keep_last</a>æœºåˆ¶ã€‚</p>
</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¦æœ€ç»ˆè°ƒç”¨<a href="205c40e1.html">video_display2</a>æ–¹æ³•æ¥å±•ç¤ºvpæ¡ä»¶è¿˜æ˜¯æŒºå¤šçš„ï¼Œä½†æ˜¯å®è´¨ä¸Šå†³å®šæ¡ä»¶æ˜¯force_refreshã€‚</p>
<h5 id="ç¬¬8æ­¥å°ç»“"><a href="#ç¬¬8æ­¥å°ç»“" class="headerlink" title="ç¬¬8æ­¥å°ç»“:"></a>ç¬¬8æ­¥å°ç»“:</h5><p>åˆ¤æ–­æ¡ä»¶æ»¡è¶³åè°ƒç”¨<a href="205c40e1.html">video_display2</a>æ–¹æ³•æ¥å±•ç¤ºvpã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼š</p>
<p>è¿™é‡Œè¯´çš„å±•ç¤ºvpï¼Œå…¶å®æ˜¯é’ˆå¯¹video_refresh()æ–¹æ³•æœ¬æ¬¡çš„æ‰§è¡Œæ¥è¯´çš„ï¼Œè€Œåˆå› ä¸ºåœ¨ä¸Šé¢ç¬¬7æ­¥ä¸­è°ƒç”¨äº†frame_queue_next()æ–¹æ³•ï¼Œæ‰€ä»¥æ­¤æ—¶è¯´çš„vpå…¶å®æ˜¯ä¸‹æ¬¡video_refresh()æ–¹æ³•æ‰§è¡Œæ—¶çš„lastvpäº†ã€‚</p>
</blockquote>
<h5 id="ç¬¬9æ­¥ï¼š"><a href="#ç¬¬9æ­¥ï¼š" class="headerlink" title="ç¬¬9æ­¥ï¼š"></a>ç¬¬9æ­¥ï¼š</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">is-&gt;force_refresh = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€æ­¥å¤ªç®€å•äº†å°±æ˜¯å°†force_refreshç½®ä¸º0ã€‚ä¹Ÿå°±æ˜¯è¯´ä»ç¬¬7æ­¥ä¸­ç½®ä¸º1ï¼Œç„¶ååˆ°äº†ç¬¬8æ­¥ä¸­æ»¡è¶³äº†æ¡ä»¶æ‰§è¡Œäº†<a href="205c40e1.html">video_display2</a>æ–¹æ³•ï¼Œé‚£ä¹ˆä¹‹åå°±ç«‹é©¬å°†å…¶ç½®ä¸º0ã€‚è¶³ä»¥çœ‹å‡ºforce_refreshçš„é‡è¦æ€§äº†ã€‚åˆ«çœ‹ç¬¬8æ­¥ä¸­æ¡ä»¶é‚£ä¹ˆå¤šï¼Œæœ€ç»ˆèµ·ä½œç”¨çš„è¿˜æ˜¯è¿™ä¸ªï¼Œå› ä¸ºå…¶ä»–å‡ ä¸ªéƒ½æ˜¯åŸºæœ¬ä¸å˜çš„ã€‚</p>
<h4 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h4><p>å…¶å®ç›¸æ¯”è¾ƒäºä¹‹å‰åˆ†æçš„æ–¹æ³•æ¥è¯´ï¼Œæœ¬æ–¹æ³•å¹¶ä¸ç®—å¤šï¼Œä½†æ˜¯è¿˜æ˜¯åˆ†äº†9æ­¥æ¥è§£é‡Šï¼Œå…¶ä¸­ä¸€ä¸ªåŸå› å°±æ˜¯è¿™ä¸ªæ–¹æ³•å¤ªé‡è¦äº†ï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°éŸ³è§†é¢‘æ—¶é’ŸåŒæ­¥ã€FrameQueueç­‰ï¼Œç€å®çœ‹äº†å¥½ä¹…æ‰çœ‹å¾—ä¸€çš®æ¯›ï¼Œæ‰€ä»¥å…ˆåšè®°å½•ï¼Œä¸ç„¶åé¢æ‹…å¿ƒæœ‰å¿˜ã€‚</p>
<p>æœ¬æ–¹æ³•ä¸»è¦é€»è¾‘è¿˜æ˜¯å¦‚æ–‡ç« å¼€å§‹æ‰€è¯´çš„å¤„ç†è§†é¢‘å¸§åˆ·æ–°å±•ç¤ºé€»è¾‘ã€‚è€Œæœ‰ç–‘æƒ‘çš„å…¶å®æ˜¯ç¬¬1æ­¥å’Œç¬¬5æ­¥ä¸­æ˜çŸ¥vpå·²ç»éƒ½ä¸ç¬¦åˆè¦æ±‚äº†ï¼Œè¿˜è°ƒç”¨frame_queue_nextæ–¹æ³•æ¥åªä¸¢å¼ƒlastvpï¼Œè€Œä¸è¿åŒvpä¸€èµ·ã€‚åé¢ä¹Ÿæ˜¯æƒ³å‡ºäº†ä¸€äº›åŸå› ï¼Œä¸çŸ¥æ˜¯æ­£ç¡®çš„ï¼Œæˆ–æ˜¯æˆ‘å¼ºåŠ çš„è§£é‡Šã€‚</p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/ijkplayer/">ijkplayer</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/866c32fa.html">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Ijkplayer-FrameQueue</span>
        <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
      </a>
    
    
      <a class="next" href="/6093ab9f.html">
        <span class="next-text nav-default">Ijkplayer-SDL_Vout_Opaque</span>
        <span class="prev-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2020 -
    
    2022
    <span class="footer-author">å’”å’”å’”.</span>
    <span class="power-by">
        ç”± <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> and <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a> å¼ºåŠ›é©±åŠ¨
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
